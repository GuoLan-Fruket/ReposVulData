{"index": 10161, "cve_id": "CVE-2021-4315", "cwe_id": ["CWE-94", "CWE-1336"], "cve_language": "Python", "cve_description": "A vulnerability has been found in NYUCCL psiTurk up to 3.2.0 and classified as critical. This vulnerability affects unknown code of the file psiturk/experiment.py. The manipulation of the argument mode leads to improper neutralization of special elements used in a template engine. The exploit has been disclosed to the public and may be used. Upgrading to version 3.2.1 is able to address this issue. The name of the patch is 47787e15cecd66f2aa87687bf852ae0194a4335f. It is recommended to upgrade the affected component. The identifier of this vulnerability is VDB-219676.", "cvss": "8.8", "publish_date": "January 28, 2023", "AV": "NETWORK", "AC": "NETWORK", "PR": "LOW", "UI": "NONE", "S": "UNCHANGED", "C": "HIGH", "I": "HIGH", "A": "HIGH", "commit_id": "47787e15cecd66f2aa87687bf852ae0194a4335f", "commit_message": "Fix SSTI vulnerability in ad and consent pages (#517)\n\n* Fix SSTI vulnerability in ad and consent pages\r\n\r\nFixed an issue where users could pass arbitrary Python code to be executed on the server to the mode HTTP arg\r\n\r\nMore information about this type of vulnerability: https://secure-cookie.io/attacks/ssti/", "commit_date": "2021-10-01T04:50:03Z", "project": "nyuccl/psiturk", "url": "https://api.github.com/repos/NYUCCL/psiTurk/commits/47787e15cecd66f2aa87687bf852ae0194a4335f", "html_url": "https://github.com/NYUCCL/psiTurk/commit/47787e15cecd66f2aa87687bf852ae0194a4335f", "windows_before": [{"commit_id": "ce90e6dfeb797f4b85e47141394063dce27dcbf0", "commit_date": "Thu Sep 30 22:28:20 2021 -0600", "commit_message": "Merge branch 'jacob-lee-patch-2'", "files_name": ["4709f6d519712362da84704728c0128f77fc0612 - Thu Sep 30 22:27:58 2021 -0600 : update changelog", "CHANGELOG.md"]}, {"commit_id": "11824f5f3b71f5e6afccc9d97db050ef01af145d", "commit_date": "Thu Sep 30 22:25:03 2021 -0600", "commit_message": "Merge branch 'patch-2' of https://github.com/jacob-lee/psiTurk into jacob-lee-patch-2", "files_name": ["997415284b019ab1cac71aaf67e65ba08394da08 - Thu Sep 30 22:20:03 2021 -0600 : pin ciso8601 to v2.1.3 (#529)", "setup.cfg", "tests/conftest.py", "tests/test_amt.py"]}, {"commit_id": "4f6d5fbbdde64c65cb6084b0fead1fb770c3b744", "commit_date": "Thu Sep 30 21:02:42 2021 -0600", "commit_message": "replace build status to point to github actions", "files_name": ["README.md"]}, {"commit_id": "428a319abf04a7b6f89bcf491535c41c62d357c7", "commit_date": "Tue Sep 28 17:24:34 2021 -0400", "commit_message": "Fix two backwards compatibility bugs", "files_name": ["psiturk/psiturk_config.py"]}, {"commit_id": "363aa5d2a9aa1cfb7fb0f84a48bb934c7de6e2b6", "commit_date": "Wed Jun 16 12:06:30 2021 -0600", "commit_message": "Update CHANGELOG.md", "files_name": ["CHANGELOG.md"]}, {"commit_id": "952718ae6547f4307c167cf66928632f7ea0a1ae", "commit_date": "Wed Jun 16 11:05:28 2021 -0700", "commit_message": "Fix SSTI vulnerability in ad and consent pages (#517)", "files_name": ["psiturk/experiment.py", "tests/test_psiturk.py"]}, {"commit_id": "e8c0828922693ed17a841f54fc6b62f70863a69f", "commit_date": "Mon Jun 7 16:57:01 2021 -0600", "commit_message": "Fix errorlog lookup (#516)", "files_name": ["psiturk/default_configs/local_config_defaults.txt", "psiturk/experiment_server.py"]}, {"commit_id": "d081cadef3d2fe22b4bf7d64a11faf89272295eb", "commit_date": "Mon Jun 7 14:48:12 2021 -0400", "commit_message": "errorlog is preferred but it is a bug to by default set it to empty string", "files_name": ["psiturk/default_configs/local_config_defaults.txt"]}, {"commit_id": "d56d26c1822599dafc3c79433ac704f0cbc06d80", "commit_date": "Thu May 20 01:18:14 2021 -0400", "commit_message": "adding ability to set custom table names to prevent database table collisions for shared db setups (#495)", "files_name": ["CHANGELOG.md", "doc/databases_overview.rst", "doc/settings.rst", "psiturk/default_configs/local_config_defaults.txt", "psiturk/example/config.txt.sample", "psiturk/experiment.py", "psiturk/models.py"]}, {"commit_id": "956ef9fa57cbd8ab3f18347180a64418dc3fe102", "commit_date": "Wed May 19 22:45:06 2021 -0600", "commit_message": "Merge branch 'flxsosa-patch-1'", "files_name": ["524b448a70c91a5fad36da59dd2945871c9f329b - Wed May 19 13:02:45 2021 -0400 : Update dashboard.rst", "doc/dashboard.rst", "doc/settings.rst"]}, {"commit_id": "e6ba7036857e8417f730b911e431b2e23641325a", "commit_date": "Wed May 19 22:28:48 2021 -0600", "commit_message": "Feature: live and sandbox quals (#505); simplify backwards compat logic", "files_name": ["CHANGELOG.md", "doc/settings.rst", "psiturk/amt_services_wrapper.py", "psiturk/default_configs/local_config_defaults.txt", "psiturk/example/config.txt.sample", "psiturk/experiment.py", "psiturk/psiturk_config.py"]}, {"commit_id": "d62c7506d37f524237dfc5c2ac4396dda2f56517", "commit_date": "Mon May 17 14:53:11 2021 -0600", "commit_message": "aws creds: uppercase env, lowercase config file", "files_name": ["doc/amt_setup.rst", "doc/tutorials/heroku.rst"]}, {"commit_id": "231d566ea3a76534a507dd68840524952c10d5d9", "commit_date": "Fri May 14 15:53:55 2021 -0600", "commit_message": "bump to 3.2.0", "files_name": ["CHANGELOG.md", "psiturk/version.py"]}, {"commit_id": "82124c7da7634a2f04432013c663fe360822f7dc", "commit_date": "Fri May 14 15:53:48 2021 -0600", "commit_message": "add missing links", "files_name": ["README.md"]}, {"commit_id": "7ab9c5d2b4fef6eed85e19c4bc463bb3a38438e7", "commit_date": "Thu May 13 19:11:27 2021 -0400", "commit_message": "Deferred datastring column for insane Participant query speedup (#504)", "files_name": ["CHANGELOG.md", "psiturk/models.py"]}, {"commit_id": "ba09ab16e57bc7fe8bb61b876c15ec97b335f83d", "commit_date": "Tue May 11 22:17:51 2021 -0600", "commit_message": "fix missing call to `super()` in thanks-mturksubmit example template (#503)", "files_name": ["CHANGELOG.md", "psiturk/example/templates/thanks-mturksubmit.html"]}, {"commit_id": "4ae271b15f8cc163323affcac9fb74cda4f53db4", "commit_date": "Wed May 12 00:00:56 2021 -0400", "commit_message": "Remove getting local HIT id's from Participants table (#498)", "files_name": ["CHANGELOG.md", "psiturk/amt_services_wrapper.py", "psiturk/db.py", "psiturk/psiturk_shell.py", "tests/test_db.py", "tests/test_psiturk_shell.py"]}, {"commit_id": "e96ae64c9dc2d4ad9185971dcde1d9e1f62c8901", "commit_date": "Tue May 11 20:54:15 2021 -0600", "commit_message": "update docs to list that `allow_repeats` has moved", "files_name": ["CHANGELOG.md", "doc/migrating.rst"]}, {"commit_id": "0a39e5344f59131935f4a3807021a35d57185027", "commit_date": "Tue May 11 20:50:16 2021 -0600", "commit_message": "warn if not do_scheduler; fix if do_scheduler false; more verbose api error handler; fix update campaign goal (#502)", "files_name": ["CHANGELOG.md", "psiturk/api/__init__.py", "psiturk/dashboard/__init__.py", "psiturk/experiment.py", "psiturk/models.py"]}, {"commit_id": "1188980b6b4f86eb0f444f1a59241b3811afda71", "commit_date": "Tue May 11 19:45:50 2021 -0600", "commit_message": "Pin github action version for deploy, and skip existing (#501)", "files_name": [".github/workflows/python-publish.yml"]}, {"commit_id": "69e441b4aa4f49e3dadc9f1335d9669c74cb107b", "commit_date": "Tue May 11 21:41:02 2021 -0400", "commit_message": "Fix typo in psiturk variable name", "files_name": ["doc/api.rst"]}, {"commit_id": "06b513cffbb9bcdd449c5aacebb54fa29ed0de0c", "commit_date": "Tue May 11 18:06:21 2021 -0600", "commit_message": "patch aws credentials check bug introduced in b8025ea (#499)", "files_name": ["psiturk/amt_services.py"]}, {"commit_id": "c81708935e21bd9f1c8bc5a8932f81117f27e7e0", "commit_date": "Tue May 11 17:57:41 2021 -0600", "commit_message": "try python app github workflow (#500)", "files_name": [".github/workflows/python-app.yml", ".github/workflows/python-publish.yml", ".travis.yml", "CHANGELOG.md", "MANIFEST.in", "psiturk/__init__.py", "pyproject.toml", "requirements.txt", "setup.cfg", "setup.py"]}, {"commit_id": "b8025ea29c0e853f2f20abfb8ade75a48909e57e", "commit_date": "Mon May 3 16:41:13 2021 -0600", "commit_message": "Fix friendly dashboard denial (#497)", "files_name": ["CHANGELOG.md", "psiturk/dashboard/__init__.py", "psiturk/user_utils.py", "tests/conftest.py"]}, {"commit_id": "1466abd20fdbf9d2b73e95c29d3507b9f781d042", "commit_date": "Mon May 3 15:03:26 2021 -0600", "commit_message": "prefer aws creds set via env (#496)", "files_name": ["psiturk/amt_services.py", "psiturk/psiturk_config.py"]}, {"commit_id": "93f488f36e835fbc8af4ea67712e8b6a26ba1b28", "commit_date": "Mon May 3 13:30:14 2021 -0600", "commit_message": "Merge branch 'master' of github.com:NYUCCL/psiTurk", "files_name": ["99001a1710c593b15b75ec0ef9b5d2c6728778b5 - Mon May 3 13:29:34 2021 -0600 : fix: set default for advanced_quals_path", "psiturk/default_configs/local_config_defaults.txt"]}, {"commit_id": "d31eb7438fe04c1b84e33f0056cf70f701d187e0", "commit_date": "Wed Apr 14 14:40:39 2021 -0400", "commit_message": "Add custom MTurk qualification support (#493)", "files_name": ["CHANGELOG.md", "doc/settings.rst", "psiturk/amt_services.py", "psiturk/amt_services_wrapper.py", "psiturk/example/advanced_quals.json.sample", "psiturk/example/config.txt.sample", "scripts/create_sample_config_from_defaults.py"]}, {"commit_id": "1defaf579861bc8f288d96e5991b16d03a395501", "commit_date": "Thu Apr 8 23:56:34 2021 -0600", "commit_message": "Update migration guide with some config changes that were forgotten", "files_name": ["CHANGELOG.md", "README.md", "doc/migrating.rst"]}, {"commit_id": "7faf9c2d4fec170b4ee0d69bf8a426448c53901f", "commit_date": "Thu Apr 8 23:52:44 2021 -0600", "commit_message": "Fix psiturk authorization (#492)", "files_name": ["CHANGELOG.md", "psiturk/example/custom.py.sample", "psiturk/user_utils.py", "tests/conftest.py"]}, {"commit_id": "31d1082627baefb513cec6587920e444ea569aca", "commit_date": "Thu Apr 8 17:00:01 2021 -0600", "commit_message": "link to v2 from docs", "files_name": ["doc/index.rst"]}, {"commit_id": "4162a022309f2e2300d3f790548d5e560c28b212", "commit_date": "Thu Apr 8 16:54:38 2021 -0600", "commit_message": "Merge pull request #491 from NYUCCL/release-3.1.0", "files_name": ["d7f0c487a70418e446af9fab3fef08a0bbc12c28 - Thu Apr 8 16:53:36 2021 -0600 : bump v3.1.0", ".gitignore", "CHANGELOG.md", "psiturk/version.py"]}, {"commit_id": "ed7ccfc728a85ac5e8010f63fbb2640ebfed647b", "commit_date": "Thu Apr 8 14:54:25 2021 -0600", "commit_message": "update status message", "files_name": ["status_msg.txt"]}, {"commit_id": "71045e08487680561e1b485ce25381a3d8720be2", "commit_date": "Mon Mar 29 21:59:34 2021 -0400", "commit_message": "Merge pull request #486 from NYUCCL/add-code-of-conduct-1", "files_name": ["1c8363b4fc352c9dbc2cfd716c3b82658cf8097e - Mon Mar 29 16:11:57 2021 -0600 : Merge branch 'BlaiseRitchie-patch-1'", "3adf5714c29ea4c9f8733d41582a53f22c07c443 - Mon Mar 29 16:11:25 2021 -0600 : update changelog", "CHANGELOG.md"]}, {"commit_id": "1df3fbca47a4d6392ddc65ae0751623b714f1023", "commit_date": "Mon Mar 29 14:49:32 2021 -0700", "commit_message": "Fix scoping bug in download_datafiles", "files_name": ["psiturk/models.py"]}, {"commit_id": "43847d28cd9f890815379f6e92e73f258a130038", "commit_date": "Sun Mar 28 21:02:36 2021 -0400", "commit_message": "created a code of conduct from github", "files_name": ["CODE_OF_CONDUCT.md"]}, {"commit_id": "1f47de753ad403b6571e2602b8d33abcb21c047f", "commit_date": "Sat Mar 27 20:10:39 2021 -0600", "commit_message": "update changelog", "files_name": ["CHANGELOG.md"]}, {"commit_id": "9cc03451a347e80c0982eecac2f95dfd5012744b", "commit_date": "Sat Mar 27 22:09:44 2021 -0400", "commit_message": "Adds StreamHandler to support Heroku-like logging (#483)", "files_name": ["psiturk/experiment.py"]}, {"commit_id": "9eb49c4723879e4af1815685705771106ac83b5b", "commit_date": "Thu Mar 25 22:51:22 2021 -0400", "commit_message": "Merge pull request #484 from NYUCCL/run_from_subfolder_heroku", "files_name": ["d781d4f0420004aa19462e59a653bddfcb12fa26 - Thu Mar 25 22:40:15 2021 -0400 : adds and option on startup to move to a different subfolder", "psiturk/experiment_server.py"]}, {"commit_id": "d81d3532c4cf09970a70c901671d27ad3941df09", "commit_date": "Mon Mar 22 23:37:07 2021 -0600", "commit_message": "Merge pull request #480 from NYUCCL/fix-bad-config-section-name-reference", "files_name": ["00798610c4da77b32d04c78824f2d49af8e3a16e - Mon Mar 22 23:31:20 2021 -0600 : fixed another bad config section name reference", "CHANGELOG.md", "psiturk/amt_services_wrapper.py"]}, {"commit_id": "e72813340b0ba52c4fe2731cbe2aab56268fc4a7", "commit_date": "Mon Mar 22 23:25:49 2021 -0600", "commit_message": "Merge branch 'master' of github.com:NYUCCL/psiTurk", "files_name": ["db83b6a9293bbc6575d2977dd688f5222f8be61b - Mon Mar 22 23:25:01 2021 -0600 : verison bump to 3.0.6", "CHANGELOG.md", "psiturk/version.py"]}, {"commit_id": "f62b8f717b37be80ca3d20ea1ae8aa3c8022021c", "commit_date": "Mon Mar 22 23:21:27 2021 -0600", "commit_message": "Merge pull request #479 from NYUCCL/fix-invalid-usage-bc", "files_name": ["1ed4e69346ddceb5570d8a0913899765be8b0d6d - Mon Mar 22 23:18:46 2021 -0600 : add backwards compatibility for InvalidUsage exception", "CHANGELOG.md", "psiturk/experiment_errors.py"]}, {"commit_id": "b97084798156226e5c9fc7404584bae7f57d949f", "commit_date": "Mon Mar 22 23:06:29 2021 -0600", "commit_message": "Merge pull request #478 from NYUCCL/doc-describe-async-preload-pages", "files_name": ["2bd839190f1d8c517455cce58a2a6c079bded7f3 - Mon Mar 22 23:05:18 2021 -0600 : docs: describe the new preloadPages approach"]}], "windows_after": [{"commit_id": "2a2de2be90e701b99a30822ad2e47c2ef9a6be01", "commit_date": "Thu Sep 30 22:51:48 2021 -0600", "commit_message": "bump to 3.2.1", "files_name": ["psiturk/version.py"]}, {"commit_id": "35a9185ed55be696e149dc025ade866a92dc59cc", "commit_date": "Thu Sep 30 22:57:57 2021 -0600", "commit_message": "update changelog with v3.2.1 release (it was from a tagged branch)", "files_name": ["CHANGELOG.md"]}, {"commit_id": "e5b2fafee72994de79e88afea789175d7a894551", "commit_date": "Mon Oct 4 23:16:51 2021 -0600", "commit_message": "first pass at extracting frontend changes (#531)", "files_name": ["psiturk/dashboard/__init__.py", "psiturk/dashboard/static/js/assignments.js", "psiturk/dashboard/static/js/campaigns.js", "psiturk/dashboard/static/js/flash_messages.js", "psiturk/dashboard/static/js/hits.js", "psiturk/dashboard/static/js/index.js", "psiturk/dashboard/static/js/layout.js", "psiturk/dashboard/static/styles/base.css", "psiturk/dashboard/static/styles/layout.css", "psiturk/dashboard/templates/dashboard/assignments.html", "psiturk/dashboard/templates/dashboard/base.html", "psiturk/dashboard/templates/dashboard/campaigns.html", "psiturk/dashboard/templates/dashboard/hits.html", "psiturk/dashboard/templates/dashboard/index.html", "psiturk/dashboard/templates/dashboard/layouts/hits.html", "psiturk/dashboard/templates/dashboard/layouts/layout.html", "psiturk/dashboard/templates/dashboard/tasks.html"]}, {"commit_id": "2c0b90144fea48e660928888e03a3f97c41fd4d0", "commit_date": "Mon Oct 4 23:42:22 2021 -0600", "commit_message": "Fix dashboard missing tasks.js and add top margin (#532)", "files_name": ["psiturk/dashboard/static/js/tasks.js", "psiturk/dashboard/templates/dashboard/layouts/layout.html"]}, {"commit_id": "bad1e5c70ab2a0b7f04a1a86f166ed2f998b607d", "commit_date": "Tue Oct 5 14:19:09 2021 -0600", "commit_message": "loading icons and active_page highlighting (#533)", "files_name": ["psiturk/dashboard/static/js/campaigns.js", "psiturk/dashboard/static/js/hits.js", "psiturk/dashboard/static/js/index.js", "psiturk/dashboard/static/js/tasks.js", "psiturk/dashboard/templates/dashboard/assignments.html", "psiturk/dashboard/templates/dashboard/campaigns.html", "psiturk/dashboard/templates/dashboard/hits.html", "psiturk/dashboard/templates/dashboard/index.html", "psiturk/dashboard/templates/dashboard/layouts/layout.html", "psiturk/dashboard/templates/dashboard/tasks.html"]}, {"commit_id": "7b2865f419710f2e175e63e963af7893fc925009", "commit_date": "Mon Feb 28 12:14:23 2022 -0700", "commit_message": "pin markupsafe", "files_name": ["setup.cfg"]}, {"commit_id": "2e88e4bcf087e639d403f498b5bbccae23b0c13d", "commit_date": "Thu Sep 30 22:16:32 2021 -0600", "commit_message": "pin ciso8601 to v2.1.3", "files_name": ["setup.cfg", "tests/conftest.py", "tests/test_amt.py"]}, {"commit_id": "4a6f9fa3d3fb513dc32eea7e3b5369ab2cf2d426", "commit_date": "Mon Feb 28 12:38:10 2022 -0700", "commit_message": "Merge branch '3.2.2'", "files_name": ["956ac51f96fff9e2beaf9a296c8b188688e8ece1 - Mon Feb 28 12:41:41 2022 -0700 : bump version", "CHANGELOG.md", "psiturk/version.py"]}, {"commit_id": "4d3ef775f4bb7fcc4e43de190e7194644bc4dc68", "commit_date": "Mon Feb 28 12:44:40 2022 -0700", "commit_message": "Merge branch '3.2.2'", "files_name": ["1d7efb96a657e385f7bec3eef0f84775c3abec46 - Mon Feb 28 12:45:41 2022 -0700 : update gitignore", ".gitignore"]}, {"commit_id": "822d0882ced0c5ccf698b108bdd1bdebef228048", "commit_date": "Mon Feb 28 13:22:17 2022 -0700", "commit_message": "Branch v3.3.0 (#544)", "files_name": ["CHANGELOG.md", "psiturk/version.py"]}, {"commit_id": "81fe1890282fdd6f46af9a2e0f00fbd119527645", "commit_date": "Mon Oct 31 16:27:09 2022 -0600", "commit_message": "bump pyopenssl to 22.0.0 (#551)", "files_name": ["setup.cfg"]}, {"commit_id": "af007240c6f4ee682e63dce0f40ca272913e2a18", "commit_date": "Mon Oct 31 16:34:16 2022 -0600", "commit_message": "bump to 3.3.1 (#552)", "files_name": ["CHANGELOG.md", "psiturk/version.py"]}], "parents": [{"commit_id_before": "231d566ea3a76534a507dd68840524952c10d5d9", "url_before": "https://api.github.com/repos/NYUCCL/psiTurk/commits/231d566ea3a76534a507dd68840524952c10d5d9", "html_url_before": "https://github.com/NYUCCL/psiTurk/commit/231d566ea3a76534a507dd68840524952c10d5d9"}], "details": [{"raw_url": "https://github.com/NYUCCL/psiTurk/raw/47787e15cecd66f2aa87687bf852ae0194a4335f/psiturk%2Fexperiment.py", "code": "# -*- coding: utf-8 -*-\n\"\"\" This module provides the backend Flask server used by psiTurk. \"\"\"\nfrom __future__ import generator_stop\nimport os\nimport sys\nimport datetime\nimport logging\nfrom random import choice\nimport user_agents\nimport requests\nimport re\nimport json\nfrom jinja2 import TemplateNotFound\nfrom collections import Counter\n\n\n# Setup flask\nfrom flask import Flask, render_template, render_template_string, request, \\\n    jsonify, send_from_directory\n\n# Setup database\n\nfrom .db import db_session, init_db\nfrom .models import Participant\nfrom sqlalchemy import or_, exc\n\nfrom .psiturk_statuses import *\nfrom .psiturk_config import PsiturkConfig\nfrom .experiment_errors import ExperimentError, ExperimentApiError\nfrom .user_utils import nocache\n\n# Setup config\nCONFIG = PsiturkConfig()\nCONFIG.load_config()\n\nLOG_LEVELS = [logging.DEBUG, logging.INFO, logging.WARNING, logging.ERROR,\nlogging.CRITICAL]\nLOG_LEVEL = LOG_LEVELS[CONFIG.getint('Server Parameters', 'loglevel')]\n\nlogfile = CONFIG.get(\"Server Parameters\", \"errorlog\")\nif logfile != '-':\n    file_path = os.path.join(os.getcwd(), logfile)\n    logging.basicConfig(filename=file_path, format='%(asctime)s %(message)s',\n                        level=LOG_LEVEL)\n\n# Let's start\n# ===========\n\napp = Flask(\"Experiment_Server\")\napp.logger.setLevel(LOG_LEVEL)\n\n# Set cache timeout to 10 seconds for static files\napp.config.update(SEND_FILE_MAX_AGE_DEFAULT=10)\napp.secret_key = CONFIG.get('Server Parameters', 'secret_key')\n\n\ndef check_templates_exist():\n    # this checks for templates that are required if you are hosting your own ad.\n    try:\n        try_these = ['thanks-mturksubmit.html', 'closepopup.html']\n        [app.jinja_env.get_template(try_this) for try_this in try_these]\n    except TemplateNotFound as e:\n        raise RuntimeError((\n            f\"Missing one of the following templates: {', '.join(try_these)}.\"\n            f\"Copy these over from a freshly-created psiturk example experiment.\"\n            f\"{type(e).__name__, str(e)}\"\n        ))\n\n\ncheck_templates_exist()\n\n\n# Serving warm, fresh, & sweet custom, user-provided routes\n# ==========================================================\n\ntry:\n    sys.path.append(os.getcwd())\n    from custom import custom_code\nexcept ModuleNotFoundError as e:\n    app.logger.info(\"Hmm... it seems no custom code (custom.py) associated \\\n                    with this project.\")\nexcept ImportError as e:\n    app.logger.error(\"There is custom code (custom.py) associated with this \\\n                      project but it doesn't import cleanly.  Raising exception,\")\n    raise\nelse:\n    app.register_blueprint(custom_code)\n    try:\n        # noinspection PyUnresolvedReferences\n        from custom import init_app as custom_init_app\n    except ImportError as e:\n        pass\n    else:\n        custom_init_app(app)\n\n# scheduler\n\nfrom apscheduler.jobstores.sqlalchemy import SQLAlchemyJobStore\nfrom pytz import utc\n\nfrom .db import engine\njobstores = {\n    'default': SQLAlchemyJobStore(engine=engine)\n}\nif 'gunicorn' in os.environ.get('SERVER_SOFTWARE', ''):\n    from apscheduler.schedulers.gevent import GeventScheduler as Scheduler\nelse:\n    from apscheduler.schedulers.background import BackgroundScheduler as Scheduler\nlogging.getLogger('apscheduler').setLevel(logging.DEBUG)\nscheduler = Scheduler(jobstores=jobstores, timezone=utc)\napp.apscheduler = scheduler\nscheduler.app = app\n\nif CONFIG.getboolean('Server Parameters', 'do_scheduler'):\n    app.logger.info(\"Scheduler starting!\")\n    scheduler.start()\nelse:\n    app.logger.info(\"Starting scheduler in 'paused' mode -- it will not run any tasks, but it can be used to create, modify, or delete tasks.\")\n    scheduler.start(paused=True)\n\n\n#\n# Dashboard\n#\nif CONFIG.getboolean('Server Parameters', 'enable_dashboard'):\n    from .dashboard import dashboard, init_app as dashboard_init_app # management dashboard\n    app.register_blueprint(dashboard)\n    dashboard_init_app(app)\n\n    from .api import api_blueprint\n    app.register_blueprint(api_blueprint)\n\ninit_db()\n\n# Read psiturk.js file into memory\nPSITURK_JS_FILE = os.path.join(os.path.dirname(__file__),\n                               \"psiturk_js/psiturk.js\")\napp.logger.info(PSITURK_JS_FILE)\n\nif os.path.exists(PSITURK_JS_FILE):\n    PSITURK_JS_CODE = open(PSITURK_JS_FILE).read()\nelse:\n    PSITURK_JS_CODE = \"alert('psiturk.js file not found!');\"\n\n\n@app.errorhandler(ExperimentError)\ndef handle_exp_error(exception):\n    \"\"\"Handle errors by sending an error page.\"\"\"\n    app.logger.error(\n        \"%s (%s) %s\", exception.value, exception.errornum, str(dict(request.args)))\n    return exception.error_page(request, CONFIG.get('Task Parameters',\n                                                    'contact_email_on_error'))\n\n\n@app.errorhandler(ExperimentApiError)\ndef handle_experiment_api_error(error):\n    # for use with API errors\n    response = jsonify(error.to_dict())\n    response.status_code = error.status_code\n    app.logger.error(error.message)\n    return response\n\n\n@app.teardown_request\ndef shutdown_session(_=None):\n    \"\"\" Shut down session route \"\"\"\n    db_session.remove()\n\n\n# Experiment counterbalancing code\n# ================================\n\ndef get_random_condcount(mode):\n    \"\"\"\n    HITs can be in one of three states:\n        - jobs that are finished\n        - jobs that are started but not finished\n        - jobs that are never going to finish (user decided not to do it)\n    Our count should be based on the first two, so we count any tasks finished\n    or any tasks not finished that were started in the last cutoff_time\n    minutes, as specified in the cutoff_time variable in the config file.\n\n    Returns a tuple: (cond, condition)\n    \"\"\"\n    cutofftime = datetime.timedelta(minutes=-CONFIG.getint('Task Parameters',\n                                                           'cutoff_time'))\n    starttime = datetime.datetime.now(datetime.timezone.utc) + cutofftime\n\n    try:\n        conditions = json.load(\n            open(os.path.join(app.root_path, 'conditions.json')))\n        numconds = len(list(conditions.keys()))\n        numcounts = 1\n    except IOError:\n        numconds = CONFIG.getint('Task Parameters', 'num_conds')\n        numcounts = CONFIG.getint('Task Parameters', 'num_counters')\n\n    participants = Participant.query.\\\n        filter(Participant.codeversion ==\n               CONFIG.get('Task Parameters', 'experiment_code_version')).\\\n        filter(Participant.mode == mode).\\\n        filter(or_(Participant.status == COMPLETED,\n                   Participant.status == CREDITED,\n                   Participant.status == SUBMITTED,\n                   Participant.status == BONUSED,\n                   Participant.beginhit > starttime)).all()\n    counts = Counter()\n    for cond in range(numconds):\n        for counter in range(numcounts):\n            counts[(cond, counter)] = 0\n    for participant in participants:\n        condcount = (participant.cond, participant.counterbalance)\n        if condcount in counts:\n            counts[condcount] += 1\n    mincount = min(counts.values())\n    minima = [hsh for hsh, count in counts.items() if count == mincount]\n    chosen = choice(minima)\n    app.logger.info(\"given %(a)s chose %(b)s\" % {'a': counts, 'b': chosen})\n\n    return chosen\n\n\ntry:\n    from custom import custom_get_condition as get_condition\nexcept (ModuleNotFoundError, ImportError):\n    get_condition = get_random_condcount\n\n# Routes\n# ======\n\n\n@app.route('/')\n@nocache\ndef index():\n    \"\"\" Index route \"\"\"\n    return render_template('default.html')\n\n\n@app.route('/favicon.ico')\ndef favicon():\n    \"\"\" Serve favicon \"\"\"\n    return app.send_static_file('favicon.ico')\n\n\n@app.route('/static/js/psiturk.js')\ndef psiturk_js():\n    \"\"\" psiTurk js route \"\"\"\n    return render_template_string(PSITURK_JS_CODE)\n\n\n@app.route('/check_worker_status', methods=['GET'])\ndef check_worker_status():\n    \"\"\" Check worker status route \"\"\"\n    if 'workerId' not in request.args:\n        resp = {\"status\": \"bad request\"}\n        return jsonify(**resp)\n    else:\n        worker_id = request.args['workerId']\n        assignment_id = request.args['assignmentId']\n        allow_repeats = CONFIG.getboolean('Task Parameters', 'allow_repeats')\n        if allow_repeats:  # if you allow repeats focus on current worker/assignment combo\n            try:\n                part = Participant.query.\\\n                    filter(Participant.workerid == worker_id).\\\n                    filter(Participant.assignmentid == assignment_id).one()\n                status = part.status\n            except exc.SQLAlchemyError:\n                status = NOT_ACCEPTED\n        else:  # if you disallow repeats search for highest status of anything by this worker\n            try:\n                matches = Participant.query.\\\n                    filter(Participant.workerid == worker_id).all()\n                numrecs = len(matches)\n                if numrecs == 0:  # this should be caught by exception, but just to be safe\n                    status = NOT_ACCEPTED\n                else:\n                    status = max([record.status for record in matches])\n            except exc.SQLAlchemyError:\n                status = NOT_ACCEPTED\n        resp = {\"status\": status}\n        return jsonify(**resp)\n\n\n@app.route('/ad', methods=['GET'])\n@app.route('/pub', methods=['GET'])\n@nocache\ndef advertisement():\n    \"\"\"\n    This is the url we give for the ad for our 'external question'.  The ad has\n    to display two different things: This page will be called from within\n    mechanical turk, with url arguments hitId, assignmentId, and workerId.\n    If the worker has not yet accepted the hit:\n        These arguments will have null values, we should just show an ad for\n        the experiment.\n    If the worker has accepted the hit:\n        These arguments will have appropriate values and we should enter the\n        person in the database and provide a link to the experiment popup.\n    \"\"\"\n    user_agent_string = request.user_agent.string\n    user_agent_obj = user_agents.parse(user_agent_string)\n    browser_ok = True\n    browser_exclude_rule = CONFIG.get('Task Parameters', 'browser_exclude_rule')\n    for rule in browser_exclude_rule.split(','):\n        myrule = rule.strip()\n        if myrule in [\"mobile\", \"tablet\", \"touchcapable\", \"pc\", \"bot\"]:\n            if (myrule == \"mobile\" and user_agent_obj.is_mobile) or\\\n               (myrule == \"tablet\" and user_agent_obj.is_tablet) or\\\n               (myrule == \"touchcapable\" and user_agent_obj.is_touch_capable) or\\\n               (myrule == \"pc\" and user_agent_obj.is_pc) or\\\n               (myrule == \"bot\" and user_agent_obj.is_bot):\n                browser_ok = False\n        elif myrule == \"Safari\" or myrule == \"safari\":\n            if \"Chrome\" in user_agent_string and \"Safari\" in user_agent_string:\n                pass\n            elif \"Safari\" in user_agent_string:\n                browser_ok = False\n        elif myrule in user_agent_string:\n            browser_ok = False\n\n    if not browser_ok:\n        # Handler for IE users if IE is not supported.\n        raise ExperimentError('browser_type_not_allowed')\n\n    if not ('hitId' in request.args and 'assignmentId' in request.args):\n        raise ExperimentError('hit_assign_worker_id_not_set_in_mturk')\n    hit_id = request.args['hitId']\n    assignment_id = request.args['assignmentId']\n    mode = request.args['mode']\n    if hit_id[:5] == \"debug\":\n        debug_mode = True\n    else:\n        debug_mode = False\n    already_in_db = False\n    if 'workerId' in request.args:\n        worker_id = request.args['workerId']\n        # First check if this workerId has completed the task before (v1).\n        nrecords = Participant.query.\\\n            filter(Participant.assignmentid != assignment_id).\\\n            filter(Participant.workerid == worker_id).\\\n            count()\n\n        if nrecords > 0:  # Already completed task\n            already_in_db = True\n    else:  # If worker has not accepted the hit\n        worker_id = None\n    try:\n        part = Participant.query.\\\n            filter(Participant.hitid == hit_id).\\\n            filter(Participant.assignmentid == assignment_id).\\\n            filter(Participant.workerid == worker_id).\\\n            one()\n        status = part.status\n    except exc.SQLAlchemyError:\n        status = None\n\n    allow_repeats = CONFIG.getboolean('Task Parameters', 'allow_repeats')\n    if (status == STARTED or status == QUITEARLY) and not debug_mode:\n        # Once participants have finished the instructions, we do not allow\n        # them to start the task again.\n        raise ExperimentError('already_started_exp_mturk')\n    elif status == COMPLETED or (status == SUBMITTED and not already_in_db):\n        # 'or status == SUBMITTED' because we suspect that sometimes the post\n        # to mturk fails after we've set status to SUBMITTED, so really they\n        # have not successfully submitted. This gives another chance for the\n        # submit to work.\n\n        # They've finished the experiment but haven't successfully submitted the HIT\n        # yet.\n        return render_template(\n            'thanks-mturksubmit.html',\n            using_sandbox=(mode == \"sandbox\"),\n            hitid=hit_id,\n            assignmentid=assignment_id,\n            workerid=worker_id\n        )\n    elif already_in_db and not (debug_mode or allow_repeats):\n        raise ExperimentError('already_did_exp_hit')\n    elif status == ALLOCATED or not status or debug_mode:\n        # Participant has not yet agreed to the consent. They might not\n        # even have accepted the HIT.\n        with open('templates/ad.html', 'r') as temp_file:\n            ad_string = temp_file.read()\n        ad_string = insert_mode(ad_string)\n        return render_template_string(\n            ad_string,\n            mode=mode,\n            hitid=hit_id,\n            assignmentid=assignment_id,\n            workerid=worker_id\n        )\n    else:\n        raise ExperimentError('status_incorrectly_set')\n\n\n@app.route('/consent', methods=['GET'])\n@nocache\ndef give_consent():\n    \"\"\"\n    Serves up the consent in the popup window.\n    \"\"\"\n    if not ('hitId' in request.args and 'assignmentId' in request.args and\n            'workerId' in request.args):\n        raise ExperimentError('hit_assign_worker_id_not_set_in_consent')\n    hit_id = request.args['hitId']\n    assignment_id = request.args['assignmentId']\n    worker_id = request.args['workerId']\n    mode = request.args['mode']\n    with open('templates/consent.html', 'r') as temp_file:\n        consent_string = temp_file.read()\n    consent_string = insert_mode(consent_string)\n    return render_template_string(\n        consent_string,\n        mode=mode,\n        hitid=hit_id,\n        assignmentid=assignment_id,\n        workerid=worker_id\n    )\n\n\n@app.route('/exp', methods=['GET'])\n@nocache\ndef start_exp():\n    \"\"\" Serves up the experiment applet. \"\"\"\n    if not (('hitId' in request.args) and ('assignmentId' in request.args) and\n            ('workerId' in request.args) and ('mode' in request.args)):\n        raise ExperimentError('hit_assign_worker_id_not_set_in_exp')\n    hit_id = request.args['hitId']\n    assignment_id = request.args['assignmentId']\n    worker_id = request.args['workerId']\n    mode = request.args['mode']\n    app.logger.info(\"Accessing /exp: %(h)s %(a)s %(w)s \" % {\n        \"h\": hit_id,\n        \"a\": assignment_id,\n        \"w\": worker_id\n    })\n    if hit_id[:5] == \"debug\":\n        debug_mode = True\n    else:\n        debug_mode = False\n\n    # Check first to see if this hitId or assignmentId exists.  If so, check to\n    # see if inExp is set\n    allow_repeats = CONFIG.getboolean('Task Parameters', 'allow_repeats')\n    if allow_repeats:\n        matches = Participant.query.\\\n            filter(Participant.workerid == worker_id).\\\n            filter(Participant.assignmentid == assignment_id).\\\n            all()\n    else:\n        matches = Participant.query.\\\n            filter(Participant.workerid == worker_id).\\\n            all()\n\n    numrecs = len(matches)\n    if numrecs == 0:\n        # Choose condition and counterbalance\n        subj_cond, subj_counter = get_condition(mode)\n\n        worker_ip = \"UNKNOWN\" if not request.remote_addr else \\\n            request.remote_addr\n        browser = \"UNKNOWN\" if not request.user_agent.browser else \\\n            request.user_agent.browser\n        platform = \"UNKNOWN\" if not request.user_agent.platform else \\\n            request.user_agent.platform\n        language = \"UNKNOWN\" if not request.accept_languages else \\\n            request.accept_languages.best\n\n        # Set condition here and insert into database.\n        participant_attributes = dict(\n            assignmentid=assignment_id,\n            workerid=worker_id,\n            hitid=hit_id,\n            cond=subj_cond,\n            counterbalance=subj_counter,\n            ipaddress=worker_ip,\n            browser=browser,\n            platform=platform,\n            language=language,\n            mode=mode\n        )\n        part = Participant(**participant_attributes)\n        db_session.add(part)\n        db_session.commit()\n\n    else:\n        # A couple possible problems here:\n        # 1: They've already done an assignment, then we should tell them they\n        #    can't do another one\n        # 2: They've already worked on this assignment, and got too far to\n        #    start over.\n        # 3: They're in the database twice for the same assignment, that should\n        #    never happen.\n        # 4: They're returning and all is well.\n        nrecords = 0\n        for record in matches:\n            other_assignment = False\n            if record.assignmentid != assignment_id:\n                other_assignment = True\n            else:\n                nrecords += 1\n        if nrecords <= 1 and not other_assignment:\n            part = matches[0]\n            # In experiment (or later) can't restart at this point\n            if part.status >= STARTED and not debug_mode:\n                raise ExperimentError('already_started_exp')\n        else:\n            if nrecords > 1:\n                app.logger.error(\"Error, hit/assignment appears in database \\\n                                 more than once (serious problem)\")\n                raise ExperimentError(\n                    'hit_assign_appears_in_database_more_than_once'\n                )\n            if other_assignment:\n                raise ExperimentError('already_did_exp_hit')\n\n    ad_server_location = '/complete'\n\n    return render_template(\n        'exp.html', uniqueId=part.uniqueid,\n        condition=part.cond,\n        counterbalance=part.counterbalance,\n        adServerLoc=ad_server_location,\n        mode=mode,\n        contact_address=CONFIG.get(\n            'Task Parameters', 'contact_email_on_error'),\n        codeversion=CONFIG.get(\n            'Task Parameters', 'experiment_code_version')\n    )\n\n\n@app.route('/inexp', methods=['POST'])\ndef enterexp():\n    \"\"\"\n    AJAX listener that listens for a signal from the user's script when they\n    leave the instructions and enter the real experiment. After the server\n    receives this signal, it will no longer allow them to re-access the\n    experiment applet (meaning they can't do part of the experiment and\n    referesh to start over).\n    \"\"\"\n    app.logger.info(\"Accessing /inexp\")\n    if 'uniqueId' not in request.form:\n        raise ExperimentError('improper_inputs')\n    unique_id = request.form['uniqueId']\n\n    try:\n        user = Participant.query.\\\n            filter(Participant.uniqueid == unique_id).one()\n        user.status = STARTED\n        user.beginexp = datetime.datetime.now(datetime.timezone.utc)\n        db_session.add(user)\n        db_session.commit()\n        resp = {\"status\": \"success\"}\n    except exc.SQLAlchemyError:\n        app.logger.error(\"DB error: Unique user not found.\")\n        resp = {\"status\": \"error, uniqueId not found\"}\n    return jsonify(**resp)\n\n# TODD SAYS: This the only route in the whole thing that uses <id> like this\n# where everything else uses POST!  This could be confusing but is forced\n# somewhat by Backbone?  Take heed!\n@app.route('/sync/<uid>', methods=['GET'])\ndef load(uid=None):\n    \"\"\"\n    Load experiment data, which should be a JSON object and will be stored\n    after converting to string.\n    \"\"\"\n    app.logger.info(\"GET /sync route with id: %s\" % uid)\n\n    try:\n        user = Participant.query.\\\n            filter(Participant.uniqueid == uid).\\\n            one()\n    except exc.SQLAlchemyError:\n        app.logger.error(\"DB error: Unique user not found.\")\n    else:\n        try:\n            resp = json.loads(user.datastring)\n        except (ValueError, TypeError, json.JSONDecodeError):\n            resp = {\n                \"condition\": user.cond,\n                \"counterbalance\": user.counterbalance,\n                \"assignmentId\": user.assignmentid,\n                \"workerId\": user.workerid,\n                \"hitId\": user.hitid,\n                \"bonus\": user.bonus\n            }\n        return jsonify(**resp)\n\n\n@app.route('/sync/<uid>', methods=['PUT'])\ndef update(uid=None):\n    \"\"\"\n    Save experiment data, which should be a JSON object and will be stored\n    after converting to string.\n    \"\"\"\n    app.logger.info(\"PUT /sync route with id: %s\" % uid)\n\n    try:\n        user = Participant.query.\\\n            filter(Participant.uniqueid == uid).\\\n            one()\n    except exc.SQLAlchemyError:\n        raise ExperimentApiError(\"DB error: Unique user not found.\")\n\n    user.datastring = json.dumps(request.json)\n    db_session.add(user)\n    db_session.commit()\n\n    try:\n        data = json.loads(user.datastring)\n    except Exception as e:\n        raise ExperimentApiError('failed to load json datastring back from database as object! Error was {}: {}'.format(type(e), str(e)))\n\n    trial = data.get(\"currenttrial\", None)\n    app.logger.info(\"saved data for %s (current trial: %s)\", uid, trial)\n    resp = {\"status\": \"user data saved\"}\n    return jsonify(**resp)\n\n\n@app.route('/quitter', methods=['POST'])\ndef quitter():\n    \"\"\"\n    Mark quitter as such.\n    \"\"\"\n    unique_id = request.form['uniqueId']\n    if unique_id[:5] == \"debug\":\n        debug_mode = True\n    else:\n        debug_mode = False\n\n    if debug_mode:\n        resp = {\"status\": \"didn't mark as quitter since this is debugging\"}\n        return jsonify(**resp)\n    else:\n        try:\n            unique_id = request.form['uniqueId']\n            app.logger.info(\"Marking quitter %s\" % unique_id)\n            user = Participant.query.\\\n                filter(Participant.uniqueid == unique_id).\\\n                one()\n            user.status = QUITEARLY\n            db_session.add(user)\n            db_session.commit()\n        except exc.SQLAlchemyError:\n            raise ExperimentError('tried_to_quit')\n        else:\n            resp = {\"status\": \"marked as quitter\"}\n            return jsonify(**resp)\n\n# Note: This route should only used when debugging\n# or when not using the psiturk adserver\n@app.route('/complete', methods=['GET'])\n@nocache\ndef debug_complete():\n    \"\"\" Debugging route for complete. \"\"\"\n    if 'uniqueId' not in request.args:\n        raise ExperimentError('improper_inputs')\n    else:\n        unique_id = request.args['uniqueId']\n        mode = request.args['mode']\n        try:\n            user = Participant.query.\\\n                filter(Participant.uniqueid == unique_id).one()\n            user.status = COMPLETED\n            user.endhit = datetime.datetime.now(datetime.timezone.utc)\n            db_session.add(user)\n            db_session.commit()\n        except exc.SQLAlchemyError:\n            raise ExperimentError('error_setting_worker_complete')\n        else:\n            # send them back to mturk.\n            if mode == 'sandbox' or mode == 'live':\n                return render_template('closepopup.html')\n            else:\n                allow_repeats = CONFIG.getboolean('Task Parameters', 'allow_repeats')\n                return render_template('complete.html',\n                                       allow_repeats=allow_repeats,\n                                       worker_id=user.workerid)\n\n\n@app.route('/worker_complete', methods=['GET'])\ndef worker_complete():\n    \"\"\" Complete worker. \"\"\"\n    if 'uniqueId' not in request.args:\n        resp = {\"status\": \"bad request\"}\n        return jsonify(**resp)\n    else:\n        unique_id = request.args['uniqueId']\n        app.logger.info(\"Completed experiment %s\" % unique_id)\n        try:\n            user = Participant.query.\\\n                filter(Participant.uniqueid == unique_id).one()\n            user.status = COMPLETED\n            user.endhit = datetime.datetime.now(datetime.timezone.utc)\n            db_session.add(user)\n            db_session.commit()\n            status = \"success\"\n        except exc.SQLAlchemyError:\n            status = \"database error\"\n        resp = {\"status\": status}\n        return jsonify(**resp)\n\n\n@app.route('/worker_submitted', methods=['GET'])\ndef worker_submitted():\n    \"\"\" Submit worker \"\"\"\n    if 'uniqueId' not in request.args:\n        resp = {\"status\": \"bad request\"}\n        return jsonify(**resp)\n    else:\n        unique_id = request.args['uniqueId']\n        app.logger.info(\"Submitted experiment for %s\" % unique_id)\n        try:\n            user = Participant.query.\\\n                filter(Participant.uniqueid == unique_id).one()\n            user.status = SUBMITTED\n            db_session.add(user)\n            db_session.commit()\n            status = \"success\"\n        except exc.SQLAlchemyError:\n            status = \"database error\"\n        resp = {\"status\": status}\n        return jsonify(**resp)\n\n# Is this a security risk?\n@app.route(\"/ppid\")\ndef ppid():\n    \"\"\" Get ppid \"\"\"\n    proc_id = os.getppid()\n    return str(proc_id)\n\n# Insert \"mode\" into pages so it's carried from page to page done server-side\n# to avoid breaking backwards compatibility with old templates.\n\n\ndef insert_mode(page_html):\n    \"\"\" Insert mode \"\"\"\n    page_html = page_html\n    match_found = False\n    matches = re.finditer('workerId={{ workerid }}', page_html)\n    match = None\n    for match in matches:\n        match_found = True\n    if match_found:\n        new_html = page_html[:match.end()] + '&mode={{ mode }}' +\\\n            page_html[match.end():]\n        return new_html\n    else:\n        raise ExperimentError(\"insert_mode_failed\")\n\n\n# Generic route\n# =============\n\n@app.route('/<path:path>')\ndef regularpage(path):\n    \"\"\"\n    Route not found by the other routes above. May point to a static template.\n    \"\"\"\n    return send_from_directory('templates', path)\n\n\ndef run_webserver():\n    \"\"\" Run web server \"\"\"\n    host = CONFIG.get('Server Parameters', 'host')\n    port = CONFIG.getint('Server Parameters', 'port')\n    print(f\"Serving on http://{host}:{port}\")\n    app.config['TEMPLATES_AUTO_RELOAD'] = True\n    app.jinja_env.auto_reload = True\n    app.run(debug=True, host=host, port=port)\n\n\nif __name__ == '__main__':\n    run_webserver()\n", "code_before": "# -*- coding: utf-8 -*-\n\"\"\" This module provides the backend Flask server used by psiTurk. \"\"\"\nfrom __future__ import generator_stop\nimport os\nimport sys\nimport datetime\nimport logging\nfrom random import choice\nimport user_agents\nimport requests\nimport re\nimport json\nfrom jinja2 import TemplateNotFound\nfrom collections import Counter\n\n\n# Setup flask\nfrom flask import Flask, render_template, render_template_string, request, \\\n    jsonify, send_from_directory\n\n# Setup database\n\nfrom .db import db_session, init_db\nfrom .models import Participant\nfrom sqlalchemy import or_, exc\n\nfrom .psiturk_statuses import *\nfrom .psiturk_config import PsiturkConfig\nfrom .experiment_errors import ExperimentError, ExperimentApiError\nfrom .user_utils import nocache\n\n# Setup config\nCONFIG = PsiturkConfig()\nCONFIG.load_config()\n\nLOG_LEVELS = [logging.DEBUG, logging.INFO, logging.WARNING, logging.ERROR,\nlogging.CRITICAL]\nLOG_LEVEL = LOG_LEVELS[CONFIG.getint('Server Parameters', 'loglevel')]\n\nlogfile = CONFIG.get(\"Server Parameters\", \"errorlog\")\nif logfile != '-':\n    file_path = os.path.join(os.getcwd(), logfile)\n    logging.basicConfig(filename=file_path, format='%(asctime)s %(message)s',\n                        level=LOG_LEVEL)\n\n# Let's start\n# ===========\n\napp = Flask(\"Experiment_Server\")\napp.logger.setLevel(LOG_LEVEL)\n\n# Set cache timeout to 10 seconds for static files\napp.config.update(SEND_FILE_MAX_AGE_DEFAULT=10)\napp.secret_key = CONFIG.get('Server Parameters', 'secret_key')\n\n\ndef check_templates_exist():\n    # this checks for templates that are required if you are hosting your own ad.\n    try:\n        try_these = ['thanks-mturksubmit.html', 'closepopup.html']\n        [app.jinja_env.get_template(try_this) for try_this in try_these]\n    except TemplateNotFound as e:\n        raise RuntimeError((\n            f\"Missing one of the following templates: {', '.join(try_these)}.\"\n            f\"Copy these over from a freshly-created psiturk example experiment.\"\n            f\"{type(e).__name__, str(e)}\"\n        ))\n\n\ncheck_templates_exist()\n\n\n# Serving warm, fresh, & sweet custom, user-provided routes\n# ==========================================================\n\ntry:\n    sys.path.append(os.getcwd())\n    from custom import custom_code\nexcept ModuleNotFoundError as e:\n    app.logger.info(\"Hmm... it seems no custom code (custom.py) associated \\\n                    with this project.\")\nexcept ImportError as e:\n    app.logger.error(\"There is custom code (custom.py) associated with this \\\n                      project but it doesn't import cleanly.  Raising exception,\")\n    raise\nelse:\n    app.register_blueprint(custom_code)\n    try:\n        # noinspection PyUnresolvedReferences\n        from custom import init_app as custom_init_app\n    except ImportError as e:\n        pass\n    else:\n        custom_init_app(app)\n\n# scheduler\n\nfrom apscheduler.jobstores.sqlalchemy import SQLAlchemyJobStore\nfrom pytz import utc\n\nfrom .db import engine\njobstores = {\n    'default': SQLAlchemyJobStore(engine=engine)\n}\nif 'gunicorn' in os.environ.get('SERVER_SOFTWARE', ''):\n    from apscheduler.schedulers.gevent import GeventScheduler as Scheduler\nelse:\n    from apscheduler.schedulers.background import BackgroundScheduler as Scheduler\nlogging.getLogger('apscheduler').setLevel(logging.DEBUG)\nscheduler = Scheduler(jobstores=jobstores, timezone=utc)\napp.apscheduler = scheduler\nscheduler.app = app\n\nif CONFIG.getboolean('Server Parameters', 'do_scheduler'):\n    app.logger.info(\"Scheduler starting!\")\n    scheduler.start()\nelse:\n    app.logger.info(\"Starting scheduler in 'paused' mode -- it will not run any tasks, but it can be used to create, modify, or delete tasks.\")\n    scheduler.start(paused=True)\n\n\n#\n# Dashboard\n#\nif CONFIG.getboolean('Server Parameters', 'enable_dashboard'):\n    from .dashboard import dashboard, init_app as dashboard_init_app # management dashboard\n    app.register_blueprint(dashboard)\n    dashboard_init_app(app)\n\n    from .api import api_blueprint\n    app.register_blueprint(api_blueprint)\n\ninit_db()\n\n# Read psiturk.js file into memory\nPSITURK_JS_FILE = os.path.join(os.path.dirname(__file__),\n                               \"psiturk_js/psiturk.js\")\napp.logger.info(PSITURK_JS_FILE)\n\nif os.path.exists(PSITURK_JS_FILE):\n    PSITURK_JS_CODE = open(PSITURK_JS_FILE).read()\nelse:\n    PSITURK_JS_CODE = \"alert('psiturk.js file not found!');\"\n\n\n@app.errorhandler(ExperimentError)\ndef handle_exp_error(exception):\n    \"\"\"Handle errors by sending an error page.\"\"\"\n    app.logger.error(\n        \"%s (%s) %s\", exception.value, exception.errornum, str(dict(request.args)))\n    return exception.error_page(request, CONFIG.get('Task Parameters',\n                                                    'contact_email_on_error'))\n\n\n@app.errorhandler(ExperimentApiError)\ndef handle_experiment_api_error(error):\n    # for use with API errors\n    response = jsonify(error.to_dict())\n    response.status_code = error.status_code\n    app.logger.error(error.message)\n    return response\n\n\n@app.teardown_request\ndef shutdown_session(_=None):\n    \"\"\" Shut down session route \"\"\"\n    db_session.remove()\n\n\n# Experiment counterbalancing code\n# ================================\n\ndef get_random_condcount(mode):\n    \"\"\"\n    HITs can be in one of three states:\n        - jobs that are finished\n        - jobs that are started but not finished\n        - jobs that are never going to finish (user decided not to do it)\n    Our count should be based on the first two, so we count any tasks finished\n    or any tasks not finished that were started in the last cutoff_time\n    minutes, as specified in the cutoff_time variable in the config file.\n\n    Returns a tuple: (cond, condition)\n    \"\"\"\n    cutofftime = datetime.timedelta(minutes=-CONFIG.getint('Task Parameters',\n                                                           'cutoff_time'))\n    starttime = datetime.datetime.now(datetime.timezone.utc) + cutofftime\n\n    try:\n        conditions = json.load(\n            open(os.path.join(app.root_path, 'conditions.json')))\n        numconds = len(list(conditions.keys()))\n        numcounts = 1\n    except IOError:\n        numconds = CONFIG.getint('Task Parameters', 'num_conds')\n        numcounts = CONFIG.getint('Task Parameters', 'num_counters')\n\n    participants = Participant.query.\\\n        filter(Participant.codeversion ==\n               CONFIG.get('Task Parameters', 'experiment_code_version')).\\\n        filter(Participant.mode == mode).\\\n        filter(or_(Participant.status == COMPLETED,\n                   Participant.status == CREDITED,\n                   Participant.status == SUBMITTED,\n                   Participant.status == BONUSED,\n                   Participant.beginhit > starttime)).all()\n    counts = Counter()\n    for cond in range(numconds):\n        for counter in range(numcounts):\n            counts[(cond, counter)] = 0\n    for participant in participants:\n        condcount = (participant.cond, participant.counterbalance)\n        if condcount in counts:\n            counts[condcount] += 1\n    mincount = min(counts.values())\n    minima = [hsh for hsh, count in counts.items() if count == mincount]\n    chosen = choice(minima)\n    app.logger.info(\"given %(a)s chose %(b)s\" % {'a': counts, 'b': chosen})\n\n    return chosen\n\n\ntry:\n    from custom import custom_get_condition as get_condition\nexcept (ModuleNotFoundError, ImportError):\n    get_condition = get_random_condcount\n\n# Routes\n# ======\n\n\n@app.route('/')\n@nocache\ndef index():\n    \"\"\" Index route \"\"\"\n    return render_template('default.html')\n\n\n@app.route('/favicon.ico')\ndef favicon():\n    \"\"\" Serve favicon \"\"\"\n    return app.send_static_file('favicon.ico')\n\n\n@app.route('/static/js/psiturk.js')\ndef psiturk_js():\n    \"\"\" psiTurk js route \"\"\"\n    return render_template_string(PSITURK_JS_CODE)\n\n\n@app.route('/check_worker_status', methods=['GET'])\ndef check_worker_status():\n    \"\"\" Check worker status route \"\"\"\n    if 'workerId' not in request.args:\n        resp = {\"status\": \"bad request\"}\n        return jsonify(**resp)\n    else:\n        worker_id = request.args['workerId']\n        assignment_id = request.args['assignmentId']\n        allow_repeats = CONFIG.getboolean('Task Parameters', 'allow_repeats')\n        if allow_repeats:  # if you allow repeats focus on current worker/assignment combo\n            try:\n                part = Participant.query.\\\n                    filter(Participant.workerid == worker_id).\\\n                    filter(Participant.assignmentid == assignment_id).one()\n                status = part.status\n            except exc.SQLAlchemyError:\n                status = NOT_ACCEPTED\n        else:  # if you disallow repeats search for highest status of anything by this worker\n            try:\n                matches = Participant.query.\\\n                    filter(Participant.workerid == worker_id).all()\n                numrecs = len(matches)\n                if numrecs == 0:  # this should be caught by exception, but just to be safe\n                    status = NOT_ACCEPTED\n                else:\n                    status = max([record.status for record in matches])\n            except exc.SQLAlchemyError:\n                status = NOT_ACCEPTED\n        resp = {\"status\": status}\n        return jsonify(**resp)\n\n\n@app.route('/ad', methods=['GET'])\n@app.route('/pub', methods=['GET'])\n@nocache\ndef advertisement():\n    \"\"\"\n    This is the url we give for the ad for our 'external question'.  The ad has\n    to display two different things: This page will be called from within\n    mechanical turk, with url arguments hitId, assignmentId, and workerId.\n    If the worker has not yet accepted the hit:\n        These arguments will have null values, we should just show an ad for\n        the experiment.\n    If the worker has accepted the hit:\n        These arguments will have appropriate values and we should enter the\n        person in the database and provide a link to the experiment popup.\n    \"\"\"\n    user_agent_string = request.user_agent.string\n    user_agent_obj = user_agents.parse(user_agent_string)\n    browser_ok = True\n    browser_exclude_rule = CONFIG.get('Task Parameters', 'browser_exclude_rule')\n    for rule in browser_exclude_rule.split(','):\n        myrule = rule.strip()\n        if myrule in [\"mobile\", \"tablet\", \"touchcapable\", \"pc\", \"bot\"]:\n            if (myrule == \"mobile\" and user_agent_obj.is_mobile) or\\\n               (myrule == \"tablet\" and user_agent_obj.is_tablet) or\\\n               (myrule == \"touchcapable\" and user_agent_obj.is_touch_capable) or\\\n               (myrule == \"pc\" and user_agent_obj.is_pc) or\\\n               (myrule == \"bot\" and user_agent_obj.is_bot):\n                browser_ok = False\n        elif myrule == \"Safari\" or myrule == \"safari\":\n            if \"Chrome\" in user_agent_string and \"Safari\" in user_agent_string:\n                pass\n            elif \"Safari\" in user_agent_string:\n                browser_ok = False\n        elif myrule in user_agent_string:\n            browser_ok = False\n\n    if not browser_ok:\n        # Handler for IE users if IE is not supported.\n        raise ExperimentError('browser_type_not_allowed')\n\n    if not ('hitId' in request.args and 'assignmentId' in request.args):\n        raise ExperimentError('hit_assign_worker_id_not_set_in_mturk')\n    hit_id = request.args['hitId']\n    assignment_id = request.args['assignmentId']\n    mode = request.args['mode']\n    if hit_id[:5] == \"debug\":\n        debug_mode = True\n    else:\n        debug_mode = False\n    already_in_db = False\n    if 'workerId' in request.args:\n        worker_id = request.args['workerId']\n        # First check if this workerId has completed the task before (v1).\n        nrecords = Participant.query.\\\n            filter(Participant.assignmentid != assignment_id).\\\n            filter(Participant.workerid == worker_id).\\\n            count()\n\n        if nrecords > 0:  # Already completed task\n            already_in_db = True\n    else:  # If worker has not accepted the hit\n        worker_id = None\n    try:\n        part = Participant.query.\\\n            filter(Participant.hitid == hit_id).\\\n            filter(Participant.assignmentid == assignment_id).\\\n            filter(Participant.workerid == worker_id).\\\n            one()\n        status = part.status\n    except exc.SQLAlchemyError:\n        status = None\n\n    allow_repeats = CONFIG.getboolean('Task Parameters', 'allow_repeats')\n    if (status == STARTED or status == QUITEARLY) and not debug_mode:\n        # Once participants have finished the instructions, we do not allow\n        # them to start the task again.\n        raise ExperimentError('already_started_exp_mturk')\n    elif status == COMPLETED or (status == SUBMITTED and not already_in_db):\n        # 'or status == SUBMITTED' because we suspect that sometimes the post\n        # to mturk fails after we've set status to SUBMITTED, so really they\n        # have not successfully submitted. This gives another chance for the\n        # submit to work.\n\n        # They've finished the experiment but haven't successfully submitted the HIT\n        # yet.\n        return render_template(\n            'thanks-mturksubmit.html',\n            using_sandbox=(mode == \"sandbox\"),\n            hitid=hit_id,\n            assignmentid=assignment_id,\n            workerid=worker_id\n        )\n    elif already_in_db and not (debug_mode or allow_repeats):\n        raise ExperimentError('already_did_exp_hit')\n    elif status == ALLOCATED or not status or debug_mode:\n        # Participant has not yet agreed to the consent. They might not\n        # even have accepted the HIT.\n        with open('templates/ad.html', 'r') as temp_file:\n            ad_string = temp_file.read()\n        ad_string = insert_mode(ad_string, mode)\n        return render_template_string(\n            ad_string,\n            hitid=hit_id,\n            assignmentid=assignment_id,\n            workerid=worker_id\n        )\n    else:\n        raise ExperimentError('status_incorrectly_set')\n\n\n@app.route('/consent', methods=['GET'])\n@nocache\ndef give_consent():\n    \"\"\"\n    Serves up the consent in the popup window.\n    \"\"\"\n    if not ('hitId' in request.args and 'assignmentId' in request.args and\n            'workerId' in request.args):\n        raise ExperimentError('hit_assign_worker_id_not_set_in_consent')\n    hit_id = request.args['hitId']\n    assignment_id = request.args['assignmentId']\n    worker_id = request.args['workerId']\n    mode = request.args['mode']\n    with open('templates/consent.html', 'r') as temp_file:\n        consent_string = temp_file.read()\n    consent_string = insert_mode(consent_string, mode)\n    return render_template_string(\n        consent_string,\n        hitid=hit_id,\n        assignmentid=assignment_id,\n        workerid=worker_id\n    )\n\n\n@app.route('/exp', methods=['GET'])\n@nocache\ndef start_exp():\n    \"\"\" Serves up the experiment applet. \"\"\"\n    if not (('hitId' in request.args) and ('assignmentId' in request.args) and\n            ('workerId' in request.args) and ('mode' in request.args)):\n        raise ExperimentError('hit_assign_worker_id_not_set_in_exp')\n    hit_id = request.args['hitId']\n    assignment_id = request.args['assignmentId']\n    worker_id = request.args['workerId']\n    mode = request.args['mode']\n    app.logger.info(\"Accessing /exp: %(h)s %(a)s %(w)s \" % {\n        \"h\": hit_id,\n        \"a\": assignment_id,\n        \"w\": worker_id\n    })\n    if hit_id[:5] == \"debug\":\n        debug_mode = True\n    else:\n        debug_mode = False\n\n    # Check first to see if this hitId or assignmentId exists.  If so, check to\n    # see if inExp is set\n    allow_repeats = CONFIG.getboolean('Task Parameters', 'allow_repeats')\n    if allow_repeats:\n        matches = Participant.query.\\\n            filter(Participant.workerid == worker_id).\\\n            filter(Participant.assignmentid == assignment_id).\\\n            all()\n    else:\n        matches = Participant.query.\\\n            filter(Participant.workerid == worker_id).\\\n            all()\n\n    numrecs = len(matches)\n    if numrecs == 0:\n        # Choose condition and counterbalance\n        subj_cond, subj_counter = get_condition(mode)\n\n        worker_ip = \"UNKNOWN\" if not request.remote_addr else \\\n            request.remote_addr\n        browser = \"UNKNOWN\" if not request.user_agent.browser else \\\n            request.user_agent.browser\n        platform = \"UNKNOWN\" if not request.user_agent.platform else \\\n            request.user_agent.platform\n        language = \"UNKNOWN\" if not request.accept_languages else \\\n            request.accept_languages.best\n\n        # Set condition here and insert into database.\n        participant_attributes = dict(\n            assignmentid=assignment_id,\n            workerid=worker_id,\n            hitid=hit_id,\n            cond=subj_cond,\n            counterbalance=subj_counter,\n            ipaddress=worker_ip,\n            browser=browser,\n            platform=platform,\n            language=language,\n            mode=mode\n        )\n        part = Participant(**participant_attributes)\n        db_session.add(part)\n        db_session.commit()\n\n    else:\n        # A couple possible problems here:\n        # 1: They've already done an assignment, then we should tell them they\n        #    can't do another one\n        # 2: They've already worked on this assignment, and got too far to\n        #    start over.\n        # 3: They're in the database twice for the same assignment, that should\n        #    never happen.\n        # 4: They're returning and all is well.\n        nrecords = 0\n        for record in matches:\n            other_assignment = False\n            if record.assignmentid != assignment_id:\n                other_assignment = True\n            else:\n                nrecords += 1\n        if nrecords <= 1 and not other_assignment:\n            part = matches[0]\n            # In experiment (or later) can't restart at this point\n            if part.status >= STARTED and not debug_mode:\n                raise ExperimentError('already_started_exp')\n        else:\n            if nrecords > 1:\n                app.logger.error(\"Error, hit/assignment appears in database \\\n                                 more than once (serious problem)\")\n                raise ExperimentError(\n                    'hit_assign_appears_in_database_more_than_once'\n                )\n            if other_assignment:\n                raise ExperimentError('already_did_exp_hit')\n\n    ad_server_location = '/complete'\n\n    return render_template(\n        'exp.html', uniqueId=part.uniqueid,\n        condition=part.cond,\n        counterbalance=part.counterbalance,\n        adServerLoc=ad_server_location,\n        mode=mode,\n        contact_address=CONFIG.get(\n            'Task Parameters', 'contact_email_on_error'),\n        codeversion=CONFIG.get(\n            'Task Parameters', 'experiment_code_version')\n    )\n\n\n@app.route('/inexp', methods=['POST'])\ndef enterexp():\n    \"\"\"\n    AJAX listener that listens for a signal from the user's script when they\n    leave the instructions and enter the real experiment. After the server\n    receives this signal, it will no longer allow them to re-access the\n    experiment applet (meaning they can't do part of the experiment and\n    referesh to start over).\n    \"\"\"\n    app.logger.info(\"Accessing /inexp\")\n    if 'uniqueId' not in request.form:\n        raise ExperimentError('improper_inputs')\n    unique_id = request.form['uniqueId']\n\n    try:\n        user = Participant.query.\\\n            filter(Participant.uniqueid == unique_id).one()\n        user.status = STARTED\n        user.beginexp = datetime.datetime.now(datetime.timezone.utc)\n        db_session.add(user)\n        db_session.commit()\n        resp = {\"status\": \"success\"}\n    except exc.SQLAlchemyError:\n        app.logger.error(\"DB error: Unique user not found.\")\n        resp = {\"status\": \"error, uniqueId not found\"}\n    return jsonify(**resp)\n\n# TODD SAYS: This the only route in the whole thing that uses <id> like this\n# where everything else uses POST!  This could be confusing but is forced\n# somewhat by Backbone?  Take heed!\n@app.route('/sync/<uid>', methods=['GET'])\ndef load(uid=None):\n    \"\"\"\n    Load experiment data, which should be a JSON object and will be stored\n    after converting to string.\n    \"\"\"\n    app.logger.info(\"GET /sync route with id: %s\" % uid)\n\n    try:\n        user = Participant.query.\\\n            filter(Participant.uniqueid == uid).\\\n            one()\n    except exc.SQLAlchemyError:\n        app.logger.error(\"DB error: Unique user not found.\")\n    else:\n        try:\n            resp = json.loads(user.datastring)\n        except (ValueError, TypeError, json.JSONDecodeError):\n            resp = {\n                \"condition\": user.cond,\n                \"counterbalance\": user.counterbalance,\n                \"assignmentId\": user.assignmentid,\n                \"workerId\": user.workerid,\n                \"hitId\": user.hitid,\n                \"bonus\": user.bonus\n            }\n        return jsonify(**resp)\n\n\n@app.route('/sync/<uid>', methods=['PUT'])\ndef update(uid=None):\n    \"\"\"\n    Save experiment data, which should be a JSON object and will be stored\n    after converting to string.\n    \"\"\"\n    app.logger.info(\"PUT /sync route with id: %s\" % uid)\n\n    try:\n        user = Participant.query.\\\n            filter(Participant.uniqueid == uid).\\\n            one()\n    except exc.SQLAlchemyError:\n        raise ExperimentApiError(\"DB error: Unique user not found.\")\n\n    user.datastring = json.dumps(request.json)\n    db_session.add(user)\n    db_session.commit()\n\n    try:\n        data = json.loads(user.datastring)\n    except Exception as e:\n        raise ExperimentApiError('failed to load json datastring back from database as object! Error was {}: {}'.format(type(e), str(e)))\n\n    trial = data.get(\"currenttrial\", None)\n    app.logger.info(\"saved data for %s (current trial: %s)\", uid, trial)\n    resp = {\"status\": \"user data saved\"}\n    return jsonify(**resp)\n\n\n@app.route('/quitter', methods=['POST'])\ndef quitter():\n    \"\"\"\n    Mark quitter as such.\n    \"\"\"\n    unique_id = request.form['uniqueId']\n    if unique_id[:5] == \"debug\":\n        debug_mode = True\n    else:\n        debug_mode = False\n\n    if debug_mode:\n        resp = {\"status\": \"didn't mark as quitter since this is debugging\"}\n        return jsonify(**resp)\n    else:\n        try:\n            unique_id = request.form['uniqueId']\n            app.logger.info(\"Marking quitter %s\" % unique_id)\n            user = Participant.query.\\\n                filter(Participant.uniqueid == unique_id).\\\n                one()\n            user.status = QUITEARLY\n            db_session.add(user)\n            db_session.commit()\n        except exc.SQLAlchemyError:\n            raise ExperimentError('tried_to_quit')\n        else:\n            resp = {\"status\": \"marked as quitter\"}\n            return jsonify(**resp)\n\n# Note: This route should only used when debugging\n# or when not using the psiturk adserver\n@app.route('/complete', methods=['GET'])\n@nocache\ndef debug_complete():\n    \"\"\" Debugging route for complete. \"\"\"\n    if 'uniqueId' not in request.args:\n        raise ExperimentError('improper_inputs')\n    else:\n        unique_id = request.args['uniqueId']\n        mode = request.args['mode']\n        try:\n            user = Participant.query.\\\n                filter(Participant.uniqueid == unique_id).one()\n            user.status = COMPLETED\n            user.endhit = datetime.datetime.now(datetime.timezone.utc)\n            db_session.add(user)\n            db_session.commit()\n        except exc.SQLAlchemyError:\n            raise ExperimentError('error_setting_worker_complete')\n        else:\n            # send them back to mturk.\n            if mode == 'sandbox' or mode == 'live':\n                return render_template('closepopup.html')\n            else:\n                allow_repeats = CONFIG.getboolean('Task Parameters', 'allow_repeats')\n                return render_template('complete.html',\n                                       allow_repeats=allow_repeats,\n                                       worker_id=user.workerid)\n\n\n@app.route('/worker_complete', methods=['GET'])\ndef worker_complete():\n    \"\"\" Complete worker. \"\"\"\n    if 'uniqueId' not in request.args:\n        resp = {\"status\": \"bad request\"}\n        return jsonify(**resp)\n    else:\n        unique_id = request.args['uniqueId']\n        app.logger.info(\"Completed experiment %s\" % unique_id)\n        try:\n            user = Participant.query.\\\n                filter(Participant.uniqueid == unique_id).one()\n            user.status = COMPLETED\n            user.endhit = datetime.datetime.now(datetime.timezone.utc)\n            db_session.add(user)\n            db_session.commit()\n            status = \"success\"\n        except exc.SQLAlchemyError:\n            status = \"database error\"\n        resp = {\"status\": status}\n        return jsonify(**resp)\n\n\n@app.route('/worker_submitted', methods=['GET'])\ndef worker_submitted():\n    \"\"\" Submit worker \"\"\"\n    if 'uniqueId' not in request.args:\n        resp = {\"status\": \"bad request\"}\n        return jsonify(**resp)\n    else:\n        unique_id = request.args['uniqueId']\n        app.logger.info(\"Submitted experiment for %s\" % unique_id)\n        try:\n            user = Participant.query.\\\n                filter(Participant.uniqueid == unique_id).one()\n            user.status = SUBMITTED\n            db_session.add(user)\n            db_session.commit()\n            status = \"success\"\n        except exc.SQLAlchemyError:\n            status = \"database error\"\n        resp = {\"status\": status}\n        return jsonify(**resp)\n\n# Is this a security risk?\n@app.route(\"/ppid\")\ndef ppid():\n    \"\"\" Get ppid \"\"\"\n    proc_id = os.getppid()\n    return str(proc_id)\n\n# Insert \"mode\" into pages so it's carried from page to page done server-side\n# to avoid breaking backwards compatibility with old templates.\n\n\ndef insert_mode(page_html, mode):\n    \"\"\" Insert mode \"\"\"\n    page_html = page_html\n    match_found = False\n    matches = re.finditer('workerId={{ workerid }}', page_html)\n    match = None\n    for match in matches:\n        match_found = True\n    if match_found:\n        new_html = page_html[:match.end()] + \"&mode=\" + mode +\\\n            page_html[match.end():]\n        return new_html\n    else:\n        raise ExperimentError(\"insert_mode_failed\")\n\n\n# Generic route\n# =============\n\n@app.route('/<path:path>')\ndef regularpage(path):\n    \"\"\"\n    Route not found by the other routes above. May point to a static template.\n    \"\"\"\n    return send_from_directory('templates', path)\n\n\ndef run_webserver():\n    \"\"\" Run web server \"\"\"\n    host = CONFIG.get('Server Parameters', 'host')\n    port = CONFIG.getint('Server Parameters', 'port')\n    print(f\"Serving on http://{host}:{port}\")\n    app.config['TEMPLATES_AUTO_RELOAD'] = True\n    app.jinja_env.auto_reload = True\n    app.run(debug=True, host=host, port=port)\n\n\nif __name__ == '__main__':\n    run_webserver()\n", "patch": "@@ -380,9 +380,10 @@ def advertisement():\n         # even have accepted the HIT.\n         with open('templates/ad.html', 'r') as temp_file:\n             ad_string = temp_file.read()\n-        ad_string = insert_mode(ad_string, mode)\n+        ad_string = insert_mode(ad_string)\n         return render_template_string(\n             ad_string,\n+            mode=mode,\n             hitid=hit_id,\n             assignmentid=assignment_id,\n             workerid=worker_id\n@@ -406,9 +407,10 @@ def give_consent():\n     mode = request.args['mode']\n     with open('templates/consent.html', 'r') as temp_file:\n         consent_string = temp_file.read()\n-    consent_string = insert_mode(consent_string, mode)\n+    consent_string = insert_mode(consent_string)\n     return render_template_string(\n         consent_string,\n+        mode=mode,\n         hitid=hit_id,\n         assignmentid=assignment_id,\n         workerid=worker_id\n@@ -731,7 +733,7 @@ def ppid():\n # to avoid breaking backwards compatibility with old templates.\n \n \n-def insert_mode(page_html, mode):\n+def insert_mode(page_html):\n     \"\"\" Insert mode \"\"\"\n     page_html = page_html\n     match_found = False\n@@ -740,7 +742,7 @@ def insert_mode(page_html, mode):\n     for match in matches:\n         match_found = True\n     if match_found:\n-        new_html = page_html[:match.end()] + \"&mode=\" + mode +\\\n+        new_html = page_html[:match.end()] + '&mode={{ mode }}' +\\\n             page_html[match.end():]\n         return new_html\n     else:", "file_path": "files/2023_1/113", "file_language": "py", "file_name": "psiturk/experiment.py", "outdated_file_modify": 0, "outdated_file_before": 0, "outdated_file_after": 0, "llm_check": 1, "static_check": 1, "static": {"rats": [false, []], "semgrep": [true, ["       python.flask.security.audit.render-template-string.render-template-string                      \n          Found a template created with string formatting. This is susceptible to server-side template\n          injection and cross-site scripting attacks.                                                 \n          Details: https://sg.run/8yjE                                                                \n\n          410\u2506 return render_template_string(\n          411\u2506     consent_string,\n          412\u2506     hitid=hit_id,\n          413\u2506     assignmentid=assignment_id,\n          414\u2506     workerid=worker_id\n          415\u2506 )", "       python.flask.security.audit.render-template-string.render-template-string                      \n          Found a template created with string formatting. This is susceptible to server-side template\n          injection and cross-site scripting attacks.                                                 \n          Details: https://sg.run/8yjE                                                                \n\n          384\u2506 return render_template_string(\n          385\u2506     ad_string,\n          386\u2506     hitid=hit_id,\n          387\u2506     assignmentid=assignment_id,\n          388\u2506     workerid=worker_id\n          389\u2506 )"]]}, "target": 1, "function_before": [{"function": "def check_templates_exist():\n    # this checks for templates that are required if you are hosting your own ad.\n    try:\n        try_these = ['thanks-mturksubmit.html', 'closepopup.html']\n        [app.jinja_env.get_template(try_this) for try_this in try_these]\n    except TemplateNotFound as e:\n        raise RuntimeError((\n            f\"Missing one of the following templates: {', '.join(try_these)}.\"\n            f\"Copy these over from a freshly-created psiturk example experiment.\"\n            f\"{type(e).__name__, str(e)}\"\n        ))", "target": 0}, {"function": "def get_random_condcount(mode):\n    \"\"\"\n    HITs can be in one of three states:\n        - jobs that are finished\n        - jobs that are started but not finished\n        - jobs that are never going to finish (user decided not to do it)\n    Our count should be based on the first two, so we count any tasks finished\n    or any tasks not finished that were started in the last cutoff_time\n    minutes, as specified in the cutoff_time variable in the config file.\n\n    Returns a tuple: (cond, condition)\n    \"\"\"\n    cutofftime = datetime.timedelta(minutes=-CONFIG.getint('Task Parameters',\n                                                           'cutoff_time'))\n    starttime = datetime.datetime.now(datetime.timezone.utc) + cutofftime\n\n    try:\n        conditions = json.load(\n            open(os.path.join(app.root_path, 'conditions.json')))\n        numconds = len(list(conditions.keys()))\n        numcounts = 1\n    except IOError:\n        numconds = CONFIG.getint('Task Parameters', 'num_conds')\n        numcounts = CONFIG.getint('Task Parameters', 'num_counters')\n\n    participants = Participant.query.\\\n        filter(Participant.codeversion ==\n               CONFIG.get('Task Parameters', 'experiment_code_version')).\\\n        filter(Participant.mode == mode).\\\n        filter(or_(Participant.status == COMPLETED,\n                   Participant.status == CREDITED,\n                   Participant.status == SUBMITTED,\n                   Participant.status == BONUSED,\n                   Participant.beginhit > starttime)).all()\n    counts = Counter()\n    for cond in range(numconds):\n        for counter in range(numcounts):\n            counts[(cond, counter)] = 0\n    for participant in participants:\n        condcount = (participant.cond, participant.counterbalance)\n        if condcount in counts:\n            counts[condcount] += 1\n    mincount = min(counts.values())\n    minima = [hsh for hsh, count in counts.items() if count == mincount]\n    chosen = choice(minima)\n    app.logger.info(\"given %(a)s chose %(b)s\" % {'a': counts, 'b': chosen})\n\n    return chosen", "target": 0}, {"function": "def insert_mode(page_html, mode):\n    \"\"\" Insert mode \"\"\"\n    page_html = page_html\n    match_found = False\n    matches = re.finditer('workerId={{ workerid }}', page_html)\n    match = None\n    for match in matches:\n        match_found = True\n    if match_found:\n        new_html = page_html[:match.end()] + \"&mode=\" + mode +\\\n            page_html[match.end():]\n        return new_html\n    else:\n        raise ExperimentError(\"insert_mode_failed\")", "target": 1, "line": "@@  -731,7 +733,7  @@ def ppid():\n # to avoid breaking backwards compatibility with old templates.\n \n \n-def insert_mode(page_html, mode):\n+def insert_mode(page_html):\n     \"\"\" Insert mode \"\"\"\n     page_html = page_html\n     match_found = False\n@@  -740,7 +742,7  @@ def insert_mode(page_html, mode):\n     for match in matches:\n         match_found = True\n     if match_found:\n-        new_html = page_html[:match.end()] + \"&mode=\" + mode +\\\n+        new_html = page_html[:match.end()] + '&mode={{ mode }}' +\\\n             page_html[match.end():]\n         return new_html\n     else:"}, {"function": "def run_webserver():\n    \"\"\" Run web server \"\"\"\n    host = CONFIG.get('Server Parameters', 'host')\n    port = CONFIG.getint('Server Parameters', 'port')\n    print(f\"Serving on http://{host}:{port}\")\n    app.config['TEMPLATES_AUTO_RELOAD'] = True\n    app.jinja_env.auto_reload = True\n    app.run(debug=True, host=host, port=port)", "target": 0}], "function_after": [{"function": "def check_templates_exist():\n    # this checks for templates that are required if you are hosting your own ad.\n    try:\n        try_these = ['thanks-mturksubmit.html', 'closepopup.html']\n        [app.jinja_env.get_template(try_this) for try_this in try_these]\n    except TemplateNotFound as e:\n        raise RuntimeError((\n            f\"Missing one of the following templates: {', '.join(try_these)}.\"\n            f\"Copy these over from a freshly-created psiturk example experiment.\"\n            f\"{type(e).__name__, str(e)}\"\n        ))", "target": 0}, {"function": "def get_random_condcount(mode):\n    \"\"\"\n    HITs can be in one of three states:\n        - jobs that are finished\n        - jobs that are started but not finished\n        - jobs that are never going to finish (user decided not to do it)\n    Our count should be based on the first two, so we count any tasks finished\n    or any tasks not finished that were started in the last cutoff_time\n    minutes, as specified in the cutoff_time variable in the config file.\n\n    Returns a tuple: (cond, condition)\n    \"\"\"\n    cutofftime = datetime.timedelta(minutes=-CONFIG.getint('Task Parameters',\n                                                           'cutoff_time'))\n    starttime = datetime.datetime.now(datetime.timezone.utc) + cutofftime\n\n    try:\n        conditions = json.load(\n            open(os.path.join(app.root_path, 'conditions.json')))\n        numconds = len(list(conditions.keys()))\n        numcounts = 1\n    except IOError:\n        numconds = CONFIG.getint('Task Parameters', 'num_conds')\n        numcounts = CONFIG.getint('Task Parameters', 'num_counters')\n\n    participants = Participant.query.\\\n        filter(Participant.codeversion ==\n               CONFIG.get('Task Parameters', 'experiment_code_version')).\\\n        filter(Participant.mode == mode).\\\n        filter(or_(Participant.status == COMPLETED,\n                   Participant.status == CREDITED,\n                   Participant.status == SUBMITTED,\n                   Participant.status == BONUSED,\n                   Participant.beginhit > starttime)).all()\n    counts = Counter()\n    for cond in range(numconds):\n        for counter in range(numcounts):\n            counts[(cond, counter)] = 0\n    for participant in participants:\n        condcount = (participant.cond, participant.counterbalance)\n        if condcount in counts:\n            counts[condcount] += 1\n    mincount = min(counts.values())\n    minima = [hsh for hsh, count in counts.items() if count == mincount]\n    chosen = choice(minima)\n    app.logger.info(\"given %(a)s chose %(b)s\" % {'a': counts, 'b': chosen})\n\n    return chosen", "target": 0}, {"function": "def insert_mode(page_html):\n    \"\"\" Insert mode \"\"\"\n    page_html = page_html\n    match_found = False\n    matches = re.finditer('workerId={{ workerid }}', page_html)\n    match = None\n    for match in matches:\n        match_found = True\n    if match_found:\n        new_html = page_html[:match.end()] + '&mode={{ mode }}' +\\\n            page_html[match.end():]\n        return new_html\n    else:\n        raise ExperimentError(\"insert_mode_failed\")", "target": 0}, {"function": "def run_webserver():\n    \"\"\" Run web server \"\"\"\n    host = CONFIG.get('Server Parameters', 'host')\n    port = CONFIG.getint('Server Parameters', 'port')\n    print(f\"Serving on http://{host}:{port}\")\n    app.config['TEMPLATES_AUTO_RELOAD'] = True\n    app.jinja_env.auto_reload = True\n    app.run(debug=True, host=host, port=port)", "target": 0}]}, {"raw_url": "https://github.com/NYUCCL/psiTurk/raw/47787e15cecd66f2aa87687bf852ae0194a4335f/tests%2Ftest_psiturk.py", "code": "# -*- coding: utf-8 -*-\n\"\"\" This module tests the psiTurk suite.  \"\"\"\n\nfrom builtins import str\nfrom builtins import object\nimport os\nimport unittest\nimport psiturk\nimport json\nfrom faker import Faker\nimport pytest\nfrom importlib import reload  # Python 3.4+\n\nfake = Faker()  # Fake data generator\n\n\nclass FlaskTestClientProxy(object):\n    \"\"\"Spoof user agent (Chrome)\"\"\"\n\n    def __init__(self, app):\n        self.app = app\n\n    def __call__(self, environ, start_response):\n        environ['REMOTE_ADDR'] = environ.get('REMOTE_ADDR', fake.ipv4())\n        environ['HTTP_USER_AGENT'] = 'Mozilla/5.0 (Macintosh; Intel Mac OS X\\\n            10_9_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1944.0\\\n            Safari/537.36'\n        return self.app(environ, start_response)\n\n\nclass BadFlaskTestClientProxy(object):\n    \"\"\"Spoof user agent (iPad)\"\"\"\n\n    def __init__(self, app):\n        self.app = app\n\n    def __call__(self, environ, start_response):\n        environ['REMOTE_ADDR'] = environ.get('REMOTE_ADDR', fake.ipv4())\n        environ['HTTP_USER_AGENT'] = 'Mozilla/5.0 (iPad; U; CPU OS 3_2 like \\\n            Mac OS X; en-us) AppleWebKit/531.21.10 (KHTML, like Gecko) \\\n            Version/4.0.4 Mobile/7B334b Safari/531.21.10'\n        return self.app(environ, start_response)\n\n\nclass PsiturkUnitTest(unittest.TestCase):\n\n    def setUp(self, case=None):\n        \"\"\"Build up fixtures\"\"\"\n        import psiturk.experiment\n        reload(psiturk.experiment)\n\n        psiturk.experiment.app.wsgi_app = FlaskTestClientProxy(\n            psiturk.experiment.app.wsgi_app)\n        self.app = psiturk.experiment.app.test_client()\n        self.config = psiturk.experiment.CONFIG\n\n        # Fake MTurk data\n        self.worker_id = fake.md5(raw_output=False)\n        self.hit_id = fake.md5(raw_output=False)\n        self.assignment_id = fake.md5(raw_output=False)\n\n    def tearDown(self):\n        \"\"\"Tear down fixtures\"\"\"\n        self.app = None\n\n    def set_config(self, section, field, value):\n        self.config.parent.set(self.config, section, field, str(value))\n\n\n@pytest.fixture()\ndef remove_file(tmpdir):\n    def do_it(filename):\n        import shutil\n        shutil.move(filename, './{}.xyz'.format(filename))\n\n    return do_it\n\n\n@pytest.fixture()\ndef remove_template(remove_file):\n    def do_it(template_name):\n        remove_file('templates/{}'.format(template_name))\n\n    return do_it\n\n\n@pytest.fixture()\ndef psiturk_test_client():\n    def do_it():\n        import psiturk.experiment\n        reload(psiturk.experiment)\n        psiturk.experiment.app.wsgi_app = FlaskTestClientProxy(\n            psiturk.experiment.app.wsgi_app)\n        return psiturk.experiment.app\n\n    yield do_it\n\n\ndef test_custom_get_condition_can_import(mocker, psiturk_test_client):\n    # pytest.set_trace()\n    # import psiturk.experiment\n    import sys\n    sys.path.append(os.getcwd())\n    import custom\n    reload(custom)\n    mocker.patch.object(custom, 'custom_get_condition', lambda mode: (9, 9), create=True)\n    app = psiturk_test_client()\n\n    from psiturk.experiment import get_condition\n    assert get_condition('') == (9, 9)\n\n\ndef test_custom_get_condition_not_necessary(tmpdir, mocker, psiturk_test_client):\n    import sys\n    sys.path.append(os.getcwd())\n    import custom\n    reload(custom)\n    app = psiturk_test_client()\n\n    from psiturk.experiment import get_condition\n    assert get_condition('') == (0, 0)\n\n\ndef test_missing_template_exception(edit_config_file, remove_template, psiturk_test_client):\n    remove_template('closepopup.html')\n    with pytest.raises(RuntimeError):\n        app = psiturk_test_client()\n\n\ndef test_notmissing_template(edit_config_file, remove_template, psiturk_test_client):\n    psiturk_test_client()\n\n\ndef test_does_not_die_if_no_custompy(remove_file, psiturk_test_client):\n    remove_file('custom.py')\n    psiturk_test_client()\n\n\ndef test_insert_mode(psiturk_test_client):\n    with open('templates/ad.html', 'r') as temp_file:\n        ad_string = temp_file.read()\n\n    from psiturk.experiment import insert_mode\n    insert_mode(ad_string)\n\n\nclass PsiTurkStandardTests(PsiturkUnitTest):\n\n    # Test experiment.py\n    # ==================\n\n    def test_default_page(self):\n        \"\"\"Test that root page works.\"\"\"\n        rv = self.app.get('/')\n        response = rv.get_data(as_text=True)\n        # print(os.getcwd())\n        # with open('server.log','r') as infile:\n        # print(file.read())\n        assert ('Welcome to psiTurk!' in response)\n\n    def test_exp_debug_no_url_vars(self):\n        \"\"\"Test that exp page throws Error #1003 with no url vars.\"\"\"\n        rv = self.app.get('/exp')\n        assert u'<b>Error</b>: 1003' in rv.get_data(as_text=True)\n\n    def test_ad_no_url_vars(self):\n        \"\"\"Test that ad page throws Error #1001 with no url vars.\"\"\"\n        rv = self.app.get('/ad')\n        assert u'<b>Error</b>: 1001' in rv.get_data(as_text=True)\n\n    def test_ad_with_all_urls(self):\n        \"\"\"Test that ad page throws Error #1003 with no url vars.\"\"\"\n        args = '&'.join([\n            'assignmentId=debug%s' % self.assignment_id,\n            'workerId=debug%s' % self.worker_id,\n            'hitId=debug%s' % self.hit_id,\n            'mode=sandbox'])\n        rv = self.app.get('/ad?%s' % args)\n        assert 'Thank you for accepting this HIT!' in rv.get_data(as_text=True)\n\n    @pytest.mark.skip('psiturk api server is slow for this test')\n    def test_exp_with_all_url_vars_not_registered_on_ad_server(self):\n        \"\"\"Test that exp page throws Error #1018 with all url vars but not registered.\"\"\"\n        self.set_config('Shell Parameters', 'use_psiturk_ad_server', 'true')\n        args = '&'.join([\n            'assignmentId=debug%s' % self.assignment_id,\n            'workerId=debug%s' % self.worker_id,\n            'hitId=debug%s' % self.hit_id,\n            'mode=sandbox'])\n        rv = self.app.get('/exp?%s' % args)\n        assert '<b>Error</b>: 1018' in rv.get_data(as_text=True)\n\n    def test_sync_put(self):\n        request = \"&\".join([\n            \"assignmentId=debug%s\" % self.assignment_id,\n            \"workerId=debug%s\" % self.worker_id,\n            \"hitId=debug%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n\n        # try putting the sync, simulating a Backbone PUT payload\n        uniqueid = \"debug%s:debug%s\" % (self.worker_id, self.assignment_id)\n        payload = {\n            \"condition\": 5,\n            \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id,\n            \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id,\n            \"currenttrial\": 2,\n            \"bonus\": 0,\n            \"data\": [\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 0,\n                    \"dateTime\": 1564425799481,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"begin\"\n                    }\n                }, {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 1,\n                    \"dateTime\": 1564425802158,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"submit\"\n                    }\n                }\n            ],\n            \"questiondata\": {\n                \"engagement\": \"5\",\n                \"difficulty\": \"5\"\n            },\n            \"eventdata\": [\n                {\n                    \"eventtype\": \"initialized\",\n                    \"value\": '',\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }, {\n                    \"eventtype\": \"window_resize\",\n                    \"value\": [933, 708],\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }\n            ],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"\n        }\n        rv = self.app.put('/sync/%s' % uniqueid, json=payload)\n        status = json.loads(rv.get_data(as_text=True)).get(\"status\", \"\")\n        assert status == \"user data saved\"\n\n    def test_sync_get(self):\n        self.assignment_id = \"debug%s\" % self.assignment_id\n        self.worker_id = \"debug%s\" % self.worker_id\n        self.hit_id = \"debug%s\" % self.hit_id\n\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n\n        # save data with sync PUT\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        condition = 0\n        counterbalance = 0\n        bonus = 0.0\n        payload = {\n            \"condition\": condition,\n            \"counterbalance\": counterbalance,\n            \"assignmentId\": self.assignment_id,\n            \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id,\n            \"currenttrial\": 2,\n            \"bonus\": bonus,\n            \"data\": [\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 0,\n                    \"dateTime\": 1564425799481,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"begin\"\n                    }\n                },\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 1,\n                    \"dateTime\": 1564425802158,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"submit\"\n                    }\n                }\n            ],\n            \"questiondata\": {\n                \"engagement\": \"5\",\n                \"difficulty\": \"5\"\n            },\n            \"eventdata\": [\n                {\n                    \"eventtype\": \"initialized\",\n                    \"value\": '',\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                },\n                {\n                    \"eventtype\": \"window_resize\",\n                    \"value\": [933, 708],\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }\n            ],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"\n        }\n        rv = self.app.put('/sync/%s' % uniqueid, json=payload)\n\n        # get data with sync GET\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        rv = self.app.get('/sync/%s' % uniqueid)\n\n        response = json.loads(rv.get_data(as_text=True))\n        assert response.get(\"assignmentId\", \"\") == \"%s\" % self.assignment_id\n        assert response.get(\"workerId\", \"\") == \"%s\" % self.worker_id\n        assert response.get(\"hitId\", \"\") == \"%s\" % self.hit_id\n        assert response.get(\"condition\", None) == condition\n        assert response.get(\"counterbalance\", None) == counterbalance\n        assert response.get(\"bonus\", None) == bonus\n\n    def test_favicon(self):\n        \"\"\"Test that favicon loads.\"\"\"\n        rv = self.app.get('/favicon.ico')\n        assert rv.status_code == 200\n\n    def test_complete_experiment(self):\n        \"\"\"Test that a participant can start and finish the experiment.\"\"\"\n        request = \"&\".join([\n            \"assignmentId=debug%s\" % self.assignment_id,\n            \"workerId=debug%s\" % self.worker_id,\n            \"hitId=debug%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # complete experiment\n        uniqueid = \"debug%s:debug%s\" % (self.worker_id, self.assignment_id)\n        mode = 'debug'\n        rv = self.app.get('/complete?uniqueId=%s&mode=%s' % (uniqueid, mode))\n        assert rv.status_code == 200\n\n    def test_repeat_experiment_fail(self):\n        \"\"\"Test that a participant cannot repeat the experiment.\"\"\"\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # save data with sync PUT\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        payload = {\n            \"condition\": 5, \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id,\n            \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id,\n            \"currenttrial\": 2,\n            \"bonus\": 0,\n            \"data\": [\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 0,\n                    \"dateTime\": 1564425799481,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"begin\"\n                    }\n                },\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 1,\n                    \"dateTime\": 1564425802158,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"submit\"\n                    }\n                }\n            ],\n            \"questiondata\": {\n                \"engagement\": \"5\",\n                \"difficulty\": \"5\"\n            },\n            \"eventdata\": [\n                {\n                    \"eventtype\": \"initialized\",\n                    \"value\": '',\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                },\n                {\n                    \"eventtype\": \"window_resize\",\n                    \"value\": [933, 708],\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }\n            ],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"\n        }\n        rv = self.app.put('/sync/%s' % uniqueid, json={\n            \"condition\": 5,\n            \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id,\n            \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id,\n            \"currenttrial\": 2,\n            \"bonus\": 0, \"data\": [\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 0,\n                    \"dateTime\": 1564425799481,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"begin\"\n                    }\n                },\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 1,\n                    \"dateTime\": 1564425802158,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"submit\"\n                    }\n                }\n            ],\n            \"questiondata\": {\n                \"engagement\": \"5\",\n                \"difficulty\": \"5\"\n            },\n            \"eventdata\": [\n                {\n                    \"eventtype\": \"initialized\", \"value\": '',\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                },\n                {\n                    \"eventtype\": \"window_resize\",\n                    \"value\": [933, 708],\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }\n            ],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"\n        })\n        assert rv.status_code == 200\n\n        # complete experiment\n        mode = 'debug'\n        rv = self.app.get('/complete?uniqueId=%s&mode=%s' % (uniqueid, mode))\n        assert rv.status_code == 200\n\n        # choose new assignment and hit ids\n        self.assignment_id = fake.md5(raw_output=False)\n        self.hit_id = fake.md5(raw_output=False)\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert ': 1010' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert ': 1010' in rv.get_data(as_text=True)\n\n    def test_repeat_experiment_success(self):\n        \"\"\"Test that a participant can repeat the experiment.\"\"\"\n        self.set_config(u'Task Parameters', u'allow_repeats', u'true')\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # save data with sync PUT\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        payload = {\n            \"condition\": 5, \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id, \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id, \"currenttrial\": 2, \"bonus\": 0, \"data\": [\n                {\"uniqueid\": uniqueid, \"current_trial\": 0, \"dateTime\": 1564425799481,\n                 \"trialdata\": {\"phase\": \"postquestionnaire\", \"status\": \"begin\"}},\n                {\"uniqueid\": uniqueid, \"current_trial\": 1, \"dateTime\": 1564425802158,\n                 \"trialdata\": {\"phase\": \"postquestionnaire\", \"status\": \"submit\"}}],\n            \"questiondata\": {\"engagement\": \"5\", \"difficulty\": \"5\"}, \"eventdata\": [\n                {\"eventtype\": \"initialized\", \"value\": '', \"timestamp\": 1564425799139,\n                 \"interval\": 0},\n                {\"eventtype\": \"window_resize\", \"value\": [933, 708], \"timestamp\": 1564425799139,\n                 \"interval\": 0}],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"}\n        rv = self.app.put('/sync/%s' % uniqueid, json=payload)\n        assert rv.status_code == 200\n\n        # complete experiment\n        mode = 'debug'\n        rv = self.app.get('/complete?uniqueId=%s&mode=%s' % (uniqueid, mode))\n        assert rv.status_code == 200\n\n        # choose new assignment and hit ids\n        self.assignment_id = fake.md5(raw_output=False)\n        self.hit_id = fake.md5(raw_output=False)\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # make sure they are not blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1010' not in rv.get_data(as_text=True)\n\n        # make sure they are not blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1010' not in rv.get_data(as_text=True)\n\n        # save data with sync PUT\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        payload = payload = {\n            \"condition\": 5, \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id, \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id, \"currenttrial\": 2, \"bonus\": 0, \"data\": [\n                {\"uniqueid\": uniqueid, \"current_trial\": 0, \"dateTime\": 1564425799481,\n                 \"trialdata\": {\"phase\": \"postquestionnaire\", \"status\": \"begin\"}},\n                {\"uniqueid\": uniqueid, \"current_trial\": 1, \"dateTime\": 1564425802158,\n                 \"trialdata\": {\"phase\": \"postquestionnaire\", \"status\": \"submit\"}}],\n            \"questiondata\": {\"engagement\": \"5\", \"difficulty\": \"5\"}, \"eventdata\": [\n                {\"eventtype\": \"initialized\", \"value\": '', \"timestamp\": 1564425799139,\n                 \"interval\": 0},\n                {\"eventtype\": \"window_resize\", \"value\": [933, 708], \"timestamp\": 1564425799139,\n                 \"interval\": 0}],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"}\n        rv = self.app.put('/sync/%s' % uniqueid, json=payload)\n        assert rv.status_code == 200\n\n        # complete experiment\n        mode = 'debug'\n        rv = self.app.get('/complete?uniqueId=%s&mode=%s' % (uniqueid, mode))\n        assert rv.status_code == 200\n\n    def test_repeat_experiment_quit(self):\n        \"\"\"Test that a participant cannot restart the experiment.\"\"\"\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # put the in the experiment\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        rv = self.app.post(\"/inexp\", data=dict(uniqueId=uniqueid))\n        assert rv.status_code == 200\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1009' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1008' in rv.get_data(as_text=True)\n\n        # have them quit the experiment\n        rv = self.app.post(\"/quitter\", data=dict(uniqueId=uniqueid))\n        assert rv.status_code == 200\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1009' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1008' in rv.get_data(as_text=True)\n\n    def test_repeat_experiment_quit_allow_repeats(self):\n        \"\"\"Test that a participant cannot restart the experiment, even when repeats are allowed.\"\"\"\n        self.set_config(u'Task Parameters', u'allow_repeats', u'true')\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # put the in the experiment\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        rv = self.app.post(\"/inexp\", data=dict(uniqueId=uniqueid))\n        assert rv.status_code == 200\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1009' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1008' in rv.get_data(as_text=True)\n\n        # have them quit the experiment\n        rv = self.app.post(\"/quitter\", data=dict(uniqueId=uniqueid))\n        assert rv.status_code == 200\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1009' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1008' in rv.get_data(as_text=True)\n\n\nclass BadUserAgent(PsiturkUnitTest):\n    \"\"\"Setup test blocked user agent (iPad/tablets)\"\"\"\n\n    def setUp(self):\n        \"\"\"Build up fixtures\"\"\"\n        import psiturk.experiment\n        reload(psiturk.experiment)\n\n        psiturk.experiment.app.wsgi_app = BadFlaskTestClientProxy(\n            psiturk.experiment.app.wsgi_app)\n        self.app = psiturk.experiment.app.test_client()\n\n        # Fake MTurk data\n        self.worker_id = fake.md5(raw_output=False)\n        self.hit_id = fake.md5(raw_output=False)\n        self.assignment_id = fake.md5(raw_output=False)\n\n    def test_ad_with_bad_user_agent(self):\n        \"\"\"Test that ad page throws Error when user agent is blocked.\"\"\"\n        rv = self.app.get(\n            '/ad' + '?assignmentId=debug' + self.assignment_id + '&workerId=debug' +\n            self.worker_id + '&hitId=debug' + self.hit_id + '&mode=sandbox'\n        )\n        assert '<b>Error</b>: 1014' in rv.get_data(as_text=True)\n\n\nclass PsiTurkTestPsiturkJS(PsiturkUnitTest):\n    \"\"\" Setup test for missing psiturk.js file. \"\"\"\n\n    def setUp(self):\n        \"\"\"Build up fixtures\"\"\"\n        self.PSITURK_JS_FILE = '../psiturk/psiturk_js/psiturk.js'\n        os.rename(self.PSITURK_JS_FILE, self.PSITURK_JS_FILE + '.bup')\n        import psiturk.experiment\n        reload(psiturk.experiment)\n\n        psiturk.experiment.app.wsgi_app = FlaskTestClientProxy(\n            psiturk.experiment.app.wsgi_app)\n        self.app = psiturk.experiment.app.test_client()\n\n    @pytest.mark.skip('soemthing about the testing env is making this not work well')\n    def test_psiturk_js_is_missing(self):\n        \"\"\" Test for missing psiturk.js \"\"\"\n        rv = self.app.get('static/js/psiturk.js')\n        assert 'file not found' in rv.get_data(as_text=True)\n\n    def tearDown(self):\n        \"\"\"Tear down fixtures\"\"\"\n        super(PsiTurkTestPsiturkJS, self).tearDown()\n        os.rename(self.PSITURK_JS_FILE + '.bup', self.PSITURK_JS_FILE)\n\n\nclass ExperimentErrorsTest(PsiturkUnitTest):\n\n    def test_experiment_errors(self):\n        \"\"\"Make sure every error has a description\"\"\"\n        error_cls = psiturk.experiment_errors.ExperimentError\n\n        for error_name in error_cls.experiment_errors:\n            assert error_name in error_cls.error_descriptions\n\n        for error_name in error_cls.error_descriptions:\n            assert error_name in error_cls.experiment_errors\n\n\nif __name__ == '__main__':\n    unittest.main()\n", "code_before": "# -*- coding: utf-8 -*-\n\"\"\" This module tests the psiTurk suite.  \"\"\"\n\nfrom builtins import str\nfrom builtins import object\nimport os\nimport unittest\nimport psiturk\nimport json\nfrom faker import Faker\nimport pytest\nfrom importlib import reload  # Python 3.4+\n\nfake = Faker()  # Fake data generator\n\n\nclass FlaskTestClientProxy(object):\n    \"\"\"Spoof user agent (Chrome)\"\"\"\n\n    def __init__(self, app):\n        self.app = app\n\n    def __call__(self, environ, start_response):\n        environ['REMOTE_ADDR'] = environ.get('REMOTE_ADDR', fake.ipv4())\n        environ['HTTP_USER_AGENT'] = 'Mozilla/5.0 (Macintosh; Intel Mac OS X\\\n            10_9_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1944.0\\\n            Safari/537.36'\n        return self.app(environ, start_response)\n\n\nclass BadFlaskTestClientProxy(object):\n    \"\"\"Spoof user agent (iPad)\"\"\"\n\n    def __init__(self, app):\n        self.app = app\n\n    def __call__(self, environ, start_response):\n        environ['REMOTE_ADDR'] = environ.get('REMOTE_ADDR', fake.ipv4())\n        environ['HTTP_USER_AGENT'] = 'Mozilla/5.0 (iPad; U; CPU OS 3_2 like \\\n            Mac OS X; en-us) AppleWebKit/531.21.10 (KHTML, like Gecko) \\\n            Version/4.0.4 Mobile/7B334b Safari/531.21.10'\n        return self.app(environ, start_response)\n\n\nclass PsiturkUnitTest(unittest.TestCase):\n\n    def setUp(self, case=None):\n        \"\"\"Build up fixtures\"\"\"\n        import psiturk.experiment\n        reload(psiturk.experiment)\n\n        psiturk.experiment.app.wsgi_app = FlaskTestClientProxy(\n            psiturk.experiment.app.wsgi_app)\n        self.app = psiturk.experiment.app.test_client()\n        self.config = psiturk.experiment.CONFIG\n\n        # Fake MTurk data\n        self.worker_id = fake.md5(raw_output=False)\n        self.hit_id = fake.md5(raw_output=False)\n        self.assignment_id = fake.md5(raw_output=False)\n\n    def tearDown(self):\n        \"\"\"Tear down fixtures\"\"\"\n        self.app = None\n\n    def set_config(self, section, field, value):\n        self.config.parent.set(self.config, section, field, str(value))\n\n\n@pytest.fixture()\ndef remove_file(tmpdir):\n    def do_it(filename):\n        import shutil\n        shutil.move(filename, './{}.xyz'.format(filename))\n\n    return do_it\n\n\n@pytest.fixture()\ndef remove_template(remove_file):\n    def do_it(template_name):\n        remove_file('templates/{}'.format(template_name))\n\n    return do_it\n\n\n@pytest.fixture()\ndef psiturk_test_client():\n    def do_it():\n        import psiturk.experiment\n        reload(psiturk.experiment)\n        psiturk.experiment.app.wsgi_app = FlaskTestClientProxy(\n            psiturk.experiment.app.wsgi_app)\n        return psiturk.experiment.app\n\n    yield do_it\n\n\ndef test_custom_get_condition_can_import(mocker, psiturk_test_client):\n    # pytest.set_trace()\n    # import psiturk.experiment\n    import sys\n    sys.path.append(os.getcwd())\n    import custom\n    reload(custom)\n    mocker.patch.object(custom, 'custom_get_condition', lambda mode: (9, 9), create=True)\n    app = psiturk_test_client()\n\n    from psiturk.experiment import get_condition\n    assert get_condition('') == (9, 9)\n\n\ndef test_custom_get_condition_not_necessary(tmpdir, mocker, psiturk_test_client):\n    import sys\n    sys.path.append(os.getcwd())\n    import custom\n    reload(custom)\n    app = psiturk_test_client()\n\n    from psiturk.experiment import get_condition\n    assert get_condition('') == (0, 0)\n\n\ndef test_missing_template_exception(edit_config_file, remove_template, psiturk_test_client):\n    remove_template('closepopup.html')\n    with pytest.raises(RuntimeError):\n        app = psiturk_test_client()\n\n\ndef test_notmissing_template(edit_config_file, remove_template, psiturk_test_client):\n    psiturk_test_client()\n\n\ndef test_does_not_die_if_no_custompy(remove_file, psiturk_test_client):\n    remove_file('custom.py')\n    psiturk_test_client()\n\n\ndef test_insert_mode(psiturk_test_client):\n    with open('templates/ad.html', 'r') as temp_file:\n        ad_string = temp_file.read()\n\n    from psiturk.experiment import insert_mode\n    insert_mode(ad_string, 'debug')\n\n\nclass PsiTurkStandardTests(PsiturkUnitTest):\n\n    # Test experiment.py\n    # ==================\n\n    def test_default_page(self):\n        \"\"\"Test that root page works.\"\"\"\n        rv = self.app.get('/')\n        response = rv.get_data(as_text=True)\n        # print(os.getcwd())\n        # with open('server.log','r') as infile:\n        # print(file.read())\n        assert ('Welcome to psiTurk!' in response)\n\n    def test_exp_debug_no_url_vars(self):\n        \"\"\"Test that exp page throws Error #1003 with no url vars.\"\"\"\n        rv = self.app.get('/exp')\n        assert u'<b>Error</b>: 1003' in rv.get_data(as_text=True)\n\n    def test_ad_no_url_vars(self):\n        \"\"\"Test that ad page throws Error #1001 with no url vars.\"\"\"\n        rv = self.app.get('/ad')\n        assert u'<b>Error</b>: 1001' in rv.get_data(as_text=True)\n\n    def test_ad_with_all_urls(self):\n        \"\"\"Test that ad page throws Error #1003 with no url vars.\"\"\"\n        args = '&'.join([\n            'assignmentId=debug%s' % self.assignment_id,\n            'workerId=debug%s' % self.worker_id,\n            'hitId=debug%s' % self.hit_id,\n            'mode=sandbox'])\n        rv = self.app.get('/ad?%s' % args)\n        assert 'Thank you for accepting this HIT!' in rv.get_data(as_text=True)\n\n    @pytest.mark.skip('psiturk api server is slow for this test')\n    def test_exp_with_all_url_vars_not_registered_on_ad_server(self):\n        \"\"\"Test that exp page throws Error #1018 with all url vars but not registered.\"\"\"\n        self.set_config('Shell Parameters', 'use_psiturk_ad_server', 'true')\n        args = '&'.join([\n            'assignmentId=debug%s' % self.assignment_id,\n            'workerId=debug%s' % self.worker_id,\n            'hitId=debug%s' % self.hit_id,\n            'mode=sandbox'])\n        rv = self.app.get('/exp?%s' % args)\n        assert '<b>Error</b>: 1018' in rv.get_data(as_text=True)\n\n    def test_sync_put(self):\n        request = \"&\".join([\n            \"assignmentId=debug%s\" % self.assignment_id,\n            \"workerId=debug%s\" % self.worker_id,\n            \"hitId=debug%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n\n        # try putting the sync, simulating a Backbone PUT payload\n        uniqueid = \"debug%s:debug%s\" % (self.worker_id, self.assignment_id)\n        payload = {\n            \"condition\": 5,\n            \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id,\n            \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id,\n            \"currenttrial\": 2,\n            \"bonus\": 0,\n            \"data\": [\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 0,\n                    \"dateTime\": 1564425799481,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"begin\"\n                    }\n                }, {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 1,\n                    \"dateTime\": 1564425802158,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"submit\"\n                    }\n                }\n            ],\n            \"questiondata\": {\n                \"engagement\": \"5\",\n                \"difficulty\": \"5\"\n            },\n            \"eventdata\": [\n                {\n                    \"eventtype\": \"initialized\",\n                    \"value\": '',\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }, {\n                    \"eventtype\": \"window_resize\",\n                    \"value\": [933, 708],\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }\n            ],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"\n        }\n        rv = self.app.put('/sync/%s' % uniqueid, json=payload)\n        status = json.loads(rv.get_data(as_text=True)).get(\"status\", \"\")\n        assert status == \"user data saved\"\n\n    def test_sync_get(self):\n        self.assignment_id = \"debug%s\" % self.assignment_id\n        self.worker_id = \"debug%s\" % self.worker_id\n        self.hit_id = \"debug%s\" % self.hit_id\n\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n\n        # save data with sync PUT\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        condition = 0\n        counterbalance = 0\n        bonus = 0.0\n        payload = {\n            \"condition\": condition,\n            \"counterbalance\": counterbalance,\n            \"assignmentId\": self.assignment_id,\n            \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id,\n            \"currenttrial\": 2,\n            \"bonus\": bonus,\n            \"data\": [\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 0,\n                    \"dateTime\": 1564425799481,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"begin\"\n                    }\n                },\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 1,\n                    \"dateTime\": 1564425802158,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"submit\"\n                    }\n                }\n            ],\n            \"questiondata\": {\n                \"engagement\": \"5\",\n                \"difficulty\": \"5\"\n            },\n            \"eventdata\": [\n                {\n                    \"eventtype\": \"initialized\",\n                    \"value\": '',\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                },\n                {\n                    \"eventtype\": \"window_resize\",\n                    \"value\": [933, 708],\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }\n            ],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"\n        }\n        rv = self.app.put('/sync/%s' % uniqueid, json=payload)\n\n        # get data with sync GET\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        rv = self.app.get('/sync/%s' % uniqueid)\n\n        response = json.loads(rv.get_data(as_text=True))\n        assert response.get(\"assignmentId\", \"\") == \"%s\" % self.assignment_id\n        assert response.get(\"workerId\", \"\") == \"%s\" % self.worker_id\n        assert response.get(\"hitId\", \"\") == \"%s\" % self.hit_id\n        assert response.get(\"condition\", None) == condition\n        assert response.get(\"counterbalance\", None) == counterbalance\n        assert response.get(\"bonus\", None) == bonus\n\n    def test_favicon(self):\n        \"\"\"Test that favicon loads.\"\"\"\n        rv = self.app.get('/favicon.ico')\n        assert rv.status_code == 200\n\n    def test_complete_experiment(self):\n        \"\"\"Test that a participant can start and finish the experiment.\"\"\"\n        request = \"&\".join([\n            \"assignmentId=debug%s\" % self.assignment_id,\n            \"workerId=debug%s\" % self.worker_id,\n            \"hitId=debug%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # complete experiment\n        uniqueid = \"debug%s:debug%s\" % (self.worker_id, self.assignment_id)\n        mode = 'debug'\n        rv = self.app.get('/complete?uniqueId=%s&mode=%s' % (uniqueid, mode))\n        assert rv.status_code == 200\n\n    def test_repeat_experiment_fail(self):\n        \"\"\"Test that a participant cannot repeat the experiment.\"\"\"\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # save data with sync PUT\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        payload = {\n            \"condition\": 5, \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id,\n            \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id,\n            \"currenttrial\": 2,\n            \"bonus\": 0,\n            \"data\": [\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 0,\n                    \"dateTime\": 1564425799481,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"begin\"\n                    }\n                },\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 1,\n                    \"dateTime\": 1564425802158,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"submit\"\n                    }\n                }\n            ],\n            \"questiondata\": {\n                \"engagement\": \"5\",\n                \"difficulty\": \"5\"\n            },\n            \"eventdata\": [\n                {\n                    \"eventtype\": \"initialized\",\n                    \"value\": '',\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                },\n                {\n                    \"eventtype\": \"window_resize\",\n                    \"value\": [933, 708],\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }\n            ],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"\n        }\n        rv = self.app.put('/sync/%s' % uniqueid, json={\n            \"condition\": 5,\n            \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id,\n            \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id,\n            \"currenttrial\": 2,\n            \"bonus\": 0, \"data\": [\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 0,\n                    \"dateTime\": 1564425799481,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"begin\"\n                    }\n                },\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 1,\n                    \"dateTime\": 1564425802158,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"submit\"\n                    }\n                }\n            ],\n            \"questiondata\": {\n                \"engagement\": \"5\",\n                \"difficulty\": \"5\"\n            },\n            \"eventdata\": [\n                {\n                    \"eventtype\": \"initialized\", \"value\": '',\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                },\n                {\n                    \"eventtype\": \"window_resize\",\n                    \"value\": [933, 708],\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }\n            ],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"\n        })\n        assert rv.status_code == 200\n\n        # complete experiment\n        mode = 'debug'\n        rv = self.app.get('/complete?uniqueId=%s&mode=%s' % (uniqueid, mode))\n        assert rv.status_code == 200\n\n        # choose new assignment and hit ids\n        self.assignment_id = fake.md5(raw_output=False)\n        self.hit_id = fake.md5(raw_output=False)\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert ': 1010' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert ': 1010' in rv.get_data(as_text=True)\n\n    def test_repeat_experiment_success(self):\n        \"\"\"Test that a participant can repeat the experiment.\"\"\"\n        self.set_config(u'Task Parameters', u'allow_repeats', u'true')\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # save data with sync PUT\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        payload = {\n            \"condition\": 5, \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id, \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id, \"currenttrial\": 2, \"bonus\": 0, \"data\": [\n                {\"uniqueid\": uniqueid, \"current_trial\": 0, \"dateTime\": 1564425799481,\n                 \"trialdata\": {\"phase\": \"postquestionnaire\", \"status\": \"begin\"}},\n                {\"uniqueid\": uniqueid, \"current_trial\": 1, \"dateTime\": 1564425802158,\n                 \"trialdata\": {\"phase\": \"postquestionnaire\", \"status\": \"submit\"}}],\n            \"questiondata\": {\"engagement\": \"5\", \"difficulty\": \"5\"}, \"eventdata\": [\n                {\"eventtype\": \"initialized\", \"value\": '', \"timestamp\": 1564425799139,\n                 \"interval\": 0},\n                {\"eventtype\": \"window_resize\", \"value\": [933, 708], \"timestamp\": 1564425799139,\n                 \"interval\": 0}],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"}\n        rv = self.app.put('/sync/%s' % uniqueid, json=payload)\n        assert rv.status_code == 200\n\n        # complete experiment\n        mode = 'debug'\n        rv = self.app.get('/complete?uniqueId=%s&mode=%s' % (uniqueid, mode))\n        assert rv.status_code == 200\n\n        # choose new assignment and hit ids\n        self.assignment_id = fake.md5(raw_output=False)\n        self.hit_id = fake.md5(raw_output=False)\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # make sure they are not blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1010' not in rv.get_data(as_text=True)\n\n        # make sure they are not blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1010' not in rv.get_data(as_text=True)\n\n        # save data with sync PUT\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        payload = payload = {\n            \"condition\": 5, \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id, \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id, \"currenttrial\": 2, \"bonus\": 0, \"data\": [\n                {\"uniqueid\": uniqueid, \"current_trial\": 0, \"dateTime\": 1564425799481,\n                 \"trialdata\": {\"phase\": \"postquestionnaire\", \"status\": \"begin\"}},\n                {\"uniqueid\": uniqueid, \"current_trial\": 1, \"dateTime\": 1564425802158,\n                 \"trialdata\": {\"phase\": \"postquestionnaire\", \"status\": \"submit\"}}],\n            \"questiondata\": {\"engagement\": \"5\", \"difficulty\": \"5\"}, \"eventdata\": [\n                {\"eventtype\": \"initialized\", \"value\": '', \"timestamp\": 1564425799139,\n                 \"interval\": 0},\n                {\"eventtype\": \"window_resize\", \"value\": [933, 708], \"timestamp\": 1564425799139,\n                 \"interval\": 0}],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"}\n        rv = self.app.put('/sync/%s' % uniqueid, json=payload)\n        assert rv.status_code == 200\n\n        # complete experiment\n        mode = 'debug'\n        rv = self.app.get('/complete?uniqueId=%s&mode=%s' % (uniqueid, mode))\n        assert rv.status_code == 200\n\n    def test_repeat_experiment_quit(self):\n        \"\"\"Test that a participant cannot restart the experiment.\"\"\"\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # put the in the experiment\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        rv = self.app.post(\"/inexp\", data=dict(uniqueId=uniqueid))\n        assert rv.status_code == 200\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1009' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1008' in rv.get_data(as_text=True)\n\n        # have them quit the experiment\n        rv = self.app.post(\"/quitter\", data=dict(uniqueId=uniqueid))\n        assert rv.status_code == 200\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1009' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1008' in rv.get_data(as_text=True)\n\n    def test_repeat_experiment_quit_allow_repeats(self):\n        \"\"\"Test that a participant cannot restart the experiment, even when repeats are allowed.\"\"\"\n        self.set_config(u'Task Parameters', u'allow_repeats', u'true')\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # put the in the experiment\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        rv = self.app.post(\"/inexp\", data=dict(uniqueId=uniqueid))\n        assert rv.status_code == 200\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1009' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1008' in rv.get_data(as_text=True)\n\n        # have them quit the experiment\n        rv = self.app.post(\"/quitter\", data=dict(uniqueId=uniqueid))\n        assert rv.status_code == 200\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1009' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1008' in rv.get_data(as_text=True)\n\n\nclass BadUserAgent(PsiturkUnitTest):\n    \"\"\"Setup test blocked user agent (iPad/tablets)\"\"\"\n\n    def setUp(self):\n        \"\"\"Build up fixtures\"\"\"\n        import psiturk.experiment\n        reload(psiturk.experiment)\n\n        psiturk.experiment.app.wsgi_app = BadFlaskTestClientProxy(\n            psiturk.experiment.app.wsgi_app)\n        self.app = psiturk.experiment.app.test_client()\n\n        # Fake MTurk data\n        self.worker_id = fake.md5(raw_output=False)\n        self.hit_id = fake.md5(raw_output=False)\n        self.assignment_id = fake.md5(raw_output=False)\n\n    def test_ad_with_bad_user_agent(self):\n        \"\"\"Test that ad page throws Error when user agent is blocked.\"\"\"\n        rv = self.app.get(\n            '/ad' + '?assignmentId=debug' + self.assignment_id + '&workerId=debug' +\n            self.worker_id + '&hitId=debug' + self.hit_id + '&mode=sandbox'\n        )\n        assert '<b>Error</b>: 1014' in rv.get_data(as_text=True)\n\n\nclass PsiTurkTestPsiturkJS(PsiturkUnitTest):\n    \"\"\" Setup test for missing psiturk.js file. \"\"\"\n\n    def setUp(self):\n        \"\"\"Build up fixtures\"\"\"\n        self.PSITURK_JS_FILE = '../psiturk/psiturk_js/psiturk.js'\n        os.rename(self.PSITURK_JS_FILE, self.PSITURK_JS_FILE + '.bup')\n        import psiturk.experiment\n        reload(psiturk.experiment)\n\n        psiturk.experiment.app.wsgi_app = FlaskTestClientProxy(\n            psiturk.experiment.app.wsgi_app)\n        self.app = psiturk.experiment.app.test_client()\n\n    @pytest.mark.skip('soemthing about the testing env is making this not work well')\n    def test_psiturk_js_is_missing(self):\n        \"\"\" Test for missing psiturk.js \"\"\"\n        rv = self.app.get('static/js/psiturk.js')\n        assert 'file not found' in rv.get_data(as_text=True)\n\n    def tearDown(self):\n        \"\"\"Tear down fixtures\"\"\"\n        super(PsiTurkTestPsiturkJS, self).tearDown()\n        os.rename(self.PSITURK_JS_FILE + '.bup', self.PSITURK_JS_FILE)\n\n\nclass ExperimentErrorsTest(PsiturkUnitTest):\n\n    def test_experiment_errors(self):\n        \"\"\"Make sure every error has a description\"\"\"\n        error_cls = psiturk.experiment_errors.ExperimentError\n\n        for error_name in error_cls.experiment_errors:\n            assert error_name in error_cls.error_descriptions\n\n        for error_name in error_cls.error_descriptions:\n            assert error_name in error_cls.experiment_errors\n\n\nif __name__ == '__main__':\n    unittest.main()\n", "patch": "@@ -141,7 +141,7 @@ def test_insert_mode(psiturk_test_client):\n         ad_string = temp_file.read()\n \n     from psiturk.experiment import insert_mode\n-    insert_mode(ad_string, 'debug')\n+    insert_mode(ad_string)\n \n \n class PsiTurkStandardTests(PsiturkUnitTest):", "file_path": "files/2023_1/114", "file_language": "py", "file_name": "tests/test_psiturk.py", "outdated_file_modify": 0, "outdated_file_before": 0, "outdated_file_after": 0, "llm_check": 0, "static_check": 0, "static": {"rats": [false, []], "semgrep": [false, []]}, "target": 0, "function_before": [{"function": "class FlaskTestClientProxy(object):\n    \"\"\"Spoof user agent (Chrome)\"\"\"\n\n    def __init__(self, app):\n        self.app = app\n\n    def __call__(self, environ, start_response):\n        environ['REMOTE_ADDR'] = environ.get('REMOTE_ADDR', fake.ipv4())\n        environ['HTTP_USER_AGENT'] = 'Mozilla/5.0 (Macintosh; Intel Mac OS X\\\n            10_9_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1944.0\\\n            Safari/537.36'\n        return self.app(environ, start_response)", "target": 0}, {"function": "class BadFlaskTestClientProxy(object):\n    \"\"\"Spoof user agent (iPad)\"\"\"\n\n    def __init__(self, app):\n        self.app = app\n\n    def __call__(self, environ, start_response):\n        environ['REMOTE_ADDR'] = environ.get('REMOTE_ADDR', fake.ipv4())\n        environ['HTTP_USER_AGENT'] = 'Mozilla/5.0 (iPad; U; CPU OS 3_2 like \\\n            Mac OS X; en-us) AppleWebKit/531.21.10 (KHTML, like Gecko) \\\n            Version/4.0.4 Mobile/7B334b Safari/531.21.10'\n        return self.app(environ, start_response)", "target": 0}, {"function": "class PsiturkUnitTest(unittest.TestCase):\n\n    def setUp(self, case=None):\n        \"\"\"Build up fixtures\"\"\"\n        import psiturk.experiment\n        reload(psiturk.experiment)\n\n        psiturk.experiment.app.wsgi_app = FlaskTestClientProxy(\n            psiturk.experiment.app.wsgi_app)\n        self.app = psiturk.experiment.app.test_client()\n        self.config = psiturk.experiment.CONFIG\n\n        # Fake MTurk data\n        self.worker_id = fake.md5(raw_output=False)\n        self.hit_id = fake.md5(raw_output=False)\n        self.assignment_id = fake.md5(raw_output=False)\n\n    def tearDown(self):\n        \"\"\"Tear down fixtures\"\"\"\n        self.app = None\n\n    def set_config(self, section, field, value):\n        self.config.parent.set(self.config, section, field, str(value))", "target": 0}, {"function": "def test_custom_get_condition_can_import(mocker, psiturk_test_client):\n    # pytest.set_trace()\n    # import psiturk.experiment\n    import sys\n    sys.path.append(os.getcwd())\n    import custom\n    reload(custom)\n    mocker.patch.object(custom, 'custom_get_condition', lambda mode: (9, 9), create=True)\n    app = psiturk_test_client()\n\n    from psiturk.experiment import get_condition\n    assert get_condition('') == (9, 9)", "target": 0}, {"function": "def test_custom_get_condition_not_necessary(tmpdir, mocker, psiturk_test_client):\n    import sys\n    sys.path.append(os.getcwd())\n    import custom\n    reload(custom)\n    app = psiturk_test_client()\n\n    from psiturk.experiment import get_condition\n    assert get_condition('') == (0, 0)", "target": 0}, {"function": "def test_missing_template_exception(edit_config_file, remove_template, psiturk_test_client):\n    remove_template('closepopup.html')\n    with pytest.raises(RuntimeError):\n        app = psiturk_test_client()", "target": 0}, {"function": "def test_notmissing_template(edit_config_file, remove_template, psiturk_test_client):\n    psiturk_test_client()", "target": 0}, {"function": "def test_does_not_die_if_no_custompy(remove_file, psiturk_test_client):\n    remove_file('custom.py')\n    psiturk_test_client()", "target": 0}, {"function": "def test_insert_mode(psiturk_test_client):\n    with open('templates/ad.html', 'r') as temp_file:\n        ad_string = temp_file.read()\n\n    from psiturk.experiment import insert_mode\n    insert_mode(ad_string, 'debug')", "target": 0}, {"function": "class PsiTurkStandardTests(PsiturkUnitTest):\n\n    # Test experiment.py\n    # ==================\n\n    def test_default_page(self):\n        \"\"\"Test that root page works.\"\"\"\n        rv = self.app.get('/')\n        response = rv.get_data(as_text=True)\n        # print(os.getcwd())\n        # with open('server.log','r') as infile:\n        # print(file.read())\n        assert ('Welcome to psiTurk!' in response)\n\n    def test_exp_debug_no_url_vars(self):\n        \"\"\"Test that exp page throws Error #1003 with no url vars.\"\"\"\n        rv = self.app.get('/exp')\n        assert u'<b>Error</b>: 1003' in rv.get_data(as_text=True)\n\n    def test_ad_no_url_vars(self):\n        \"\"\"Test that ad page throws Error #1001 with no url vars.\"\"\"\n        rv = self.app.get('/ad')\n        assert u'<b>Error</b>: 1001' in rv.get_data(as_text=True)\n\n    def test_ad_with_all_urls(self):\n        \"\"\"Test that ad page throws Error #1003 with no url vars.\"\"\"\n        args = '&'.join([\n            'assignmentId=debug%s' % self.assignment_id,\n            'workerId=debug%s' % self.worker_id,\n            'hitId=debug%s' % self.hit_id,\n            'mode=sandbox'])\n        rv = self.app.get('/ad?%s' % args)\n        assert 'Thank you for accepting this HIT!' in rv.get_data(as_text=True)\n\n    @pytest.mark.skip('psiturk api server is slow for this test')\n    def test_exp_with_all_url_vars_not_registered_on_ad_server(self):\n        \"\"\"Test that exp page throws Error #1018 with all url vars but not registered.\"\"\"\n        self.set_config('Shell Parameters', 'use_psiturk_ad_server', 'true')\n        args = '&'.join([\n            'assignmentId=debug%s' % self.assignment_id,\n            'workerId=debug%s' % self.worker_id,\n            'hitId=debug%s' % self.hit_id,\n            'mode=sandbox'])\n        rv = self.app.get('/exp?%s' % args)\n        assert '<b>Error</b>: 1018' in rv.get_data(as_text=True)\n\n    def test_sync_put(self):\n        request = \"&\".join([\n            \"assignmentId=debug%s\" % self.assignment_id,\n            \"workerId=debug%s\" % self.worker_id,\n            \"hitId=debug%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n\n        # try putting the sync, simulating a Backbone PUT payload\n        uniqueid = \"debug%s:debug%s\" % (self.worker_id, self.assignment_id)\n        payload = {\n            \"condition\": 5,\n            \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id,\n            \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id,\n            \"currenttrial\": 2,\n            \"bonus\": 0,\n            \"data\": [\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 0,\n                    \"dateTime\": 1564425799481,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"begin\"\n                    }\n                }, {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 1,\n                    \"dateTime\": 1564425802158,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"submit\"\n                    }\n                }\n            ],\n            \"questiondata\": {\n                \"engagement\": \"5\",\n                \"difficulty\": \"5\"\n            },\n            \"eventdata\": [\n                {\n                    \"eventtype\": \"initialized\",\n                    \"value\": '',\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }, {\n                    \"eventtype\": \"window_resize\",\n                    \"value\": [933, 708],\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }\n            ],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"\n        }\n        rv = self.app.put('/sync/%s' % uniqueid, json=payload)\n        status = json.loads(rv.get_data(as_text=True)).get(\"status\", \"\")\n        assert status == \"user data saved\"\n\n    def test_sync_get(self):\n        self.assignment_id = \"debug%s\" % self.assignment_id\n        self.worker_id = \"debug%s\" % self.worker_id\n        self.hit_id = \"debug%s\" % self.hit_id\n\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n\n        # save data with sync PUT\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        condition = 0\n        counterbalance = 0\n        bonus = 0.0\n        payload = {\n            \"condition\": condition,\n            \"counterbalance\": counterbalance,\n            \"assignmentId\": self.assignment_id,\n            \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id,\n            \"currenttrial\": 2,\n            \"bonus\": bonus,\n            \"data\": [\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 0,\n                    \"dateTime\": 1564425799481,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"begin\"\n                    }\n                },\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 1,\n                    \"dateTime\": 1564425802158,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"submit\"\n                    }\n                }\n            ],\n            \"questiondata\": {\n                \"engagement\": \"5\",\n                \"difficulty\": \"5\"\n            },\n            \"eventdata\": [\n                {\n                    \"eventtype\": \"initialized\",\n                    \"value\": '',\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                },\n                {\n                    \"eventtype\": \"window_resize\",\n                    \"value\": [933, 708],\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }\n            ],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"\n        }\n        rv = self.app.put('/sync/%s' % uniqueid, json=payload)\n\n        # get data with sync GET\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        rv = self.app.get('/sync/%s' % uniqueid)\n\n        response = json.loads(rv.get_data(as_text=True))\n        assert response.get(\"assignmentId\", \"\") == \"%s\" % self.assignment_id\n        assert response.get(\"workerId\", \"\") == \"%s\" % self.worker_id\n        assert response.get(\"hitId\", \"\") == \"%s\" % self.hit_id\n        assert response.get(\"condition\", None) == condition\n        assert response.get(\"counterbalance\", None) == counterbalance\n        assert response.get(\"bonus\", None) == bonus\n\n    def test_favicon(self):\n        \"\"\"Test that favicon loads.\"\"\"\n        rv = self.app.get('/favicon.ico')\n        assert rv.status_code == 200\n\n    def test_complete_experiment(self):\n        \"\"\"Test that a participant can start and finish the experiment.\"\"\"\n        request = \"&\".join([\n            \"assignmentId=debug%s\" % self.assignment_id,\n            \"workerId=debug%s\" % self.worker_id,\n            \"hitId=debug%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # complete experiment\n        uniqueid = \"debug%s:debug%s\" % (self.worker_id, self.assignment_id)\n        mode = 'debug'\n        rv = self.app.get('/complete?uniqueId=%s&mode=%s' % (uniqueid, mode))\n        assert rv.status_code == 200\n\n    def test_repeat_experiment_fail(self):\n        \"\"\"Test that a participant cannot repeat the experiment.\"\"\"\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # save data with sync PUT\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        payload = {\n            \"condition\": 5, \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id,\n            \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id,\n            \"currenttrial\": 2,\n            \"bonus\": 0,\n            \"data\": [\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 0,\n                    \"dateTime\": 1564425799481,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"begin\"\n                    }\n                },\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 1,\n                    \"dateTime\": 1564425802158,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"submit\"\n                    }\n                }\n            ],\n            \"questiondata\": {\n                \"engagement\": \"5\",\n                \"difficulty\": \"5\"\n            },\n            \"eventdata\": [\n                {\n                    \"eventtype\": \"initialized\",\n                    \"value\": '',\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                },\n                {\n                    \"eventtype\": \"window_resize\",\n                    \"value\": [933, 708],\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }\n            ],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"\n        }\n        rv = self.app.put('/sync/%s' % uniqueid, json={\n            \"condition\": 5,\n            \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id,\n            \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id,\n            \"currenttrial\": 2,\n            \"bonus\": 0, \"data\": [\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 0,\n                    \"dateTime\": 1564425799481,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"begin\"\n                    }\n                },\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 1,\n                    \"dateTime\": 1564425802158,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"submit\"\n                    }\n                }\n            ],\n            \"questiondata\": {\n                \"engagement\": \"5\",\n                \"difficulty\": \"5\"\n            },\n            \"eventdata\": [\n                {\n                    \"eventtype\": \"initialized\", \"value\": '',\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                },\n                {\n                    \"eventtype\": \"window_resize\",\n                    \"value\": [933, 708],\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }\n            ],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"\n        })\n        assert rv.status_code == 200\n\n        # complete experiment\n        mode = 'debug'\n        rv = self.app.get('/complete?uniqueId=%s&mode=%s' % (uniqueid, mode))\n        assert rv.status_code == 200\n\n        # choose new assignment and hit ids\n        self.assignment_id = fake.md5(raw_output=False)\n        self.hit_id = fake.md5(raw_output=False)\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert ': 1010' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert ': 1010' in rv.get_data(as_text=True)\n\n    def test_repeat_experiment_success(self):\n        \"\"\"Test that a participant can repeat the experiment.\"\"\"\n        self.set_config(u'Task Parameters', u'allow_repeats', u'true')\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # save data with sync PUT\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        payload = {\n            \"condition\": 5, \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id, \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id, \"currenttrial\": 2, \"bonus\": 0, \"data\": [\n                {\"uniqueid\": uniqueid, \"current_trial\": 0, \"dateTime\": 1564425799481,\n                 \"trialdata\": {\"phase\": \"postquestionnaire\", \"status\": \"begin\"}},\n                {\"uniqueid\": uniqueid, \"current_trial\": 1, \"dateTime\": 1564425802158,\n                 \"trialdata\": {\"phase\": \"postquestionnaire\", \"status\": \"submit\"}}],\n            \"questiondata\": {\"engagement\": \"5\", \"difficulty\": \"5\"}, \"eventdata\": [\n                {\"eventtype\": \"initialized\", \"value\": '', \"timestamp\": 1564425799139,\n                 \"interval\": 0},\n                {\"eventtype\": \"window_resize\", \"value\": [933, 708], \"timestamp\": 1564425799139,\n                 \"interval\": 0}],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"}\n        rv = self.app.put('/sync/%s' % uniqueid, json=payload)\n        assert rv.status_code == 200\n\n        # complete experiment\n        mode = 'debug'\n        rv = self.app.get('/complete?uniqueId=%s&mode=%s' % (uniqueid, mode))\n        assert rv.status_code == 200\n\n        # choose new assignment and hit ids\n        self.assignment_id = fake.md5(raw_output=False)\n        self.hit_id = fake.md5(raw_output=False)\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # make sure they are not blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1010' not in rv.get_data(as_text=True)\n\n        # make sure they are not blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1010' not in rv.get_data(as_text=True)\n\n        # save data with sync PUT\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        payload = payload = {\n            \"condition\": 5, \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id, \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id, \"currenttrial\": 2, \"bonus\": 0, \"data\": [\n                {\"uniqueid\": uniqueid, \"current_trial\": 0, \"dateTime\": 1564425799481,\n                 \"trialdata\": {\"phase\": \"postquestionnaire\", \"status\": \"begin\"}},\n                {\"uniqueid\": uniqueid, \"current_trial\": 1, \"dateTime\": 1564425802158,\n                 \"trialdata\": {\"phase\": \"postquestionnaire\", \"status\": \"submit\"}}],\n            \"questiondata\": {\"engagement\": \"5\", \"difficulty\": \"5\"}, \"eventdata\": [\n                {\"eventtype\": \"initialized\", \"value\": '', \"timestamp\": 1564425799139,\n                 \"interval\": 0},\n                {\"eventtype\": \"window_resize\", \"value\": [933, 708], \"timestamp\": 1564425799139,\n                 \"interval\": 0}],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"}\n        rv = self.app.put('/sync/%s' % uniqueid, json=payload)\n        assert rv.status_code == 200\n\n        # complete experiment\n        mode = 'debug'\n        rv = self.app.get('/complete?uniqueId=%s&mode=%s' % (uniqueid, mode))\n        assert rv.status_code == 200\n\n    def test_repeat_experiment_quit(self):\n        \"\"\"Test that a participant cannot restart the experiment.\"\"\"\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # put the in the experiment\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        rv = self.app.post(\"/inexp\", data=dict(uniqueId=uniqueid))\n        assert rv.status_code == 200\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1009' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1008' in rv.get_data(as_text=True)\n\n        # have them quit the experiment\n        rv = self.app.post(\"/quitter\", data=dict(uniqueId=uniqueid))\n        assert rv.status_code == 200\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1009' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1008' in rv.get_data(as_text=True)\n\n    def test_repeat_experiment_quit_allow_repeats(self):\n        \"\"\"Test that a participant cannot restart the experiment, even when repeats are allowed.\"\"\"\n        self.set_config(u'Task Parameters', u'allow_repeats', u'true')\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # put the in the experiment\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        rv = self.app.post(\"/inexp\", data=dict(uniqueId=uniqueid))\n        assert rv.status_code == 200\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1009' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1008' in rv.get_data(as_text=True)\n\n        # have them quit the experiment\n        rv = self.app.post(\"/quitter\", data=dict(uniqueId=uniqueid))\n        assert rv.status_code == 200\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1009' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1008' in rv.get_data(as_text=True)", "target": 0}, {"function": "class BadUserAgent(PsiturkUnitTest):\n    \"\"\"Setup test blocked user agent (iPad/tablets)\"\"\"\n\n    def setUp(self):\n        \"\"\"Build up fixtures\"\"\"\n        import psiturk.experiment\n        reload(psiturk.experiment)\n\n        psiturk.experiment.app.wsgi_app = BadFlaskTestClientProxy(\n            psiturk.experiment.app.wsgi_app)\n        self.app = psiturk.experiment.app.test_client()\n\n        # Fake MTurk data\n        self.worker_id = fake.md5(raw_output=False)\n        self.hit_id = fake.md5(raw_output=False)\n        self.assignment_id = fake.md5(raw_output=False)\n\n    def test_ad_with_bad_user_agent(self):\n        \"\"\"Test that ad page throws Error when user agent is blocked.\"\"\"\n        rv = self.app.get(\n            '/ad' + '?assignmentId=debug' + self.assignment_id + '&workerId=debug' +\n            self.worker_id + '&hitId=debug' + self.hit_id + '&mode=sandbox'\n        )\n        assert '<b>Error</b>: 1014' in rv.get_data(as_text=True)", "target": 0}, {"function": "class PsiTurkTestPsiturkJS(PsiturkUnitTest):\n    \"\"\" Setup test for missing psiturk.js file. \"\"\"\n\n    def setUp(self):\n        \"\"\"Build up fixtures\"\"\"\n        self.PSITURK_JS_FILE = '../psiturk/psiturk_js/psiturk.js'\n        os.rename(self.PSITURK_JS_FILE, self.PSITURK_JS_FILE + '.bup')\n        import psiturk.experiment\n        reload(psiturk.experiment)\n\n        psiturk.experiment.app.wsgi_app = FlaskTestClientProxy(\n            psiturk.experiment.app.wsgi_app)\n        self.app = psiturk.experiment.app.test_client()\n\n    @pytest.mark.skip('soemthing about the testing env is making this not work well')\n    def test_psiturk_js_is_missing(self):\n        \"\"\" Test for missing psiturk.js \"\"\"\n        rv = self.app.get('static/js/psiturk.js')\n        assert 'file not found' in rv.get_data(as_text=True)\n\n    def tearDown(self):\n        \"\"\"Tear down fixtures\"\"\"\n        super(PsiTurkTestPsiturkJS, self).tearDown()\n        os.rename(self.PSITURK_JS_FILE + '.bup', self.PSITURK_JS_FILE)", "target": 0}, {"function": "class ExperimentErrorsTest(PsiturkUnitTest):\n\n    def test_experiment_errors(self):\n        \"\"\"Make sure every error has a description\"\"\"\n        error_cls = psiturk.experiment_errors.ExperimentError\n\n        for error_name in error_cls.experiment_errors:\n            assert error_name in error_cls.error_descriptions\n\n        for error_name in error_cls.error_descriptions:\n            assert error_name in error_cls.experiment_errors", "target": 0}], "function_after": [{"function": "class FlaskTestClientProxy(object):\n    \"\"\"Spoof user agent (Chrome)\"\"\"\n\n    def __init__(self, app):\n        self.app = app\n\n    def __call__(self, environ, start_response):\n        environ['REMOTE_ADDR'] = environ.get('REMOTE_ADDR', fake.ipv4())\n        environ['HTTP_USER_AGENT'] = 'Mozilla/5.0 (Macintosh; Intel Mac OS X\\\n            10_9_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/36.0.1944.0\\\n            Safari/537.36'\n        return self.app(environ, start_response)", "target": 0}, {"function": "class BadFlaskTestClientProxy(object):\n    \"\"\"Spoof user agent (iPad)\"\"\"\n\n    def __init__(self, app):\n        self.app = app\n\n    def __call__(self, environ, start_response):\n        environ['REMOTE_ADDR'] = environ.get('REMOTE_ADDR', fake.ipv4())\n        environ['HTTP_USER_AGENT'] = 'Mozilla/5.0 (iPad; U; CPU OS 3_2 like \\\n            Mac OS X; en-us) AppleWebKit/531.21.10 (KHTML, like Gecko) \\\n            Version/4.0.4 Mobile/7B334b Safari/531.21.10'\n        return self.app(environ, start_response)", "target": 0}, {"function": "class PsiturkUnitTest(unittest.TestCase):\n\n    def setUp(self, case=None):\n        \"\"\"Build up fixtures\"\"\"\n        import psiturk.experiment\n        reload(psiturk.experiment)\n\n        psiturk.experiment.app.wsgi_app = FlaskTestClientProxy(\n            psiturk.experiment.app.wsgi_app)\n        self.app = psiturk.experiment.app.test_client()\n        self.config = psiturk.experiment.CONFIG\n\n        # Fake MTurk data\n        self.worker_id = fake.md5(raw_output=False)\n        self.hit_id = fake.md5(raw_output=False)\n        self.assignment_id = fake.md5(raw_output=False)\n\n    def tearDown(self):\n        \"\"\"Tear down fixtures\"\"\"\n        self.app = None\n\n    def set_config(self, section, field, value):\n        self.config.parent.set(self.config, section, field, str(value))", "target": 0}, {"function": "def test_custom_get_condition_can_import(mocker, psiturk_test_client):\n    # pytest.set_trace()\n    # import psiturk.experiment\n    import sys\n    sys.path.append(os.getcwd())\n    import custom\n    reload(custom)\n    mocker.patch.object(custom, 'custom_get_condition', lambda mode: (9, 9), create=True)\n    app = psiturk_test_client()\n\n    from psiturk.experiment import get_condition\n    assert get_condition('') == (9, 9)", "target": 0}, {"function": "def test_custom_get_condition_not_necessary(tmpdir, mocker, psiturk_test_client):\n    import sys\n    sys.path.append(os.getcwd())\n    import custom\n    reload(custom)\n    app = psiturk_test_client()\n\n    from psiturk.experiment import get_condition\n    assert get_condition('') == (0, 0)", "target": 0}, {"function": "def test_missing_template_exception(edit_config_file, remove_template, psiturk_test_client):\n    remove_template('closepopup.html')\n    with pytest.raises(RuntimeError):\n        app = psiturk_test_client()", "target": 0}, {"function": "def test_notmissing_template(edit_config_file, remove_template, psiturk_test_client):\n    psiturk_test_client()", "target": 0}, {"function": "def test_does_not_die_if_no_custompy(remove_file, psiturk_test_client):\n    remove_file('custom.py')\n    psiturk_test_client()", "target": 0}, {"function": "def test_insert_mode(psiturk_test_client):\n    with open('templates/ad.html', 'r') as temp_file:\n        ad_string = temp_file.read()\n\n    from psiturk.experiment import insert_mode\n    insert_mode(ad_string)", "target": 0}, {"function": "class PsiTurkStandardTests(PsiturkUnitTest):\n\n    # Test experiment.py\n    # ==================\n\n    def test_default_page(self):\n        \"\"\"Test that root page works.\"\"\"\n        rv = self.app.get('/')\n        response = rv.get_data(as_text=True)\n        # print(os.getcwd())\n        # with open('server.log','r') as infile:\n        # print(file.read())\n        assert ('Welcome to psiTurk!' in response)\n\n    def test_exp_debug_no_url_vars(self):\n        \"\"\"Test that exp page throws Error #1003 with no url vars.\"\"\"\n        rv = self.app.get('/exp')\n        assert u'<b>Error</b>: 1003' in rv.get_data(as_text=True)\n\n    def test_ad_no_url_vars(self):\n        \"\"\"Test that ad page throws Error #1001 with no url vars.\"\"\"\n        rv = self.app.get('/ad')\n        assert u'<b>Error</b>: 1001' in rv.get_data(as_text=True)\n\n    def test_ad_with_all_urls(self):\n        \"\"\"Test that ad page throws Error #1003 with no url vars.\"\"\"\n        args = '&'.join([\n            'assignmentId=debug%s' % self.assignment_id,\n            'workerId=debug%s' % self.worker_id,\n            'hitId=debug%s' % self.hit_id,\n            'mode=sandbox'])\n        rv = self.app.get('/ad?%s' % args)\n        assert 'Thank you for accepting this HIT!' in rv.get_data(as_text=True)\n\n    @pytest.mark.skip('psiturk api server is slow for this test')\n    def test_exp_with_all_url_vars_not_registered_on_ad_server(self):\n        \"\"\"Test that exp page throws Error #1018 with all url vars but not registered.\"\"\"\n        self.set_config('Shell Parameters', 'use_psiturk_ad_server', 'true')\n        args = '&'.join([\n            'assignmentId=debug%s' % self.assignment_id,\n            'workerId=debug%s' % self.worker_id,\n            'hitId=debug%s' % self.hit_id,\n            'mode=sandbox'])\n        rv = self.app.get('/exp?%s' % args)\n        assert '<b>Error</b>: 1018' in rv.get_data(as_text=True)\n\n    def test_sync_put(self):\n        request = \"&\".join([\n            \"assignmentId=debug%s\" % self.assignment_id,\n            \"workerId=debug%s\" % self.worker_id,\n            \"hitId=debug%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n\n        # try putting the sync, simulating a Backbone PUT payload\n        uniqueid = \"debug%s:debug%s\" % (self.worker_id, self.assignment_id)\n        payload = {\n            \"condition\": 5,\n            \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id,\n            \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id,\n            \"currenttrial\": 2,\n            \"bonus\": 0,\n            \"data\": [\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 0,\n                    \"dateTime\": 1564425799481,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"begin\"\n                    }\n                }, {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 1,\n                    \"dateTime\": 1564425802158,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"submit\"\n                    }\n                }\n            ],\n            \"questiondata\": {\n                \"engagement\": \"5\",\n                \"difficulty\": \"5\"\n            },\n            \"eventdata\": [\n                {\n                    \"eventtype\": \"initialized\",\n                    \"value\": '',\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }, {\n                    \"eventtype\": \"window_resize\",\n                    \"value\": [933, 708],\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }\n            ],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"\n        }\n        rv = self.app.put('/sync/%s' % uniqueid, json=payload)\n        status = json.loads(rv.get_data(as_text=True)).get(\"status\", \"\")\n        assert status == \"user data saved\"\n\n    def test_sync_get(self):\n        self.assignment_id = \"debug%s\" % self.assignment_id\n        self.worker_id = \"debug%s\" % self.worker_id\n        self.hit_id = \"debug%s\" % self.hit_id\n\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n\n        # save data with sync PUT\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        condition = 0\n        counterbalance = 0\n        bonus = 0.0\n        payload = {\n            \"condition\": condition,\n            \"counterbalance\": counterbalance,\n            \"assignmentId\": self.assignment_id,\n            \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id,\n            \"currenttrial\": 2,\n            \"bonus\": bonus,\n            \"data\": [\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 0,\n                    \"dateTime\": 1564425799481,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"begin\"\n                    }\n                },\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 1,\n                    \"dateTime\": 1564425802158,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"submit\"\n                    }\n                }\n            ],\n            \"questiondata\": {\n                \"engagement\": \"5\",\n                \"difficulty\": \"5\"\n            },\n            \"eventdata\": [\n                {\n                    \"eventtype\": \"initialized\",\n                    \"value\": '',\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                },\n                {\n                    \"eventtype\": \"window_resize\",\n                    \"value\": [933, 708],\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }\n            ],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"\n        }\n        rv = self.app.put('/sync/%s' % uniqueid, json=payload)\n\n        # get data with sync GET\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        rv = self.app.get('/sync/%s' % uniqueid)\n\n        response = json.loads(rv.get_data(as_text=True))\n        assert response.get(\"assignmentId\", \"\") == \"%s\" % self.assignment_id\n        assert response.get(\"workerId\", \"\") == \"%s\" % self.worker_id\n        assert response.get(\"hitId\", \"\") == \"%s\" % self.hit_id\n        assert response.get(\"condition\", None) == condition\n        assert response.get(\"counterbalance\", None) == counterbalance\n        assert response.get(\"bonus\", None) == bonus\n\n    def test_favicon(self):\n        \"\"\"Test that favicon loads.\"\"\"\n        rv = self.app.get('/favicon.ico')\n        assert rv.status_code == 200\n\n    def test_complete_experiment(self):\n        \"\"\"Test that a participant can start and finish the experiment.\"\"\"\n        request = \"&\".join([\n            \"assignmentId=debug%s\" % self.assignment_id,\n            \"workerId=debug%s\" % self.worker_id,\n            \"hitId=debug%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # complete experiment\n        uniqueid = \"debug%s:debug%s\" % (self.worker_id, self.assignment_id)\n        mode = 'debug'\n        rv = self.app.get('/complete?uniqueId=%s&mode=%s' % (uniqueid, mode))\n        assert rv.status_code == 200\n\n    def test_repeat_experiment_fail(self):\n        \"\"\"Test that a participant cannot repeat the experiment.\"\"\"\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # save data with sync PUT\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        payload = {\n            \"condition\": 5, \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id,\n            \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id,\n            \"currenttrial\": 2,\n            \"bonus\": 0,\n            \"data\": [\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 0,\n                    \"dateTime\": 1564425799481,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"begin\"\n                    }\n                },\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 1,\n                    \"dateTime\": 1564425802158,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"submit\"\n                    }\n                }\n            ],\n            \"questiondata\": {\n                \"engagement\": \"5\",\n                \"difficulty\": \"5\"\n            },\n            \"eventdata\": [\n                {\n                    \"eventtype\": \"initialized\",\n                    \"value\": '',\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                },\n                {\n                    \"eventtype\": \"window_resize\",\n                    \"value\": [933, 708],\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }\n            ],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"\n        }\n        rv = self.app.put('/sync/%s' % uniqueid, json={\n            \"condition\": 5,\n            \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id,\n            \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id,\n            \"currenttrial\": 2,\n            \"bonus\": 0, \"data\": [\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 0,\n                    \"dateTime\": 1564425799481,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"begin\"\n                    }\n                },\n                {\n                    \"uniqueid\": uniqueid,\n                    \"current_trial\": 1,\n                    \"dateTime\": 1564425802158,\n                    \"trialdata\": {\n                        \"phase\": \"postquestionnaire\",\n                        \"status\": \"submit\"\n                    }\n                }\n            ],\n            \"questiondata\": {\n                \"engagement\": \"5\",\n                \"difficulty\": \"5\"\n            },\n            \"eventdata\": [\n                {\n                    \"eventtype\": \"initialized\", \"value\": '',\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                },\n                {\n                    \"eventtype\": \"window_resize\",\n                    \"value\": [933, 708],\n                    \"timestamp\": 1564425799139,\n                    \"interval\": 0\n                }\n            ],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"\n        })\n        assert rv.status_code == 200\n\n        # complete experiment\n        mode = 'debug'\n        rv = self.app.get('/complete?uniqueId=%s&mode=%s' % (uniqueid, mode))\n        assert rv.status_code == 200\n\n        # choose new assignment and hit ids\n        self.assignment_id = fake.md5(raw_output=False)\n        self.hit_id = fake.md5(raw_output=False)\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert ': 1010' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert ': 1010' in rv.get_data(as_text=True)\n\n    def test_repeat_experiment_success(self):\n        \"\"\"Test that a participant can repeat the experiment.\"\"\"\n        self.set_config(u'Task Parameters', u'allow_repeats', u'true')\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # save data with sync PUT\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        payload = {\n            \"condition\": 5, \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id, \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id, \"currenttrial\": 2, \"bonus\": 0, \"data\": [\n                {\"uniqueid\": uniqueid, \"current_trial\": 0, \"dateTime\": 1564425799481,\n                 \"trialdata\": {\"phase\": \"postquestionnaire\", \"status\": \"begin\"}},\n                {\"uniqueid\": uniqueid, \"current_trial\": 1, \"dateTime\": 1564425802158,\n                 \"trialdata\": {\"phase\": \"postquestionnaire\", \"status\": \"submit\"}}],\n            \"questiondata\": {\"engagement\": \"5\", \"difficulty\": \"5\"}, \"eventdata\": [\n                {\"eventtype\": \"initialized\", \"value\": '', \"timestamp\": 1564425799139,\n                 \"interval\": 0},\n                {\"eventtype\": \"window_resize\", \"value\": [933, 708], \"timestamp\": 1564425799139,\n                 \"interval\": 0}],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"}\n        rv = self.app.put('/sync/%s' % uniqueid, json=payload)\n        assert rv.status_code == 200\n\n        # complete experiment\n        mode = 'debug'\n        rv = self.app.get('/complete?uniqueId=%s&mode=%s' % (uniqueid, mode))\n        assert rv.status_code == 200\n\n        # choose new assignment and hit ids\n        self.assignment_id = fake.md5(raw_output=False)\n        self.hit_id = fake.md5(raw_output=False)\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # make sure they are not blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1010' not in rv.get_data(as_text=True)\n\n        # make sure they are not blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1010' not in rv.get_data(as_text=True)\n\n        # save data with sync PUT\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        payload = payload = {\n            \"condition\": 5, \"counterbalance\": 0,\n            \"assignmentId\": self.assignment_id, \"workerId\": self.worker_id,\n            \"hitId\": self.hit_id, \"currenttrial\": 2, \"bonus\": 0, \"data\": [\n                {\"uniqueid\": uniqueid, \"current_trial\": 0, \"dateTime\": 1564425799481,\n                 \"trialdata\": {\"phase\": \"postquestionnaire\", \"status\": \"begin\"}},\n                {\"uniqueid\": uniqueid, \"current_trial\": 1, \"dateTime\": 1564425802158,\n                 \"trialdata\": {\"phase\": \"postquestionnaire\", \"status\": \"submit\"}}],\n            \"questiondata\": {\"engagement\": \"5\", \"difficulty\": \"5\"}, \"eventdata\": [\n                {\"eventtype\": \"initialized\", \"value\": '', \"timestamp\": 1564425799139,\n                 \"interval\": 0},\n                {\"eventtype\": \"window_resize\", \"value\": [933, 708], \"timestamp\": 1564425799139,\n                 \"interval\": 0}],\n            \"useragent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.142 Safari/537.36\",\n            \"mode\": \"debug\"}\n        rv = self.app.put('/sync/%s' % uniqueid, json=payload)\n        assert rv.status_code == 200\n\n        # complete experiment\n        mode = 'debug'\n        rv = self.app.get('/complete?uniqueId=%s&mode=%s' % (uniqueid, mode))\n        assert rv.status_code == 200\n\n    def test_repeat_experiment_quit(self):\n        \"\"\"Test that a participant cannot restart the experiment.\"\"\"\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # put the in the experiment\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        rv = self.app.post(\"/inexp\", data=dict(uniqueId=uniqueid))\n        assert rv.status_code == 200\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1009' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1008' in rv.get_data(as_text=True)\n\n        # have them quit the experiment\n        rv = self.app.post(\"/quitter\", data=dict(uniqueId=uniqueid))\n        assert rv.status_code == 200\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1009' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1008' in rv.get_data(as_text=True)\n\n    def test_repeat_experiment_quit_allow_repeats(self):\n        \"\"\"Test that a participant cannot restart the experiment, even when repeats are allowed.\"\"\"\n        self.set_config(u'Task Parameters', u'allow_repeats', u'true')\n        request = \"&\".join([\n            \"assignmentId=%s\" % self.assignment_id,\n            \"workerId=%s\" % self.worker_id,\n            \"hitId=%s\" % self.hit_id,\n            \"mode=debug\"])\n\n        # put the user in the database\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n\n        # put the in the experiment\n        uniqueid = \"%s:%s\" % (self.worker_id, self.assignment_id)\n        rv = self.app.post(\"/inexp\", data=dict(uniqueId=uniqueid))\n        assert rv.status_code == 200\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1009' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1008' in rv.get_data(as_text=True)\n\n        # have them quit the experiment\n        rv = self.app.post(\"/quitter\", data=dict(uniqueId=uniqueid))\n        assert rv.status_code == 200\n\n        # make sure they are blocked on the ad page\n        rv = self.app.get('/ad?%s' % request)\n        assert rv.status_code == 200\n        assert ': 1009' in rv.get_data(as_text=True)\n\n        # make sure they are blocked on the experiment page\n        rv = self.app.get(\"/exp?%s\" % request)\n        assert rv.status_code == 200\n        assert ': 1008' in rv.get_data(as_text=True)", "target": 0}, {"function": "class BadUserAgent(PsiturkUnitTest):\n    \"\"\"Setup test blocked user agent (iPad/tablets)\"\"\"\n\n    def setUp(self):\n        \"\"\"Build up fixtures\"\"\"\n        import psiturk.experiment\n        reload(psiturk.experiment)\n\n        psiturk.experiment.app.wsgi_app = BadFlaskTestClientProxy(\n            psiturk.experiment.app.wsgi_app)\n        self.app = psiturk.experiment.app.test_client()\n\n        # Fake MTurk data\n        self.worker_id = fake.md5(raw_output=False)\n        self.hit_id = fake.md5(raw_output=False)\n        self.assignment_id = fake.md5(raw_output=False)\n\n    def test_ad_with_bad_user_agent(self):\n        \"\"\"Test that ad page throws Error when user agent is blocked.\"\"\"\n        rv = self.app.get(\n            '/ad' + '?assignmentId=debug' + self.assignment_id + '&workerId=debug' +\n            self.worker_id + '&hitId=debug' + self.hit_id + '&mode=sandbox'\n        )\n        assert '<b>Error</b>: 1014' in rv.get_data(as_text=True)", "target": 0}, {"function": "class PsiTurkTestPsiturkJS(PsiturkUnitTest):\n    \"\"\" Setup test for missing psiturk.js file. \"\"\"\n\n    def setUp(self):\n        \"\"\"Build up fixtures\"\"\"\n        self.PSITURK_JS_FILE = '../psiturk/psiturk_js/psiturk.js'\n        os.rename(self.PSITURK_JS_FILE, self.PSITURK_JS_FILE + '.bup')\n        import psiturk.experiment\n        reload(psiturk.experiment)\n\n        psiturk.experiment.app.wsgi_app = FlaskTestClientProxy(\n            psiturk.experiment.app.wsgi_app)\n        self.app = psiturk.experiment.app.test_client()\n\n    @pytest.mark.skip('soemthing about the testing env is making this not work well')\n    def test_psiturk_js_is_missing(self):\n        \"\"\" Test for missing psiturk.js \"\"\"\n        rv = self.app.get('static/js/psiturk.js')\n        assert 'file not found' in rv.get_data(as_text=True)\n\n    def tearDown(self):\n        \"\"\"Tear down fixtures\"\"\"\n        super(PsiTurkTestPsiturkJS, self).tearDown()\n        os.rename(self.PSITURK_JS_FILE + '.bup', self.PSITURK_JS_FILE)", "target": 0}, {"function": "class ExperimentErrorsTest(PsiturkUnitTest):\n\n    def test_experiment_errors(self):\n        \"\"\"Make sure every error has a description\"\"\"\n        error_cls = psiturk.experiment_errors.ExperimentError\n\n        for error_name in error_cls.experiment_errors:\n            assert error_name in error_cls.error_descriptions\n\n        for error_name in error_cls.error_descriptions:\n            assert error_name in error_cls.experiment_errors", "target": 0}]}], "outdated": 0, "cwe_descripiton": "", "cwe_consequence": "", "cwe_method": "", "cwe_solution": ""}
