{"index": 4784, "cve_id": "CVE-2020-7698", "cwe_id": ["CWE-74"], "cve_language": "Python", "cve_description": "This affects the package Gerapy from 0 and before 0.9.3. The input being passed to Popen, via the project_configure endpoint, isn\u2019t being sanitized.", "cvss": "9.8", "publish_date": "July 29, 2020", "AV": "NETWORK", "AC": "NETWORK", "PR": "NONE", "UI": "NONE", "S": "UNCHANGED", "C": "HIGH", "I": "HIGH", "A": "HIGH", "commit_id": "e8446605eb2424717418eae199ec7aad573da2d2", "commit_message": "to b1", "commit_date": "2020-07-06T14:57:10Z", "project": "gerapy/gerapy", "url": "https://api.github.com/repos/Gerapy/Gerapy/commits/e8446605eb2424717418eae199ec7aad573da2d2", "html_url": "https://github.com/Gerapy/Gerapy/commit/e8446605eb2424717418eae199ec7aad573da2d2", "windows_before": [{"commit_id": "4cfd5f3cfab504ac922deda8d95126c66961d6f6", "commit_date": "Sun Jun 21 01:21:20 2020 +0800", "commit_message": "Bump websocket-extensions from 0.1.3 to 0.1.4 in /gerapy/client (#152)", "files_name": ["gerapy/client/package-lock.json"]}, {"commit_id": "c7b2917816a95de88128a9e5cbc826581531eca0", "commit_date": "Sun Jun 21 01:21:11 2020 +0800", "commit_message": "Bump django from 1.11.28 to 1.11.29 (#151)", "files_name": ["requirements.txt"]}, {"commit_id": "197177ab58422f7437df7efe35373de7ee076866", "commit_date": "Sun Jun 21 01:21:02 2020 +0800", "commit_message": "Bump jquery from 3.4.1 to 3.5.0 in /gerapy/client (#148)", "files_name": ["gerapy/client/package-lock.json", "gerapy/client/package.json"]}, {"commit_id": "51444fd1a78a35d05ab152f4775e819d4375151c", "commit_date": "Mon Apr 13 13:03:15 2020 +0800", "commit_message": "Update README.md", "files_name": ["README.md"]}, {"commit_id": "cf9f215b8cd91e5276594405581e968e4683a419", "commit_date": "Mon Apr 13 13:02:43 2020 +0800", "commit_message": "Update README.md", "files_name": ["README.md"]}, {"commit_id": "ea5ea37ea32d25e15d4884e72fd60441ea599938", "commit_date": "Thu Mar 5 20:19:38 2020 +0800", "commit_message": "Update README.md", "files_name": ["README.md"]}, {"commit_id": "4af9b8ed5044f5401fb5e0f74eb99b56857855c6", "commit_date": "Wed Feb 12 13:20:18 2020 +0800", "commit_message": "Merge pull request #139 from Gerapy/dependabot/pip/django-1.11.28", "files_name": ["4ec02a4b4f487386c6b54b5cea87a1587a653d27 - Tue Feb 11 22:00:49 2020 +0000 : Bump django from 1.11.27 to 1.11.28", "requirements.txt"]}, {"commit_id": "0f2595cd39a5f1035d2ad5ffabd33188aaa7e2a2", "commit_date": "Wed Feb 12 02:00:58 2020 +0800", "commit_message": "Update README.md", "files_name": ["README.md"]}, {"commit_id": "e6cb2bafe4dd3829e31d1383fee4fa3025b96f7a", "commit_date": "Tue Feb 11 03:08:20 2020 +0800", "commit_message": "Merge branch 'master' of github.com:Gerapy/Gerapy", "files_name": ["f5a4670a3671b82b23682b4d79a8862262c9930a - Tue Feb 11 03:07:30 2020 +0800 : update version", "gerapy/__version__.py", "gerapy/settings.py", "gerapy/spiders/crawl.py"]}, {"commit_id": "98e4b9bcd4939af0cdc79e80c85477764e8456ca", "commit_date": "Thu Jan 30 10:39:38 2020 +0800", "commit_message": "Merge pull request #129 from cielpy/fix_docker_cmd", "files_name": ["8421138a814ee6e3a2ae3dd486564892928f3379 - Wed Jan 29 11:03:39 2020 +0800 : Update requirements.txt", "requirements.txt"]}, {"commit_id": "ed65e864b4bcd60143751aedb5274ed8eb0f8c41", "commit_date": "Sun Dec 22 17:48:39 2019 +0800", "commit_message": "fix incorrect docker build command", "files_name": ["docker/README.md"]}, {"commit_id": "97384914dec9bad049c7df5b1919a3762a725ab2", "commit_date": "Wed Dec 4 02:29:56 2019 +0800", "commit_message": "update docs", "files_name": ["docs/en/source/usage.md", "docs/zh_cn/source/usage.md"]}, {"commit_id": "35c778c45ddeb7db9f4981837aa55f780b472cee", "commit_date": "Tue Dec 3 09:27:41 2019 +0800", "commit_message": "change upload style", "files_name": ["gerapy/client/src/views/project/Index.vue"]}, {"commit_id": "113d21c68381aac6bc3a3c39220e50323199dfeb", "commit_date": "Mon Dec 2 21:38:36 2019 +0800", "commit_message": "build", "files_name": ["gerapy/__version__.py", "gerapy/server/core/templates/index.html", "gerapy/server/core/templates/static/css/chunk-23154d75.5d8f4617.css", "gerapy/server/core/templates/static/css/chunk-39423506.15941b6d.css", "gerapy/server/core/templates/static/css/chunk-39423506.15941b6d.css.map", "gerapy/server/core/templates/static/css/chunk-39423506.61bb00e0.css", "gerapy/server/core/templates/static/css/chunk-39423506.61bb00e0.css.map", "gerapy/server/core/templates/static/css/chunk-612d9832.ee49a942.css", "gerapy/server/core/templates/static/css/chunk-612d9832.ee49a942.css.map", "gerapy/server/core/templates/static/css/chunk-736ea204.347b1790.css", "gerapy/server/core/templates/static/css/chunk-736ea204.347b1790.css.map", "gerapy/server/core/templates/static/js/app.65f12732.js", "gerapy/server/core/templates/static/js/app.65f12732.js.map", "gerapy/server/core/templates/static/js/app.747409e0.js", "gerapy/server/core/templates/static/js/app.747409e0.js.map", "gerapy/server/core/templates/static/js/chunk-193b04f2.6fedc7d2.js", "gerapy/server/core/templates/static/js/chunk-193b04f2.6fedc7d2.js.map", "gerapy/server/core/templates/static/js/chunk-193b04f2.d27fe87e.js.map", "gerapy/server/core/templates/static/js/chunk-23154d75.90dc6602.js", "gerapy/server/core/templates/static/js/chunk-23154d75.90dc6602.js.map", "gerapy/server/core/templates/static/js/chunk-2d0a3191.84665408.js", "gerapy/server/core/templates/static/js/chunk-2d0a3191.84665408.js.map", "gerapy/server/core/templates/static/js/chunk-2d0a3191.b4157d11.js.map", "gerapy/server/core/templates/static/js/chunk-2d0e450e.28b276c5.js", "gerapy/server/core/templates/static/js/chunk-2d0e450e.28b276c5.js.map", "gerapy/server/core/templates/static/js/chunk-2d0e450e.b1c42466.js", "gerapy/server/core/templates/static/js/chunk-2d0e450e.b1c42466.js.map", "gerapy/server/core/templates/static/js/chunk-39423506.91209505.js", "gerapy/server/core/templates/static/js/chunk-39423506.91209505.js.map", "gerapy/server/core/templates/static/js/chunk-55d598d5.3b16e059.js", "gerapy/server/core/templates/static/js/chunk-55d598d5.3b16e059.js.map", "gerapy/server/core/templates/static/js/chunk-612d9832.9dde355d.js", "gerapy/server/core/templates/static/js/chunk-612d9832.9dde355d.js.map", "gerapy/server/core/templates/static/js/chunk-736ea204.2f07cc85.js", "gerapy/server/core/templates/static/js/chunk-736ea204.2f07cc85.js.map", "gerapy/server/core/templates/static/js/chunk-vendors.2a0f4af0.js", "gerapy/server/core/templates/static/js/chunk-vendors.2a0f4af0.js.map", "gerapy/server/core/templates/static/js/chunk-vendors.b39c50b5.js.map"]}, {"commit_id": "7ba28d638a773d20fcaab943f04bd624ab1d6b31", "commit_date": "Mon Dec 2 21:36:37 2019 +0800", "commit_message": "change version", "files_name": ["gerapy/__version__.py"]}, {"commit_id": "5ed7fcc06e5c9ff7e7fbf37a1d36133113e14282", "commit_date": "Mon Dec 2 21:34:50 2019 +0800", "commit_message": "Merge branch 'dev'", "files_name": ["95cd7f6a155df38719c7614cceaedb72261cbbbc - Mon Dec 2 21:33:25 2019 +0800 : add upload and clone", "gerapy/client/src/langs/en.js", "gerapy/client/src/langs/zh.js", "gerapy/client/src/main.js", "gerapy/client/src/store.js", "gerapy/client/src/views/client/Create.vue", "gerapy/client/src/views/project/Index.vue", "gerapy/client/src/views/task/Create.vue", "gerapy/client/src/views/task/Edit.vue", "gerapy/client/src/views/task/Substance.vue", "gerapy/server/core/urls.py", "gerapy/server/core/views.py"]}, {"commit_id": "cb59b924a5be2b38230c4438513995feed30ee5b", "commit_date": "Mon Dec 2 19:23:51 2019 +0800", "commit_message": "rm space", "files_name": ["docs/en/source/contributing.md"]}, {"commit_id": "6db46f86e10b672f7eecd509d7aeee03ef593f00", "commit_date": "Mon Dec 2 19:22:53 2019 +0800", "commit_message": "update contributing docs", "files_name": ["docs/zh_cn/source/contributing.md"]}, {"commit_id": "6a56d8366cae0177087bca6166887fa79821b573", "commit_date": "Mon Dec 2 19:15:47 2019 +0800", "commit_message": "update readme", "files_name": ["docs/README.md", "docs/en/source/contributing.md", "docs/requirements.txt", "docs/zh_cn/source/contributing.md"]}, {"commit_id": "fd50ab9f4ba8d9557e2984d509185a8fbefe7a4a", "commit_date": "Mon Dec 2 09:57:04 2019 +0800", "commit_message": "Merge branch 'master' of github.com:Gerapy/Gerapy", "files_name": ["64bdf2381861e39706f4c4ae279caee1612f75db - Mon Dec 2 09:56:44 2019 +0800 : fix scheduler bug and add time shortcuts", "gerapy/client/src/langs/en.js", "gerapy/client/src/langs/zh.js", "gerapy/client/src/views/task/Status.vue", "gerapy/client/src/views/task/Substance.vue", "gerapy/cmd/__init__.py", "gerapy/server/core/scheduler.py", "gerapy/server/core/views.py", "gerapy/server/server/settings.py"]}, {"commit_id": "ca91c340dd07cfcea0ca9bdad98c10578e1d9030", "commit_date": "Sun Dec 1 18:03:18 2019 +0800", "commit_message": "Update build.yml", "files_name": [".github/workflows/build.yml"]}, {"commit_id": "9b0f86f1ec95bc440c04cc2c1da0ebeb92daa5b8", "commit_date": "Sun Dec 1 18:02:12 2019 +0800", "commit_message": "Update build.yml", "files_name": [".github/workflows/build.yml"]}, {"commit_id": "1711ef50f62f604f816243f073d3f79be3cd3ce2", "commit_date": "Sun Dec 1 17:55:43 2019 +0800", "commit_message": "Update build.yml", "files_name": [".github/workflows/build.yml"]}, {"commit_id": "18ed58be0f3add040f669aa83a34581337c59d53", "commit_date": "Tue Nov 26 14:57:03 2019 +0800", "commit_message": "Merge branch 'master' of github.com:Gerapy/Gerapy", "files_name": ["969abb2e4b6562a0495c9fa1651074f4d5ff1b5b - Tue Nov 26 14:56:45 2019 +0800 : change blog", "docs/en/source/conf.py", "docs/en/source/maintainers.md"]}, {"commit_id": "6aeb057b77d604c55b45d69d7f2e6364d24125af", "commit_date": "Tue Nov 26 02:07:50 2019 +0800", "commit_message": "Update README.md", "files_name": ["README.md"]}, {"commit_id": "3c4665585bb670db03ccb660fc9e68270cb4f120", "commit_date": "Tue Nov 26 01:54:35 2019 +0800", "commit_message": "Update build_docker_image_release.yml", "files_name": [".github/workflows/build_docker_image_release.yml"]}, {"commit_id": "2a14b1a33174e79373a67fb5bef4c6e3d3733f96", "commit_date": "Tue Nov 26 01:53:19 2019 +0800", "commit_message": "Merge branch 'master' of github.com:Gerapy/Gerapy", "files_name": ["07cd1521dff938b8c25176cf197779357ac70afa - Tue Nov 26 01:52:31 2019 +0800 : new version", "gerapy/__version__.py"]}, {"commit_id": "6cc38c18d0085c4df502d378d93cc76afac8e928", "commit_date": "Tue Nov 26 01:51:58 2019 +0800", "commit_message": "Update build_docker_image_release.yml", "files_name": [".github/workflows/build_docker_image_release.yml"]}, {"commit_id": "da57173ad0b9f1fe730ec662822dd42086d20f9a", "commit_date": "Tue Nov 26 01:50:47 2019 +0800", "commit_message": "Update build.yml", "files_name": [".github/workflows/build.yml"]}, {"commit_id": "31142dfff88894bbeac419e77b962167acf52f36", "commit_date": "Tue Nov 26 01:47:26 2019 +0800", "commit_message": "Merge branch 'master' of github.com:Gerapy/Gerapy", "files_name": ["9a3fb758ebc29db42db515956a2edbbb1b0fb0a7 - Tue Nov 26 01:45:13 2019 +0800 : update 092rc1", "gerapy/__version__.py", "gerapy/server/core/views.py", "setup.py"]}, {"commit_id": "250f50b34e5b859d532b7a24bee0c0ca9e249e3d", "commit_date": "Tue Nov 26 01:37:32 2019 +0800", "commit_message": "Update README.md", "files_name": ["README.md"]}, {"commit_id": "b7686c1458253450cfdd77eff41342076cf7ee13", "commit_date": "Tue Nov 26 01:36:38 2019 +0800", "commit_message": "Merge branch 'master' of github.com:Gerapy/Gerapy", "files_name": ["2b97496c248e9c5d16399c9154c6646bd35ee382 - Tue Nov 26 01:36:14 2019 +0800 : update pymongo", "requirements.txt"]}, {"commit_id": "2d6edaec7eb628bc02ffae4e4a322791729c4d99", "commit_date": "Tue Nov 26 01:31:49 2019 +0800", "commit_message": "Update and rename update_docs.yml to sync_docs.yml", "files_name": [".github/workflows/sync_docs.yml"]}, {"commit_id": "34d061b710f0b2d43aafaab3dc4798da0247f16c", "commit_date": "Tue Nov 26 01:31:26 2019 +0800", "commit_message": "Update build_docker_image_release.yml", "files_name": [".github/workflows/build_docker_image_release.yml"]}, {"commit_id": "39d106163248f5c0c5fc781f849aeed6183d5078", "commit_date": "Tue Nov 26 01:31:01 2019 +0800", "commit_message": "Update build_docker_image_master.yml", "files_name": [".github/workflows/build_docker_image_master.yml"]}, {"commit_id": "fc496ac498a67654e3db56bf51d17246bfc3eaeb", "commit_date": "Tue Nov 26 01:30:12 2019 +0800", "commit_message": "Update and rename test_gerapy.yml to build.yml", "files_name": [".github/workflows/build.yml"]}, {"commit_id": "64eae3e8e35dcc01c35f491cec8e794a90a972ad", "commit_date": "Tue Nov 26 01:27:11 2019 +0800", "commit_message": "Update README.md", "files_name": ["README.md"]}, {"commit_id": "0fd983e0fc4f129101a858c680ae35b492d3dbf7", "commit_date": "Tue Nov 26 01:26:45 2019 +0800", "commit_message": "Update README.md", "files_name": ["README.md"]}, {"commit_id": "36d049de725536fad92ecfc18dbb989be0cbdf24", "commit_date": "Tue Nov 26 01:04:43 2019 +0800", "commit_message": "Update test_gerapy.yml", "files_name": [".github/workflows/test_gerapy.yml"]}, {"commit_id": "b0103d2e6650e576c982cb28366ab9936e7c9c4b", "commit_date": "Tue Nov 26 00:57:27 2019 +0800", "commit_message": "Rename updatedocs.yml to update_docs.yml", "files_name": [".github/workflows/update_docs.yml"]}, {"commit_id": "7316bc9af9c6248f6ef5fef0ad629042ad45328f", "commit_date": "Tue Nov 26 00:57:06 2019 +0800", "commit_message": "Rename testgerapy.yml to test_gerapy.yml", "files_name": []}], "windows_after": [{"commit_id": "aa5cb1581ebc763810e238d80efa46128c66f5f5", "commit_date": "Mon Jul 6 23:13:08 2020 +0800", "commit_message": "to 093", "files_name": ["gerapy/__version__.py"]}, {"commit_id": "d2dfc04ccb91b51c63a9b7e219121b5c5d04f7e1", "commit_date": "Mon Jul 6 23:24:32 2020 +0800", "commit_message": "update docs", "files_name": ["docs/en/source/conf.py", "docs/zh_cn/source/conf.py"]}, {"commit_id": "c411b870fac7572601152703737e01e1faac6085", "commit_date": "Tue Jul 21 09:42:06 2020 +0800", "commit_message": "Bump lodash from 4.17.15 to 4.17.19 in /gerapy/client (#156)", "files_name": ["gerapy/client/package-lock.json"]}, {"commit_id": "888d9fd3b56a472d8d26545886b052ba74636d01", "commit_date": "Sat Aug 8 10:45:09 2020 +0800", "commit_message": "add verification of setupy.py", "files_name": ["gerapy/client/package-lock.json", "gerapy/server/core/build.py"]}, {"commit_id": "ac38a1e559c9560e30285866d98d91a201e6ab57", "commit_date": "Sat Aug 8 10:45:22 2020 +0800", "commit_message": "Merge branch 'master' of github.com:Gerapy/Gerapy", "files_name": ["690e39f0e96c3f37ae678a2edcd2e43334c1017b - Sat Aug 8 11:01:08 2020 +0800 : Bump elliptic from 6.5.0 to 6.5.3 in /gerapy/client (#158)", "gerapy/client/package-lock.json"]}, {"commit_id": "26a572f37bc0c775ab967ec905fce69781207ee1", "commit_date": "Sat Aug 8 11:02:14 2020 +0800", "commit_message": "to 094", "files_name": ["gerapy/__version__.py", "requirements.txt"]}, {"commit_id": "c73453010accbad6fc52824eae5ed982f41476d7", "commit_date": "Sat Aug 8 11:02:26 2020 +0800", "commit_message": "Merge branch 'master' of github.com:Gerapy/Gerapy", "files_name": ["5d18c9ec14b1ded57389cdcfcb109c4417327fd7 - Sat Aug 8 11:10:29 2020 +0800 : update", "requirements.txt"]}, {"commit_id": "410b0ad38836ffdada93f106fd456e1e088b6459", "commit_date": "Sat Aug 8 11:12:43 2020 +0800", "commit_message": "update", "files_name": ["gerapy/__version__.py"]}, {"commit_id": "9fb97a4b8a58e6dcab191d771bfeeb1a06489f5d", "commit_date": "Wed Aug 26 22:49:35 2020 +0800", "commit_message": "fix bug in build.py (#166)", "files_name": ["gerapy/server/core/build.py"]}, {"commit_id": "d20ccadabf2fbbc516d463c30fafd5ddf45151e3", "commit_date": "Wed Aug 26 22:52:50 2020 +0800", "commit_message": "fix upload bug", "files_name": ["gerapy/__version__.py"]}, {"commit_id": "b0cf4961d0947aa6cb37287bbeb8ccb7b2ddbca3", "commit_date": "Thu Aug 27 13:23:36 2020 +0800", "commit_message": "to 096", "files_name": ["gerapy/__version__.py"]}, {"commit_id": "c58f083263aa023859febb1129b6251a6b1144a7", "commit_date": "Sun Sep 13 17:12:12 2020 +0800", "commit_message": "Bump http-proxy from 1.17.0 to 1.18.1 in /gerapy/client (#169)", "files_name": ["gerapy/client/package-lock.json"]}, {"commit_id": "0595afbd5900e572f04062a5579b4dd1cf4ad3f6", "commit_date": "Sun Sep 13 17:12:22 2020 +0800", "commit_message": "Bump node-sass from 4.12.0 to 4.13.1 in /gerapy/client (#167)", "files_name": ["gerapy/client/package-lock.json", "gerapy/client/package.json"]}, {"commit_id": "2d74d1564a52f0e5e4b3a606b51a40336f786e93", "commit_date": "Sun Mar 14 02:18:51 2021 +0800", "commit_message": "Bump elliptic from 6.5.3 to 6.5.4 in /gerapy/client (#185)", "files_name": ["gerapy/client/package-lock.json"]}, {"commit_id": "846e9330ea4804183c60718857f534e67e992a49", "commit_date": "Sun Mar 14 02:18:59 2021 +0800", "commit_message": "Bump axios from 0.19.0 to 0.21.1 in /gerapy/client (#179)", "files_name": ["gerapy/client/package-lock.json", "gerapy/client/package.json"]}, {"commit_id": "05f3ca66c4dbbf07bdda6f24c37ab122f9827dc0", "commit_date": "Sun Mar 14 02:19:07 2021 +0800", "commit_message": "Bump highlight.js from 9.15.10 to 9.18.5 in /gerapy/client (#174)", "files_name": ["gerapy/client/package-lock.json"]}, {"commit_id": "2bccb63bd03cc374a267c314aab5c71951de71af", "commit_date": "Sun Mar 21 15:25:23 2021 +0800", "commit_message": "Bump djangorestframework from 3.9.2 to 3.11.2 (#189)", "files_name": ["requirements.txt"]}, {"commit_id": "af5657354aa040d5a6b52c91a837f5d63422d6d3", "commit_date": "Sun Mar 21 15:25:31 2021 +0800", "commit_message": "Bump jinja2 from 2.10.1 to 2.11.3 (#188)", "files_name": ["requirements.txt"]}, {"commit_id": "f8a918d701ef582bad9d68c2bd51e47cf42c0e81", "commit_date": "Wed May 19 22:05:07 2021 +0800", "commit_message": "Bump codemirror from 5.48.4 to 5.61.0 in /gerapy/client (#196)", "files_name": ["gerapy/client/package-lock.json"]}, {"commit_id": "7f91865810208baf0324453b7c95d83575cc7c3e", "commit_date": "Wed May 19 22:05:16 2021 +0800", "commit_message": "Bump hosted-git-info from 2.8.4 to 2.8.9 in /gerapy/client (#195)", "files_name": ["gerapy/client/package-lock.json"]}, {"commit_id": "106dafe8758cc2ae1e026b7bccbe72433db49ead", "commit_date": "Wed May 19 22:05:24 2021 +0800", "commit_message": "Bump url-parse from 1.4.7 to 1.5.1 in /gerapy/client (#192)", "files_name": ["gerapy/client/package-lock.json"]}, {"commit_id": "463ca122935727feb1901915621f03f6b0868d1f", "commit_date": "Wed May 19 22:05:33 2021 +0800", "commit_message": "Bump y18n from 3.2.1 to 3.2.2 in /gerapy/client (#190)", "files_name": ["gerapy/client/package-lock.json"]}, {"commit_id": "af32685083d661270c66eb491b9456786dd7193b", "commit_date": "Wed May 19 22:05:41 2021 +0800", "commit_message": "Bump lodash from 4.17.19 to 4.17.21 in /gerapy/client (#194)", "files_name": ["gerapy/client/package-lock.json"]}, {"commit_id": "9dc4a96d82fb518f91fa12bbcd0b68bf582b7603", "commit_date": "Thu May 27 00:45:36 2021 +0800", "commit_message": "Bump browserslist from 4.6.6 to 4.16.6 in /gerapy/client (#198)", "files_name": ["gerapy/client/package-lock.json"]}, {"commit_id": "5b472bc28b7ab472e1e317aa1ba70dabe9ff6501", "commit_date": "Sat May 29 01:40:44 2021 +0800", "commit_message": "Bump dns-packet from 1.3.1 to 1.3.4 in /gerapy/client (#199)", "files_name": ["gerapy/client/package-lock.json"]}, {"commit_id": "03d10984984286a12616db1f2ae85550460cdded", "commit_date": "Mon Jul 26 02:33:27 2021 +0800", "commit_message": "Bump django from 1.11.29 to 2.2.24 (#201)", "files_name": ["requirements.txt"]}, {"commit_id": "8c2e776787e50419dfe937d487ff2df257af11c5", "commit_date": "Mon Jul 26 02:33:36 2021 +0800", "commit_message": "Bump ws from 6.2.1 to 6.2.2 in /gerapy/client (#200)", "files_name": ["gerapy/client/package-lock.json"]}, {"commit_id": "47e5a242ac2561d2fe7fa0df9c0401edb690c351", "commit_date": "Mon Jul 26 02:34:36 2021 +0800", "commit_message": "Bump color-string from 1.5.3 to 1.6.0 in /gerapy/client (#204)", "files_name": ["gerapy/client/package-lock.json"]}, {"commit_id": "2a181adca8cfaaed8cdc88b22af2835cda19d04b", "commit_date": "Sun Aug 1 01:05:36 2021 +0800", "commit_message": "update build", "files_name": ["gerapy/client/babel.config.js", "gerapy/client/package-lock.json", "gerapy/client/public/index.html", "gerapy/client/src/App.vue", "gerapy/client/src/assets/scss/components/_animation.scss", "gerapy/client/src/assets/scss/components/_base.scss", "gerapy/client/src/assets/scss/components/_editor.scss", "gerapy/client/src/assets/scss/components/_layout.scss", "gerapy/client/src/assets/scss/components/_pm.scss", "gerapy/client/src/assets/scss/components/_reset.scss", "gerapy/client/src/assets/scss/components/_scroll-bar.scss", "gerapy/client/src/assets/scss/components/_start_loading.scss", "gerapy/client/src/assets/scss/element.scss", "gerapy/client/src/assets/scss/main.scss", "gerapy/client/src/components/BottomBar.vue", "gerapy/client/src/components/CodeEditor.vue", "gerapy/client/src/components/Footer.vue", "gerapy/client/src/components/Header.vue", "gerapy/client/src/components/LangSwitch.vue", "gerapy/client/src/components/Left.vue", "gerapy/client/src/components/PanelTitle.vue", "gerapy/client/src/components/User.vue", "gerapy/client/src/components/Wrapper.vue", "gerapy/client/src/http.js", "gerapy/client/src/main.js", "gerapy/client/src/router.js", "gerapy/client/src/store.js", "gerapy/client/src/views/client/Create.vue", "gerapy/client/src/views/client/Edit.vue", "gerapy/client/src/views/client/Index.vue", "gerapy/client/src/views/client/Schedule.vue", "gerapy/client/src/views/home/Index.vue", "gerapy/client/src/views/login/Login.vue", "gerapy/client/src/views/project/Browser.vue", "gerapy/client/src/views/project/Configure.vue", "gerapy/client/src/views/project/Cookies.vue", "gerapy/client/src/views/project/Deploy.vue", "gerapy/client/src/views/project/Edit.vue", "gerapy/client/src/views/project/Extractor.vue", "gerapy/client/src/views/project/Extractors.vue", "gerapy/client/src/views/project/Index.vue", "gerapy/client/src/views/project/Item.vue", "gerapy/client/src/views/project/Mongodb.vue", "gerapy/client/src/views/project/Mysql.vue", "gerapy/client/src/views/project/Parser.vue", "gerapy/client/src/views/project/Proxy.vue", "gerapy/client/src/views/project/Rule.vue", "gerapy/client/src/views/project/Rules.vue", "gerapy/client/src/views/project/Spider.vue", "gerapy/client/src/views/project/Storage.vue", "gerapy/client/src/views/project/Web.vue", "gerapy/client/src/views/task/Create.vue", "gerapy/client/src/views/task/Edit.vue", "gerapy/client/src/views/task/Index.vue", "gerapy/client/src/views/task/Status.vue", "gerapy/client/src/views/task/Substance.vue", "gerapy/client/vue.config.js", "gerapy/server/core/parser.py", "gerapy/server/core/templates/index.html", "gerapy/server/core/templates/static/css/app.5805a989.css", "gerapy/server/core/templates/static/css/app.5805a989.css.map", "gerapy/server/core/templates/static/css/app.eb291bc8.css", "gerapy/server/core/templates/static/css/app.eb291bc8.css.map", "gerapy/server/core/templates/static/css/chunk-10b2edc2.79f68610.css", "gerapy/server/core/templates/static/css/chunk-10b2edc2.79f68610.css.map", "gerapy/server/core/templates/static/css/chunk-12e7e66d.8f856d8c.css", "gerapy/server/core/templates/static/css/chunk-12e7e66d.8f856d8c.css.map", "gerapy/server/core/templates/static/css/chunk-12e7e66d.94b672e1.css.map", "gerapy/server/core/templates/static/css/chunk-39423506.15941b6d.css.map", "gerapy/server/core/templates/static/css/chunk-39423506.2eb0fec8.css", "gerapy/server/core/templates/static/css/chunk-39423506.2eb0fec8.css.map", "gerapy/server/core/templates/static/css/chunk-3a6102b3.0fe5e5eb.css", "gerapy/server/core/templates/static/css/chunk-3a6102b3.0fe5e5eb.css.map", "gerapy/server/core/templates/static/css/chunk-3a6102b3.46e1b93d.css", "gerapy/server/core/templates/static/css/chunk-3a6102b3.46e1b93d.css.map", "gerapy/server/core/templates/static/css/chunk-4a7237a2.19df386b.css", "gerapy/server/core/templates/static/css/chunk-4a7237a2.19df386b.css.map", "gerapy/server/core/templates/static/css/chunk-4a7237a2.32bdda61.css", "gerapy/server/core/templates/static/css/chunk-4a7237a2.32bdda61.css.map", "gerapy/server/core/templates/static/css/chunk-531d1845.b0b0d9e4.css", "gerapy/server/core/templates/static/css/chunk-531d1845.b0b0d9e4.css.map", "gerapy/server/core/templates/static/css/chunk-582dc9b0.d60b5161.css", "gerapy/server/core/templates/static/css/chunk-582dc9b0.d60b5161.css.map", "gerapy/server/core/templates/static/css/chunk-5cb4de70.1fdb3cbd.css", "gerapy/server/core/templates/static/css/chunk-5cb4de70.1fdb3cbd.css.map", "gerapy/server/core/templates/static/css/chunk-5cd9d886.212b12ed.css.map", "gerapy/server/core/templates/static/css/chunk-5cd9d886.3dbe65b9.css", "gerapy/server/core/templates/static/css/chunk-5cd9d886.3dbe65b9.css.map", "gerapy/server/core/templates/static/css/chunk-612d9832.ee49a942.css", "gerapy/server/core/templates/static/css/chunk-612d9832.ee49a942.css.map", "gerapy/server/core/templates/static/css/chunk-6a3bce8f.ca9c0275.css.map", "gerapy/server/core/templates/static/css/chunk-736ea204.347b1790.css", "gerapy/server/core/templates/static/css/chunk-736ea204.347b1790.css.map", "gerapy/server/core/templates/static/css/chunk-736ea204.b9207071.css", "gerapy/server/core/templates/static/css/chunk-736ea204.b9207071.css.map", "gerapy/server/core/templates/static/css/chunk-74cc1e94.47f3c0a9.css.map", "gerapy/server/core/templates/static/css/chunk-74cc1e94.c8be3c1c.css", "gerapy/server/core/templates/static/css/chunk-74cc1e94.c8be3c1c.css.map", "gerapy/server/core/templates/static/css/chunk-vendors.8f471f8e.css", "gerapy/server/core/templates/static/css/chunk-vendors.8f471f8e.css.map", "gerapy/server/core/templates/static/js/app.21167fa2.js", "gerapy/server/core/templates/static/js/app.21167fa2.js.map"]}], "parents": [{"commit_id_before": "4cfd5f3cfab504ac922deda8d95126c66961d6f6", "url_before": "https://api.github.com/repos/Gerapy/Gerapy/commits/4cfd5f3cfab504ac922deda8d95126c66961d6f6", "html_url_before": "https://github.com/Gerapy/Gerapy/commit/4cfd5f3cfab504ac922deda8d95126c66961d6f6"}], "details": [{"raw_url": "https://github.com/Gerapy/Gerapy/raw/e8446605eb2424717418eae199ec7aad573da2d2/README.md", "code": "# Gerapy\n\n![Build](https://github.com/Gerapy/Gerapy/workflows/build/badge.svg)\n![Read the Docs](https://img.shields.io/readthedocs/gerapy)\n![PyPI - Python Version](https://img.shields.io/badge/python-3.6%2B-blue)\n[![GitHub stars](https://img.shields.io/github/stars/Gerapy/Gerapy)](https://github.com/Gerapy/Gerapy/stargazers)\n![PyPI - Downloads](https://img.shields.io/pypi/dm/gerapy)\n![Docker Pulls](https://img.shields.io/docker/pulls/germey/gerapy)\n![PyPI - License](https://img.shields.io/pypi/l/gerapy)\n\nDistributed Crawler Management Framework Based on Scrapy, Scrapyd, Scrapyd-Client, Scrapyd-API, Django and Vue.js.\n\n## Documentation\n\nDocumentation is available online at [https://docs.gerapy.com/](https://docs.gerapy.com/) and [https://github.com/Gerapy/Docs](https://github.com/Gerapy/Docs).\n\n## Support\n\nGerapy is developed based on Python 3.x. Python 2.x may be supported later.\n\n## Usage\n\nInstall Gerapy by pip:\n\n```bash\npip3 install gerapy\n```\n\nAfter the installation, you need to do these things below to run Gerapy server:\n\nIf you have installed Gerapy successfully, you can use command `gerapy`. If not, check the installation.\n\nFirst use this command to initialize the workspace:\n\n```bash\ngerapy init\n```\n\nNow you will get a folder named `gerapy`. Also you can specify the name of your workspace by this command:\n\n```\ngerapy init <workspace>\n```\n\nThen `cd` to this folder, and run this command to initialize the Database:\n\n```bash\ncd gerapy\ngerapy migrate\n```\n\nNext you need to create a superuser by this command:\n\n```\ngerapy createsuperuser\n```\n\nThen you can runserver by this command:\n\n```bash\ngerapy runserver\n```\n\nThen you can visit [http://localhost:8000](http://localhost:8000) to enjoy it. Also you can vist [http://localhost:8000/admin](http://localhost:8000/admin) to get the admin management backend.\n\nIf you want to run Gerapy in public, just run like this:\n\n```\ngerapy runserver 0.0.0.0:8000\n```\n\nThen it will run with public host and port 8000.\n\nIn Gerapy, You can create a configurable project and then configure and generate code of Scrapy automatically. But this module is unstable, we're trying to refine it.\n\nAlso you can drag your Scrapy Project to `projects` folder. Then refresh web, it will appear in the Project Index Page and comes to un-configurable, but you can edit this project through the web page.\n\nAs for deployment, you can move to Deploy Page. Firstly you need to build your project and add client in the Client Index Page, then you can deploy the project just by clicking button.\n\nAfter the deployment, you can manage the job in Monitor Page.\n\n## Docker\n\nJust run this command:\n\n```\ndocker run -d -v ~/gerapy:/app/gerapy -p 8000:8000 germey/gerapy\n```\n\nThen it will run at port 8000. You can use the temp admin account (username: admin, password: admin) to login. And please change the password later for safety.\n\nCommand Usage:\n\n```\ndocker run -d -v <workspace>:/app/gerapy -p <public_port>:<container_port> germey/gerapy\n```\n\nPlease specify your workspace to mount Gerapy workspace by `-v <workspace>:/app/gerapy` and specify server port by `-p <public_port>:<container_port>`.\n\nIf you run Gerapy by Docker, you can visit Gerapy website such as [http://localhost:8000](http://localhost:8000) and enjoy it, no need to do other initialzation things.\n\n## TodoList\n\n- [x] Add Visual Configuration of Spider with Previewing Website\n- [x] Add Scrapyd Auth Management\n- [x] Add Gerapy Auth Management\n- [x] Add Timed Task Scheduler\n- [ ] Add Visual Configuration of Scrapy\n- [ ] Add Intelligent Analysis of Web Page\n\n## Communication\n\nIf you have any questions or ideas, you can send [Issues](https://github.com/Gerapy/Gerapy/issues) or [Pull Requests](https://github.com/Gerapy/Gerapy/pulls), your suggestions are really import for us, thanks for your contirbution.\n", "code_before": "# Gerapy\n\n![Build](https://github.com/Gerapy/Gerapy/workflows/build/badge.svg)\n![Read the Docs](https://img.shields.io/readthedocs/gerapy)\n![PyPI - Python Version](https://img.shields.io/badge/python-3.6%2B-blue)\n[![GitHub stars](https://img.shields.io/github/stars/Gerapy/Gerapy)](https://github.com/Gerapy/Gerapy/stargazers)\n![PyPI - Downloads](https://img.shields.io/pypi/dm/gerapy)\n![Docker Pulls](https://img.shields.io/docker/pulls/germey/gerapy)\n![PyPI - License](https://img.shields.io/pypi/l/gerapy)\n\n\n> \u6ce8\uff1a\u4ece Gerapy 2.x \u5f00\u59cb\uff0c\u5176\u5b9a\u4f4d\u53d1\u751f\u6539\u53d8\uff0c\u4e0d\u518d\u652f\u6301 Scrapyd\uff0c\u8f6c\u800c\u652f\u6301 Docker\u3001Kubernetes \u7684\u90e8\u7f72\uff0c\u53e6\u5916\u5f00\u53d1\u8fd8\u4f1a\u8fc1\u79fb\u5230 Scrapy \u53ef\u89c6\u5316\u914d\u7f6e\u548c\u667a\u80fd\u89e3\u6790\u65b9\u9762\uff0c\u656c\u8bf7\u671f\u5f85\u3002\n\nDistributed Crawler Management Framework Based on Scrapy, Scrapyd, Scrapyd-Client, Scrapyd-API, Django and Vue.js.\n\n## Documentation\n\nDocumentation is available online at [https://docs.gerapy.com/](https://docs.gerapy.com/) and [https://github.com/Gerapy/Docs](https://github.com/Gerapy/Docs).\n\n## Support\n\nGerapy is developed based on Python 3.x. Python 2.x may be supported later.\n\n## Usage\n\nInstall Gerapy by pip:\n\n```bash\npip3 install gerapy\n```\n\nAfter the installation, you need to do these things below to run Gerapy server:\n\nIf you have installed Gerapy successfully, you can use command `gerapy`. If not, check the installation.\n\nFirst use this command to initialize the workspace:\n\n```bash\ngerapy init\n```\n\nNow you will get a folder named `gerapy`. Also you can specify the name of your workspace by this command:\n\n```\ngerapy init <workspace>\n```\n\nThen `cd` to this folder, and run this command to initialize the Database:\n\n```bash\ncd gerapy\ngerapy migrate\n```\n\nNext you need to create a superuser by this command:\n\n```\ngerapy createsuperuser\n```\n\nThen you can runserver by this command:\n\n```bash\ngerapy runserver\n```\n\nThen you can visit [http://localhost:8000](http://localhost:8000) to enjoy it. Also you can vist [http://localhost:8000/admin](http://localhost:8000/admin) to get the admin management backend.\n\nIf you want to run Gerapy in public, just run like this:\n\n```\ngerapy runserver 0.0.0.0:8000\n```\n\nThen it will run with public host and port 8000.\n\nIn Gerapy, You can create a configurable project and then configure and generate code of Scrapy automatically. But this module is unstable, we're trying to refine it.\n\nAlso you can drag your Scrapy Project to `projects` folder. Then refresh web, it will appear in the Project Index Page and comes to un-configurable, but you can edit this project through the web page.\n\nAs for deployment, you can move to Deploy Page. Firstly you need to build your project and add client in the Client Index Page, then you can deploy the project just by clicking button.\n\nAfter the deployment, you can manage the job in Monitor Page.\n\n## Docker\n\nJust run this command:\n\n```\ndocker run -d -v ~/gerapy:/app/gerapy -p 8000:8000 germey/gerapy\n```\n\nThen it will run at port 8000. You can use the temp admin account (username: admin, password: admin) to login. And please change the password later for safety.\n\nCommand Usage:\n\n```\ndocker run -d -v <workspace>:/app/gerapy -p <public_port>:<container_port> germey/gerapy\n```\n\nPlease specify your workspace to mount Gerapy workspace by `-v <workspace>:/app/gerapy` and specify server port by `-p <public_port>:<container_port>`.\n\nIf you run Gerapy by Docker, you can visit Gerapy website such as [http://localhost:8000](http://localhost:8000) and enjoy it, no need to do other initialzation things.\n\n## TodoList\n\n- [x] Add Visual Configuration of Spider with Previewing Website\n- [x] Add Scrapyd Auth Management\n- [x] Add Gerapy Auth Management\n- [x] Add Timed Task Scheduler\n- [ ] Add Visual Configuration of Scrapy\n- [ ] Add Intelligent Analysis of Web Page\n\n## Communication\n\nIf you have any questions or ideas, you can send [Issues](https://github.com/Gerapy/Gerapy/issues) or [Pull Requests](https://github.com/Gerapy/Gerapy/pulls), your suggestions are really import for us, thanks for your contirbution.\n", "patch": "@@ -8,9 +8,6 @@\n ![Docker Pulls](https://img.shields.io/docker/pulls/germey/gerapy)\n ![PyPI - License](https://img.shields.io/pypi/l/gerapy)\n \n-\n-> \u6ce8\uff1a\u4ece Gerapy 2.x \u5f00\u59cb\uff0c\u5176\u5b9a\u4f4d\u53d1\u751f\u6539\u53d8\uff0c\u4e0d\u518d\u652f\u6301 Scrapyd\uff0c\u8f6c\u800c\u652f\u6301 Docker\u3001Kubernetes \u7684\u90e8\u7f72\uff0c\u53e6\u5916\u5f00\u53d1\u8fd8\u4f1a\u8fc1\u79fb\u5230 Scrapy \u53ef\u89c6\u5316\u914d\u7f6e\u548c\u667a\u80fd\u89e3\u6790\u65b9\u9762\uff0c\u656c\u8bf7\u671f\u5f85\u3002\n-\n Distributed Crawler Management Framework Based on Scrapy, Scrapyd, Scrapyd-Client, Scrapyd-API, Django and Vue.js.\n \n ## Documentation", "file_path": "files/2020_7/9", "file_language": "md", "file_name": "README.md", "outdated_file_modify": 1, "outdated_file_before": 0, "outdated_file_after": 0}, {"raw_url": "https://github.com/Gerapy/Gerapy/raw/e8446605eb2424717418eae199ec7aad573da2d2/gerapy%2F__version__.py", "code": "VERSION = (0, 9, '3b1')\n\n__version__ = '.'.join(map(str, VERSION))\n\nversion = lambda: __version__\n", "code_before": "VERSION = (0, 9, '3a3')\n\n__version__ = '.'.join(map(str, VERSION))\n\nversion = lambda: __version__\n", "patch": "@@ -1,4 +1,4 @@\n-VERSION = (0, 9, '3a3')\n+VERSION = (0, 9, '3b1')\n \n __version__ = '.'.join(map(str, VERSION))\n ", "file_path": "files/2020_7/10", "file_language": "py", "file_name": "gerapy/__version__.py", "outdated_file_modify": 1, "outdated_file_before": 0, "outdated_file_after": 1, "llm_check": 0, "static_check": 0, "static": {"rats": [false, []], "semgrep": [false, []]}, "target": 0, "function_before": [], "function_after": []}, {"raw_url": "https://github.com/Gerapy/Gerapy/raw/e8446605eb2424717418eae199ec7aad573da2d2/gerapy%2Fserver%2Fcore%2Fviews.py", "code": "import re\nfrom pathlib import Path\nfrom urllib.parse import unquote\nimport base64\nimport json, os, requests, time, pytz, pymongo\nfrom shutil import rmtree\nfrom requests.exceptions import ConnectionError\nfrom os.path import join, exists\nfrom django.shortcuts import render\nfrom django.core.serializers import serialize\nfrom django.http import HttpResponse\nfrom django.forms.models import model_to_dict\nfrom django.utils import timezone\nfrom rest_framework.decorators import api_view, permission_classes\nfrom rest_framework.permissions import IsAuthenticated\nfrom subprocess import Popen, PIPE\nfrom gerapy import get_logger\nfrom gerapy.server.core.response import JsonResponse\nfrom gerapy.cmd.init import PROJECTS_FOLDER\nfrom gerapy.server.server.settings import TIME_ZONE\nfrom gerapy.server.core.models import Client, Project, Deploy, Monitor, Task\nfrom gerapy.server.core.build import build_project, find_egg\nfrom gerapy.server.core.utils import IGNORES, scrapyd_url, log_url, get_tree, get_scrapyd, process_html, bytes2str, \\\n    clients_of_task, get_job_id\nfrom django_apscheduler.models import DjangoJob, DjangoJobExecution\nfrom django.core.files.storage import FileSystemStorage\nimport zipfile\n\nlogger = get_logger(__name__)\n\n\n@api_view(['GET'])\n# @permission_classes([IsAuthenticated])\ndef index(request):\n    \"\"\"\n    render index page\n    :param request: request object\n    :return: page\n    \"\"\"\n    return render(request, 'index.html')\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef index_status(request):\n    \"\"\"\n    index statistics\n    :param request: request object\n    :return: json\n    \"\"\"\n    if request.method == 'GET':\n        clients = Client.objects.all()\n        data = {\n            'success': 0,\n            'error': 0,\n            'project': 0,\n        }\n        # clients info\n        for client in clients:\n            try:\n                requests.get(scrapyd_url(client.ip, client.port), timeout=1)\n                data['success'] += 1\n            except ConnectionError:\n                data['error'] += 1\n        path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))\n        files = os.listdir(path)\n        # projects info\n        for file in files:\n            if os.path.isdir(join(path, file)) and not file in IGNORES:\n                data['project'] += 1\n        return JsonResponse(data)\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef client_index(request):\n    \"\"\"\n    get client list\n    :param request: request object\n    :return: client list\n    \"\"\"\n    return HttpResponse(serialize('json', Client.objects.order_by('-id')))\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef client_info(request, client_id):\n    \"\"\"\n    get client info\n    :param request: request object\n    :param id: client id\n    :return: json\n    \"\"\"\n    if request.method == 'GET':\n        return JsonResponse(model_to_dict(Client.objects.get(id=client_id)))\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef client_status(request, client_id):\n    \"\"\"\n    get client status\n    :param request: request object\n    :param client_id: client id\n    :return: json\n    \"\"\"\n    if request.method == 'GET':\n        # get client object\n        client = Client.objects.get(id=client_id)\n        requests.get(scrapyd_url(client.ip, client.port), timeout=3)\n        return JsonResponse({'result': '1'})\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef client_update(request, client_id):\n    \"\"\"\n    update client info\n    :param request: request object\n    :param client_id: client id\n    :return: json\n    \"\"\"\n    if request.method == 'POST':\n        client = Client.objects.filter(id=client_id)\n        data = json.loads(request.body)\n        client.update(**data)\n        return JsonResponse(model_to_dict(Client.objects.get(id=client_id)))\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef client_create(request):\n    \"\"\"\n    create a client\n    :param request: request object\n    :return: json\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        client = Client.objects.create(**data)\n        return JsonResponse(model_to_dict(client))\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef client_remove(request, client_id):\n    \"\"\"\n    remove a client\n    :param request: request object\n    :param client_id: client id\n    :return: json\n    \"\"\"\n    if request.method == 'POST':\n        client = Client.objects.get(id=client_id)\n        # delete deploy\n        Deploy.objects.filter(client=client).delete()\n        # delete client\n        Client.objects.filter(id=client_id).delete()\n        return JsonResponse({'result': '1'})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef spider_list(request, client_id, project_name):\n    \"\"\"\n    get spider list from one client\n    :param request: request Object\n    :param client_id: client id\n    :param project_name: project name\n    :return: json\n    \"\"\"\n    if request.method == 'GET':\n        client = Client.objects.get(id=client_id)\n        scrapyd = get_scrapyd(client)\n        spiders = scrapyd.list_spiders(project_name)\n        spiders = [{'name': spider, 'id': index + 1} for index, spider in enumerate(spiders)]\n        return JsonResponse(spiders)\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef spider_start(request, client_id, project_name, spider_name):\n    \"\"\"\n    start a spider\n    :param request: request object\n    :param client_id: client id\n    :param project_name: project name\n    :param spider_name: spider name\n    :return: json\n    \"\"\"\n    if request.method == 'GET':\n        client = Client.objects.get(id=client_id)\n        scrapyd = get_scrapyd(client)\n        job = scrapyd.schedule(project_name, spider_name)\n        return JsonResponse({'job': job})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef project_list(request, client_id):\n    \"\"\"\n    project deployed list on one client\n    :param request: request object\n    :param client_id: client id\n    :return: json\n    \"\"\"\n    if request.method == 'GET':\n        client = Client.objects.get(id=client_id)\n        scrapyd = get_scrapyd(client)\n        projects = scrapyd.list_projects()\n        return JsonResponse(projects)\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef project_index(request):\n    \"\"\"\n    project index list\n    :param request: request object\n    :return: json\n    \"\"\"\n    if request.method == 'GET':\n        path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))\n        files = os.listdir(path)\n        project_list = []\n        for file in files:\n            if os.path.isdir(join(path, file)) and not file in IGNORES:\n                project_list.append({'name': file})\n        return JsonResponse(project_list)\n\n\n@api_view(['GET', 'POST'])\n@permission_classes([IsAuthenticated])\ndef project_configure(request, project_name):\n    \"\"\"\n    get configuration\n    :param request: request object\n    :param project_name: project name\n    :return: json\n    \"\"\"\n    # get configuration\n    if request.method == 'GET':\n        project = Project.objects.get(name=project_name)\n        project = model_to_dict(project)\n        project['configuration'] = json.loads(project['configuration']) if project['configuration'] else None\n        return JsonResponse(project)\n    \n    # update configuration\n    elif request.method == 'POST':\n        project = Project.objects.filter(name=project_name)\n        data = json.loads(request.body)\n        configuration = json.dumps(data.get('configuration'), ensure_ascii=False)\n        project.update(**{'configuration': configuration})\n        \n        # for safe protection\n        project_name = re.sub('[\\!\\@\\#\\$\\;\\&\\*\\~\\\"\\'\\{\\}\\]\\[\\-\\+\\%\\^]+', '', project_name)\n        # execute generate cmd\n        cmd = ' '.join(['gerapy', 'generate', project_name])\n        p = Popen(cmd, shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE)\n        stdout, stderr = bytes2str(p.stdout.read()), bytes2str(p.stderr.read())\n        \n        if not stderr:\n            return JsonResponse({'status': '1'})\n        else:\n            return JsonResponse({'status': '0', 'message': stderr})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef project_tree(request, project_name):\n    \"\"\"\n    get file tree of project\n    :param request: request object\n    :param project_name: project name\n    :return: json of tree\n    \"\"\"\n    if request.method == 'GET':\n        path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))\n        # get tree data\n        tree = get_tree(join(path, project_name))\n        return JsonResponse(tree)\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_create(request):\n    \"\"\"\n    create a configurable project\n    :param request: request object\n    :return: json\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        data['configurable'] = 1\n        project, result = Project.objects.update_or_create(**data)\n        # generate a single project folder\n        path = join(os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER)), data['name'])\n        os.mkdir(path)\n        return JsonResponse(model_to_dict(project))\n\n\n@api_view(['POST'])\n# @permission_classes([IsAuthenticated])\ndef project_upload(request):\n    \"\"\"\n    upload project\n    :param request: request object\n    :return: json\n    \"\"\"\n    if request.method == 'POST':\n        file = request.FILES['file']\n        file_name = file.name\n        fs = FileSystemStorage(PROJECTS_FOLDER)\n        zip_file_name = fs.save(file_name, file)\n        logger.debug('zip file name %s', zip_file_name)\n        # extract zip file\n        with zipfile.ZipFile(join(PROJECTS_FOLDER, zip_file_name), 'r') as zip_ref:\n            zip_ref.extractall(PROJECTS_FOLDER)\n        logger.debug('extracted files to %s', PROJECTS_FOLDER)\n        return JsonResponse({'status': True})\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_clone(request):\n    \"\"\"\n    clone project from github\n    :param request: request object\n    :return: json\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        address = data.get('address')\n        if not address.startswith('http'):\n            return JsonResponse({'status': False})\n        address = address + '.git' if not address.endswith('.git') else address\n        cmd = 'git clone {address} {target}'.format(address=address, target=join(PROJECTS_FOLDER, Path(address).stem))\n        logger.debug('clone cmd %s', cmd)\n        p = Popen(cmd, shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE)\n        stdout, stderr = bytes2str(p.stdout.read()), bytes2str(p.stderr.read())\n        logger.debug('clone run result %s', stdout)\n        if stderr: logger.error(stderr)\n        return JsonResponse({'status': True}) if not stderr else JsonResponse({'status': False})\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_remove(request, project_name):\n    \"\"\"\n    remove project from disk and db\n    :param request: request object\n    :param project_name: project name\n    :return: result of remove\n    \"\"\"\n    if request.method == 'POST':\n        # delete deployments\n        project = Project.objects.get(name=project_name)\n        Deploy.objects.filter(project=project).delete()\n        # delete project\n        result = Project.objects.filter(name=project_name).delete()\n        # get project path\n        path = join(os.path.abspath(os.getcwd()), PROJECTS_FOLDER)\n        project_path = join(path, project_name)\n        # delete project file tree\n        if exists(project_path):\n            rmtree(project_path)\n        return JsonResponse({'result': result})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef project_version(request, client_id, project_name):\n    \"\"\"\n    get project deploy version\n    :param request: request object\n    :param client_id: client id\n    :param project_name: project name\n    :return: deploy version of project\n    \"\"\"\n    if request.method == 'GET':\n        # get client and project model\n        client = Client.objects.get(id=client_id)\n        project = Project.objects.get(name=project_name)\n        scrapyd = get_scrapyd(client)\n        # if deploy info exists in db, return it\n        if Deploy.objects.filter(client=client, project=project):\n            deploy = Deploy.objects.get(client=client, project=project)\n        # if deploy info does not exists in db, create deploy info\n        else:\n            try:\n                versions = scrapyd.list_versions(project_name)\n            except ConnectionError:\n                return JsonResponse({'message': 'Connect Error'}, status=500)\n            if len(versions) > 0:\n                version = versions[-1]\n                deployed_at = timezone.datetime.fromtimestamp(int(version), tz=pytz.timezone(TIME_ZONE))\n            else:\n                deployed_at = None\n            deploy, result = Deploy.objects.update_or_create(client=client, project=project, deployed_at=deployed_at)\n        # return deploy json info\n        return JsonResponse(model_to_dict(deploy))\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_deploy(request, client_id, project_name):\n    \"\"\"\n    deploy project operation\n    :param request: request object\n    :param client_id: client id\n    :param project_name: project name\n    :return: json of deploy result\n    \"\"\"\n    if request.method == 'POST':\n        # get project folder\n        path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))\n        project_path = join(path, project_name)\n        # find egg file\n        egg = find_egg(project_path)\n        if not egg:\n            return JsonResponse({'message': 'egg not found'}, status=500)\n        egg_file = open(join(project_path, egg), 'rb')\n        # get client and project model\n        client = Client.objects.get(id=client_id)\n        project = Project.objects.get(name=project_name)\n        # execute deploy operation\n        scrapyd = get_scrapyd(client)\n        scrapyd.add_version(project_name, int(time.time()), egg_file.read())\n        # update deploy info\n        deployed_at = timezone.now()\n        Deploy.objects.filter(client=client, project=project).delete()\n        deploy, result = Deploy.objects.update_or_create(client=client, project=project, deployed_at=deployed_at,\n                                                         description=project.description)\n        return JsonResponse(model_to_dict(deploy))\n\n\n@api_view(['GET', 'POST'])\n@permission_classes([IsAuthenticated])\ndef project_build(request, project_name):\n    \"\"\"\n    get build info or execute build operation\n    :param request: request object\n    :param project_name: project name\n    :return: json\n    \"\"\"\n    # get project folder\n    path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))\n    project_path = join(path, project_name)\n    \n    # get build version\n    if request.method == 'GET':\n        egg = find_egg(project_path)\n        # if built, save or update project to db\n        if egg:\n            built_at = timezone.datetime.fromtimestamp(os.path.getmtime(join(project_path, egg)),\n                                                       tz=pytz.timezone(TIME_ZONE))\n            if not Project.objects.filter(name=project_name):\n                Project(name=project_name, built_at=built_at, egg=egg).save()\n                model = Project.objects.get(name=project_name)\n            else:\n                model = Project.objects.get(name=project_name)\n                model.built_at = built_at\n                model.egg = egg\n                model.save()\n        # if not built, just save project name to db\n        else:\n            if not Project.objects.filter(name=project_name):\n                Project(name=project_name).save()\n            model = Project.objects.get(name=project_name)\n        # transfer model to dict then dumps it to json\n        data = model_to_dict(model)\n        return JsonResponse(data)\n    \n    # build operation manually by clicking button\n    elif request.method == 'POST':\n        data = json.loads(request.body)\n        description = data['description']\n        build_project(project_name)\n        egg = find_egg(project_path)\n        if not egg:\n            return JsonResponse({'message': 'egg not found'}, status=500)\n        # update built_at info\n        built_at = timezone.now()\n        # if project does not exists in db, create it\n        if not Project.objects.filter(name=project_name):\n            Project(name=project_name, description=description, built_at=built_at, egg=egg).save()\n            model = Project.objects.get(name=project_name)\n        # if project exists, update egg, description, built_at info\n        else:\n            model = Project.objects.get(name=project_name)\n            model.built_at = built_at\n            model.egg = egg\n            model.description = description\n            model.save()\n        # transfer model to dict then dumps it to json\n        data = model_to_dict(model)\n        return JsonResponse(data)\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_parse(request, project_name):\n    \"\"\"\n    parse project\n    :param request: request object\n    :param project_name: project name\n    :return: requests, items, response\n    \"\"\"\n    if request.method == 'POST':\n        project_path = join(PROJECTS_FOLDER, project_name)\n        data = json.loads(request.body)\n        logger.debug('post data %s', data)\n        spider_name = data.get('spider')\n        args = {\n            'start': data.get('start', False),\n            'method': data.get('method', 'GET'),\n            'url': data.get('url'),\n            'callback': data.get('callback'),\n            'cookies': \"'\" + json.dumps(data.get('cookies', {}), ensure_ascii=False) + \"'\",\n            'headers': \"'\" + json.dumps(data.get('headers', {}), ensure_ascii=False) + \"'\",\n            'meta': \"'\" + json.dumps(data.get('meta', {}), ensure_ascii=False) + \"'\",\n            'dont_filter': data.get('dont_filter', False),\n            'priority': data.get('priority', 0),\n        }\n        # set request body\n        body = data.get('body', '')\n        if args.get('method').lower() != 'get':\n            args['body'] = \"'\" + json.dumps(body, ensure_ascii=False) + \"'\"\n        \n        args_cmd = ' '.join(\n            ['--{arg} {value}'.format(arg=arg, value=value) for arg, value in args.items()])\n        logger.debug('args cmd %s', args_cmd)\n        cmd = 'gerapy parse {args_cmd} {project_path} {spider_name}'.format(\n            args_cmd=args_cmd,\n            project_path=project_path,\n            spider_name=spider_name\n        )\n        logger.debug('parse cmd %s', cmd)\n        p = Popen(cmd, shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE, close_fds=True)\n        stdout, stderr = bytes2str(p.stdout.read()), bytes2str(p.stderr.read())\n        logger.debug('stdout %s, stderr %s', stdout, stderr)\n        if not stderr:\n            return JsonResponse({'status': True, 'result': json.loads(stdout)})\n        else:\n            return JsonResponse({'status': False, 'message': stderr})\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_file_read(request):\n    \"\"\"\n    get content of project file\n    :param request: request object\n    :return: file content\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        path = join(data['path'], data['label'])\n        # binary file\n        with open(path, 'rb') as f:\n            return HttpResponse(f.read().decode('utf-8'))\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_file_update(request):\n    \"\"\"\n    update project file\n    :param request: request object\n    :return: result of update\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        path = join(data['path'], data['label'])\n        code = data['code']\n        with open(path, 'w', encoding='utf-8') as f:\n            f.write(code)\n            return JsonResponse({'result': '1'})\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_file_create(request):\n    \"\"\"\n    create project file\n    :param request: request object\n    :return: result of create\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        path = join(data['path'], data['name'])\n        open(path, 'w', encoding='utf-8').close()\n        return JsonResponse({'result': '1'})\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_file_delete(request):\n    \"\"\"\n    delete project file\n    :param request: request object\n    :return: result of delete\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        path = join(data['path'], data['label'])\n        result = os.remove(path)\n        return JsonResponse({'result': result})\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_file_rename(request):\n    \"\"\"\n    rename file name\n    :param request: request object\n    :return: result of rename\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        pre = join(data['path'], data['pre'])\n        new = join(data['path'], data['new'])\n        os.rename(pre, new)\n        return JsonResponse({'result': '1'})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef job_list(request, client_id, project_name):\n    \"\"\"\n    get job list of project from one client\n    :param request: request object\n    :param client_id: client id\n    :param project_name: project name\n    :return: list of jobs\n    \"\"\"\n    if request.method == 'GET':\n        client = Client.objects.get(id=client_id)\n        scrapyd = get_scrapyd(client)\n        result = scrapyd.list_jobs(project_name)\n        jobs = []\n        statuses = ['pending', 'running', 'finished']\n        for status in statuses:\n            for job in result.get(status):\n                job['status'] = status\n                jobs.append(job)\n        return JsonResponse(jobs)\n    \n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef job_log(request, client_id, project_name, spider_name, job_id):\n    \"\"\"\n    get log of jog\n    :param request: request object\n    :param client_id: client id\n    :param project_name: project name\n    :param spider_name: spider name\n    :param job_id: job id\n    :return: log of job\n    \"\"\"\n    if request.method == 'GET':\n        client = Client.objects.get(id=client_id)\n        # get log url\n        url = log_url(client.ip, client.port, project_name, spider_name, job_id)\n        # get last 1000 bytes of log\n        response = requests.get(url, timeout=5, headers={\n            'Range': 'bytes=-1000'\n        }, auth=(client.username, client.password) if client.auth else None)\n        # Get encoding\n        encoding = response.apparent_encoding\n        # log not found\n        if response.status_code == 404:\n            return JsonResponse({'message': 'Log Not Found'}, status=404)\n        # bytes to string\n        text = response.content.decode(encoding, errors='replace')\n        return HttpResponse(text)\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef job_cancel(request, client_id, project_name, job_id):\n    \"\"\"\n    cancel a job\n    :param request: request object\n    :param client_id: client id\n    :param project_name: project name\n    :param job_id: job id\n    :return: json of cancel\n    \"\"\"\n    if request.method == 'GET':\n        client = Client.objects.get(id=client_id)\n        scrapyd = get_scrapyd(client)\n        result = scrapyd.cancel(project_name, job_id)\n        return JsonResponse(result)\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef del_version(request, client_id, project, version):\n    if request.method == 'GET':\n        client = Client.objects.get(id=client_id)\n        scrapyd = get_scrapyd(client)\n        result = scrapyd.delete_version(project=project, version=version)\n        return JsonResponse(result)\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef del_project(request, client_id, project):\n    if request.method == 'GET':\n        client = Client.objects.get(id=client_id)\n        scrapyd = get_scrapyd(client)\n        result = scrapyd.delete_project(project=project)\n        return JsonResponse(result)\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef monitor_db_list(request):\n    \"\"\"\n    get monitor db list\n    :param request: request object\n    :return: json of db list\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        url = data['url']\n        type = data['type']\n        if type == 'MongoDB':\n            client = pymongo.MongoClient(url)\n            dbs = client.list_database_names()\n            return JsonResponse(dbs)\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef monitor_collection_list(request):\n    \"\"\"\n    get monitor collection list\n    :param request: request object\n    :return: json of collection list\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        url = data['url']\n        db = data['db']\n        type = data['type']\n        if type == 'MongoDB':\n            client = pymongo.MongoClient(url)\n            db = client[db]\n            collections = db.collection_names()\n            return JsonResponse(collections)\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef monitor_create(request):\n    \"\"\"\n    create a monitor\n    :param request: request object\n    :return: json of create\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        data = data['form']\n        data['configuration'] = json.dumps(data['configuration'], ensure_ascii=False)\n        monitor = Monitor.objects.create(**data)\n        return JsonResponse(model_to_dict(monitor))\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef task_create(request):\n    \"\"\"\n    add task\n    :param request: request object\n    :return: Bool\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        task = Task.objects.create(clients=json.dumps(data.get('clients'), ensure_ascii=False),\n                                   project=data.get('project'),\n                                   name=data.get('name'),\n                                   spider=data.get('spider'),\n                                   trigger=data.get('trigger'),\n                                   configuration=json.dumps(data.get('configuration'), ensure_ascii=False),\n                                   modified=1)\n        return JsonResponse({'result': '1', 'data': model_to_dict(task)})\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef task_update(request, task_id):\n    \"\"\"\n    update task info\n    :param request: request object\n    :param task_id: task id\n    :return: json\n    \"\"\"\n    if request.method == 'POST':\n        task = Task.objects.filter(id=task_id)\n        data = json.loads(request.body)\n        data['clients'] = json.dumps(data.get('clients'), ensure_ascii=False)\n        data['configuration'] = json.dumps(data.get('configuration'), ensure_ascii=False)\n        data['modified'] = 1\n        task.update(**data)\n        return JsonResponse(model_to_dict(Task.objects.get(id=task_id)))\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef task_remove(request, task_id):\n    \"\"\"\n    remove task by task_id\n    :param request:\n    :return:\n    \"\"\"\n    if request.method == 'POST':\n        # delete job from DjangoJob\n        task = Task.objects.get(id=task_id)\n        clients = clients_of_task(task)\n        for client in clients:\n            job_id = get_job_id(client, task)\n            DjangoJob.objects.filter(name=job_id).delete()\n        # delete task\n        Task.objects.filter(id=task_id).delete()\n        return JsonResponse({'result': '1'})\n    \n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef task_info(request, task_id):\n    \"\"\"\n    get task info\n    :param request: request object\n    :param task_id: task id\n    :return: json\n    \"\"\"\n    if request.method == 'GET':\n        task = Task.objects.get(id=task_id)\n        data = model_to_dict(task)\n        data['clients'] = json.loads(data.get('clients'))\n        data['configuration'] = json.loads(data.get('configuration'))\n        return JsonResponse({'data': data})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef task_index(request):\n    \"\"\"\n    get all tasks\n    :param request:\n    :return:\n    \"\"\"\n    if request.method == 'GET':\n        tasks = Task.objects.values()\n        return JsonResponse({'result': '1', 'data': tasks})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef task_status(request, task_id):\n    \"\"\"\n    get task status info\n    :param request: request object\n    :param task_id: task id\n    :return:\n    \"\"\"\n    if request.method == 'GET':\n        result = []\n        task = Task.objects.get(id=task_id)\n        clients = clients_of_task(task)\n        for client in clients:\n            job_id = get_job_id(client, task)\n            jobs = DjangoJob.objects.filter(name=job_id)\n            logger.debug('jobs from djangojob %s', jobs)\n            # if job does not exist, for date mode exceed time\n            if not jobs: continue\n            job = DjangoJob.objects.get(name=job_id)\n            executions = serialize('json', DjangoJobExecution.objects.filter(job=job))\n            result.append({\n                'client': model_to_dict(client),\n                'next': job.next_run_time,\n                'executions': json.loads(executions)\n            })\n        return JsonResponse({'data': result})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef render_html(request):\n    \"\"\"\n    render html with url\n    :param request:\n    :return:\n    \"\"\"\n    if request.method == 'GET':\n        url = request.GET.get('url')\n        url = unquote(base64.b64decode(url).decode('utf-8'))\n        js = request.GET.get('js', 0)\n        script = request.GET.get('script')\n        response = requests.get(url, timeout=5)\n        response.encoding = response.apparent_encoding\n        html = process_html(response.text)\n        return HttpResponse(html)\n", "code_before": "from pathlib import Path\nfrom urllib.parse import unquote\nimport base64\nimport json, os, requests, time, pytz, pymongo\nfrom shutil import rmtree\nfrom requests.exceptions import ConnectionError\nfrom os.path import join, exists\nfrom django.shortcuts import render\nfrom django.core.serializers import serialize\nfrom django.http import HttpResponse\nfrom django.forms.models import model_to_dict\nfrom django.utils import timezone\nfrom rest_framework.decorators import api_view, permission_classes\nfrom rest_framework.permissions import IsAuthenticated\nfrom subprocess import Popen, PIPE\nfrom gerapy import get_logger\nfrom gerapy.server.core.response import JsonResponse\nfrom gerapy.cmd.init import PROJECTS_FOLDER\nfrom gerapy.server.server.settings import TIME_ZONE\nfrom gerapy.server.core.models import Client, Project, Deploy, Monitor, Task\nfrom gerapy.server.core.build import build_project, find_egg\nfrom gerapy.server.core.utils import IGNORES, scrapyd_url, log_url, get_tree, get_scrapyd, process_html, bytes2str, \\\n    clients_of_task, get_job_id\nfrom django_apscheduler.models import DjangoJob, DjangoJobExecution\nfrom django.core.files.storage import FileSystemStorage\nimport zipfile\n\nlogger = get_logger(__name__)\n\n\n@api_view(['GET'])\n# @permission_classes([IsAuthenticated])\ndef index(request):\n    \"\"\"\n    render index page\n    :param request: request object\n    :return: page\n    \"\"\"\n    return render(request, 'index.html')\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef index_status(request):\n    \"\"\"\n    index statistics\n    :param request: request object\n    :return: json\n    \"\"\"\n    if request.method == 'GET':\n        clients = Client.objects.all()\n        data = {\n            'success': 0,\n            'error': 0,\n            'project': 0,\n        }\n        # clients info\n        for client in clients:\n            try:\n                requests.get(scrapyd_url(client.ip, client.port), timeout=1)\n                data['success'] += 1\n            except ConnectionError:\n                data['error'] += 1\n        path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))\n        files = os.listdir(path)\n        # projects info\n        for file in files:\n            if os.path.isdir(join(path, file)) and not file in IGNORES:\n                data['project'] += 1\n        return JsonResponse(data)\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef client_index(request):\n    \"\"\"\n    get client list\n    :param request: request object\n    :return: client list\n    \"\"\"\n    return HttpResponse(serialize('json', Client.objects.order_by('-id')))\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef client_info(request, client_id):\n    \"\"\"\n    get client info\n    :param request: request object\n    :param id: client id\n    :return: json\n    \"\"\"\n    if request.method == 'GET':\n        return JsonResponse(model_to_dict(Client.objects.get(id=client_id)))\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef client_status(request, client_id):\n    \"\"\"\n    get client status\n    :param request: request object\n    :param client_id: client id\n    :return: json\n    \"\"\"\n    if request.method == 'GET':\n        # get client object\n        client = Client.objects.get(id=client_id)\n        requests.get(scrapyd_url(client.ip, client.port), timeout=3)\n        return JsonResponse({'result': '1'})\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef client_update(request, client_id):\n    \"\"\"\n    update client info\n    :param request: request object\n    :param client_id: client id\n    :return: json\n    \"\"\"\n    if request.method == 'POST':\n        client = Client.objects.filter(id=client_id)\n        data = json.loads(request.body)\n        client.update(**data)\n        return JsonResponse(model_to_dict(Client.objects.get(id=client_id)))\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef client_create(request):\n    \"\"\"\n    create a client\n    :param request: request object\n    :return: json\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        client = Client.objects.create(**data)\n        return JsonResponse(model_to_dict(client))\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef client_remove(request, client_id):\n    \"\"\"\n    remove a client\n    :param request: request object\n    :param client_id: client id\n    :return: json\n    \"\"\"\n    if request.method == 'POST':\n        client = Client.objects.get(id=client_id)\n        # delete deploy\n        Deploy.objects.filter(client=client).delete()\n        # delete client\n        Client.objects.filter(id=client_id).delete()\n        return JsonResponse({'result': '1'})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef spider_list(request, client_id, project_name):\n    \"\"\"\n    get spider list from one client\n    :param request: request Object\n    :param client_id: client id\n    :param project_name: project name\n    :return: json\n    \"\"\"\n    if request.method == 'GET':\n        client = Client.objects.get(id=client_id)\n        scrapyd = get_scrapyd(client)\n        spiders = scrapyd.list_spiders(project_name)\n        spiders = [{'name': spider, 'id': index + 1} for index, spider in enumerate(spiders)]\n        return JsonResponse(spiders)\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef spider_start(request, client_id, project_name, spider_name):\n    \"\"\"\n    start a spider\n    :param request: request object\n    :param client_id: client id\n    :param project_name: project name\n    :param spider_name: spider name\n    :return: json\n    \"\"\"\n    if request.method == 'GET':\n        client = Client.objects.get(id=client_id)\n        scrapyd = get_scrapyd(client)\n        job = scrapyd.schedule(project_name, spider_name)\n        return JsonResponse({'job': job})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef project_list(request, client_id):\n    \"\"\"\n    project deployed list on one client\n    :param request: request object\n    :param client_id: client id\n    :return: json\n    \"\"\"\n    if request.method == 'GET':\n        client = Client.objects.get(id=client_id)\n        scrapyd = get_scrapyd(client)\n        projects = scrapyd.list_projects()\n        return JsonResponse(projects)\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef project_index(request):\n    \"\"\"\n    project index list\n    :param request: request object\n    :return: json\n    \"\"\"\n    if request.method == 'GET':\n        path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))\n        files = os.listdir(path)\n        project_list = []\n        for file in files:\n            if os.path.isdir(join(path, file)) and not file in IGNORES:\n                project_list.append({'name': file})\n        return JsonResponse(project_list)\n\n\n@api_view(['GET', 'POST'])\n@permission_classes([IsAuthenticated])\ndef project_configure(request, project_name):\n    \"\"\"\n    get configuration\n    :param request: request object\n    :param project_name: project name\n    :return: json\n    \"\"\"\n    # get configuration\n    if request.method == 'GET':\n        project = Project.objects.get(name=project_name)\n        project = model_to_dict(project)\n        project['configuration'] = json.loads(project['configuration']) if project['configuration'] else None\n        return JsonResponse(project)\n    \n    # update configuration\n    elif request.method == 'POST':\n        project = Project.objects.filter(name=project_name)\n        data = json.loads(request.body)\n        configuration = json.dumps(data.get('configuration'), ensure_ascii=False)\n        project.update(**{'configuration': configuration})\n        \n        # execute generate cmd\n        cmd = ' '.join(['gerapy', 'generate', project_name])\n        p = Popen(cmd, shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE)\n        stdout, stderr = bytes2str(p.stdout.read()), bytes2str(p.stderr.read())\n        \n        if not stderr:\n            return JsonResponse({'status': '1'})\n        else:\n            return JsonResponse({'status': '0', 'message': stderr})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef project_tree(request, project_name):\n    \"\"\"\n    get file tree of project\n    :param request: request object\n    :param project_name: project name\n    :return: json of tree\n    \"\"\"\n    if request.method == 'GET':\n        path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))\n        # get tree data\n        tree = get_tree(join(path, project_name))\n        return JsonResponse(tree)\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_create(request):\n    \"\"\"\n    create a configurable project\n    :param request: request object\n    :return: json\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        data['configurable'] = 1\n        project, result = Project.objects.update_or_create(**data)\n        # generate a single project folder\n        path = join(os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER)), data['name'])\n        os.mkdir(path)\n        return JsonResponse(model_to_dict(project))\n\n\n@api_view(['POST'])\n# @permission_classes([IsAuthenticated])\ndef project_upload(request):\n    \"\"\"\n    upload project\n    :param request: request object\n    :return: json\n    \"\"\"\n    if request.method == 'POST':\n        file = request.FILES['file']\n        file_name = file.name\n        fs = FileSystemStorage(PROJECTS_FOLDER)\n        zip_file_name = fs.save(file_name, file)\n        logger.debug('zip file name %s', zip_file_name)\n        # extract zip file\n        with zipfile.ZipFile(join(PROJECTS_FOLDER, zip_file_name), 'r') as zip_ref:\n            zip_ref.extractall(PROJECTS_FOLDER)\n        logger.debug('extracted files to %s', PROJECTS_FOLDER)\n        return JsonResponse({'status': True})\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_clone(request):\n    \"\"\"\n    clone project from github\n    :param request: request object\n    :return: json\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        address = data.get('address')\n        if not address.startswith('http'):\n            return JsonResponse({'status': False})\n        address = address + '.git' if not address.endswith('.git') else address\n        cmd = 'git clone {address} {target}'.format(address=address, target=join(PROJECTS_FOLDER, Path(address).stem))\n        logger.debug('clone cmd %s', cmd)\n        p = Popen(cmd, shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE)\n        stdout, stderr = bytes2str(p.stdout.read()), bytes2str(p.stderr.read())\n        logger.debug('clone run result %s', stdout)\n        if stderr: logger.error(stderr)\n        return JsonResponse({'status': True}) if not stderr else JsonResponse({'status': False})\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_remove(request, project_name):\n    \"\"\"\n    remove project from disk and db\n    :param request: request object\n    :param project_name: project name\n    :return: result of remove\n    \"\"\"\n    if request.method == 'POST':\n        # delete deployments\n        project = Project.objects.get(name=project_name)\n        Deploy.objects.filter(project=project).delete()\n        # delete project\n        result = Project.objects.filter(name=project_name).delete()\n        # get project path\n        path = join(os.path.abspath(os.getcwd()), PROJECTS_FOLDER)\n        project_path = join(path, project_name)\n        # delete project file tree\n        if exists(project_path):\n            rmtree(project_path)\n        return JsonResponse({'result': result})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef project_version(request, client_id, project_name):\n    \"\"\"\n    get project deploy version\n    :param request: request object\n    :param client_id: client id\n    :param project_name: project name\n    :return: deploy version of project\n    \"\"\"\n    if request.method == 'GET':\n        # get client and project model\n        client = Client.objects.get(id=client_id)\n        project = Project.objects.get(name=project_name)\n        scrapyd = get_scrapyd(client)\n        # if deploy info exists in db, return it\n        if Deploy.objects.filter(client=client, project=project):\n            deploy = Deploy.objects.get(client=client, project=project)\n        # if deploy info does not exists in db, create deploy info\n        else:\n            try:\n                versions = scrapyd.list_versions(project_name)\n            except ConnectionError:\n                return JsonResponse({'message': 'Connect Error'}, status=500)\n            if len(versions) > 0:\n                version = versions[-1]\n                deployed_at = timezone.datetime.fromtimestamp(int(version), tz=pytz.timezone(TIME_ZONE))\n            else:\n                deployed_at = None\n            deploy, result = Deploy.objects.update_or_create(client=client, project=project, deployed_at=deployed_at)\n        # return deploy json info\n        return JsonResponse(model_to_dict(deploy))\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_deploy(request, client_id, project_name):\n    \"\"\"\n    deploy project operation\n    :param request: request object\n    :param client_id: client id\n    :param project_name: project name\n    :return: json of deploy result\n    \"\"\"\n    if request.method == 'POST':\n        # get project folder\n        path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))\n        project_path = join(path, project_name)\n        # find egg file\n        egg = find_egg(project_path)\n        if not egg:\n            return JsonResponse({'message': 'egg not found'}, status=500)\n        egg_file = open(join(project_path, egg), 'rb')\n        # get client and project model\n        client = Client.objects.get(id=client_id)\n        project = Project.objects.get(name=project_name)\n        # execute deploy operation\n        scrapyd = get_scrapyd(client)\n        scrapyd.add_version(project_name, int(time.time()), egg_file.read())\n        # update deploy info\n        deployed_at = timezone.now()\n        Deploy.objects.filter(client=client, project=project).delete()\n        deploy, result = Deploy.objects.update_or_create(client=client, project=project, deployed_at=deployed_at,\n                                                         description=project.description)\n        return JsonResponse(model_to_dict(deploy))\n\n\n@api_view(['GET', 'POST'])\n@permission_classes([IsAuthenticated])\ndef project_build(request, project_name):\n    \"\"\"\n    get build info or execute build operation\n    :param request: request object\n    :param project_name: project name\n    :return: json\n    \"\"\"\n    # get project folder\n    path = os.path.abspath(join(os.getcwd(), PROJECTS_FOLDER))\n    project_path = join(path, project_name)\n    \n    # get build version\n    if request.method == 'GET':\n        egg = find_egg(project_path)\n        # if built, save or update project to db\n        if egg:\n            built_at = timezone.datetime.fromtimestamp(os.path.getmtime(join(project_path, egg)),\n                                                       tz=pytz.timezone(TIME_ZONE))\n            if not Project.objects.filter(name=project_name):\n                Project(name=project_name, built_at=built_at, egg=egg).save()\n                model = Project.objects.get(name=project_name)\n            else:\n                model = Project.objects.get(name=project_name)\n                model.built_at = built_at\n                model.egg = egg\n                model.save()\n        # if not built, just save project name to db\n        else:\n            if not Project.objects.filter(name=project_name):\n                Project(name=project_name).save()\n            model = Project.objects.get(name=project_name)\n        # transfer model to dict then dumps it to json\n        data = model_to_dict(model)\n        return JsonResponse(data)\n    \n    # build operation manually by clicking button\n    elif request.method == 'POST':\n        data = json.loads(request.body)\n        description = data['description']\n        build_project(project_name)\n        egg = find_egg(project_path)\n        if not egg:\n            return JsonResponse({'message': 'egg not found'}, status=500)\n        # update built_at info\n        built_at = timezone.now()\n        # if project does not exists in db, create it\n        if not Project.objects.filter(name=project_name):\n            Project(name=project_name, description=description, built_at=built_at, egg=egg).save()\n            model = Project.objects.get(name=project_name)\n        # if project exists, update egg, description, built_at info\n        else:\n            model = Project.objects.get(name=project_name)\n            model.built_at = built_at\n            model.egg = egg\n            model.description = description\n            model.save()\n        # transfer model to dict then dumps it to json\n        data = model_to_dict(model)\n        return JsonResponse(data)\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_parse(request, project_name):\n    \"\"\"\n    parse project\n    :param request: request object\n    :param project_name: project name\n    :return: requests, items, response\n    \"\"\"\n    if request.method == 'POST':\n        project_path = join(PROJECTS_FOLDER, project_name)\n        data = json.loads(request.body)\n        logger.debug('post data %s', data)\n        spider_name = data.get('spider')\n        args = {\n            'start': data.get('start', False),\n            'method': data.get('method', 'GET'),\n            'url': data.get('url'),\n            'callback': data.get('callback'),\n            'cookies': \"'\" + json.dumps(data.get('cookies', {}), ensure_ascii=False) + \"'\",\n            'headers': \"'\" + json.dumps(data.get('headers', {}), ensure_ascii=False) + \"'\",\n            'meta': \"'\" + json.dumps(data.get('meta', {}), ensure_ascii=False) + \"'\",\n            'dont_filter': data.get('dont_filter', False),\n            'priority': data.get('priority', 0),\n        }\n        # set request body\n        body = data.get('body', '')\n        if args.get('method').lower() != 'get':\n            args['body'] = \"'\" + json.dumps(body, ensure_ascii=False) + \"'\"\n        \n        args_cmd = ' '.join(\n            ['--{arg} {value}'.format(arg=arg, value=value) for arg, value in args.items()])\n        logger.debug('args cmd %s', args_cmd)\n        cmd = 'gerapy parse {args_cmd} {project_path} {spider_name}'.format(\n            args_cmd=args_cmd,\n            project_path=project_path,\n            spider_name=spider_name\n        )\n        logger.debug('parse cmd %s', cmd)\n        p = Popen(cmd, shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE, close_fds=True)\n        stdout, stderr = bytes2str(p.stdout.read()), bytes2str(p.stderr.read())\n        logger.debug('stdout %s, stderr %s', stdout, stderr)\n        if not stderr:\n            return JsonResponse({'status': True, 'result': json.loads(stdout)})\n        else:\n            return JsonResponse({'status': False, 'message': stderr})\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_file_read(request):\n    \"\"\"\n    get content of project file\n    :param request: request object\n    :return: file content\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        path = join(data['path'], data['label'])\n        # binary file\n        with open(path, 'rb') as f:\n            return HttpResponse(f.read().decode('utf-8'))\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_file_update(request):\n    \"\"\"\n    update project file\n    :param request: request object\n    :return: result of update\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        path = join(data['path'], data['label'])\n        code = data['code']\n        with open(path, 'w', encoding='utf-8') as f:\n            f.write(code)\n            return JsonResponse({'result': '1'})\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_file_create(request):\n    \"\"\"\n    create project file\n    :param request: request object\n    :return: result of create\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        path = join(data['path'], data['name'])\n        open(path, 'w', encoding='utf-8').close()\n        return JsonResponse({'result': '1'})\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_file_delete(request):\n    \"\"\"\n    delete project file\n    :param request: request object\n    :return: result of delete\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        path = join(data['path'], data['label'])\n        result = os.remove(path)\n        return JsonResponse({'result': result})\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef project_file_rename(request):\n    \"\"\"\n    rename file name\n    :param request: request object\n    :return: result of rename\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        pre = join(data['path'], data['pre'])\n        new = join(data['path'], data['new'])\n        os.rename(pre, new)\n        return JsonResponse({'result': '1'})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef job_list(request, client_id, project_name):\n    \"\"\"\n    get job list of project from one client\n    :param request: request object\n    :param client_id: client id\n    :param project_name: project name\n    :return: list of jobs\n    \"\"\"\n    if request.method == 'GET':\n        client = Client.objects.get(id=client_id)\n        scrapyd = get_scrapyd(client)\n        try:\n            result = scrapyd.list_jobs(project_name)\n            jobs = []\n            statuses = ['pending', 'running', 'finished']\n            for status in statuses:\n                for job in result.get(status):\n                    job['status'] = status\n                    jobs.append(job)\n            return JsonResponse(jobs)\n        except ConnectionError:\n            return JsonResponse({'message': 'Connect Error'}, status=500)\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef job_log(request, client_id, project_name, spider_name, job_id):\n    \"\"\"\n    get log of jog\n    :param request: request object\n    :param client_id: client id\n    :param project_name: project name\n    :param spider_name: spider name\n    :param job_id: job id\n    :return: log of job\n    \"\"\"\n    if request.method == 'GET':\n        client = Client.objects.get(id=client_id)\n        # get log url\n        url = log_url(client.ip, client.port, project_name, spider_name, job_id)\n        try:\n            # get last 1000 bytes of log\n            response = requests.get(url, timeout=5, headers={\n                'Range': 'bytes=-1000'\n            }, auth=(client.username, client.password) if client.auth else None)\n            # Get encoding\n            encoding = response.apparent_encoding\n            # log not found\n            if response.status_code == 404:\n                return JsonResponse({'message': 'Log Not Found'}, status=404)\n            # bytes to string\n            text = response.content.decode(encoding, errors='replace')\n            return HttpResponse(text)\n        except requests.ConnectionError:\n            return JsonResponse({'message': 'Load Log Error'}, status=500)\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef job_cancel(request, client_id, project_name, job_id):\n    \"\"\"\n    cancel a job\n    :param request: request object\n    :param client_id: client id\n    :param project_name: project name\n    :param job_id: job id\n    :return: json of cancel\n    \"\"\"\n    if request.method == 'GET':\n        client = Client.objects.get(id=client_id)\n        try:\n            scrapyd = get_scrapyd(client)\n            result = scrapyd.cancel(project_name, job_id)\n            return JsonResponse(result)\n        except ConnectionError:\n            return JsonResponse({'message': 'Connect Error'})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef del_version(request, client_id, project, version):\n    if request.method == 'GET':\n        client = Client.objects.get(id=client_id)\n        try:\n            scrapyd = get_scrapyd(client)\n            result = scrapyd.delete_version(project=project, version=version)\n            return JsonResponse(result)\n        except ConnectionError:\n            return JsonResponse({'message': 'Connect Error'})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef del_project(request, client_id, project):\n    if request.method == 'GET':\n        client = Client.objects.get(id=client_id)\n        try:\n            scrapyd = get_scrapyd(client)\n            result = scrapyd.delete_project(project=project)\n            return JsonResponse(result)\n        except ConnectionError:\n            return JsonResponse({'message': 'Connect Error'})\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef monitor_db_list(request):\n    \"\"\"\n    get monitor db list\n    :param request: request object\n    :return: json of db list\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        url = data['url']\n        type = data['type']\n        if type == 'MongoDB':\n            client = pymongo.MongoClient(url)\n            dbs = client.list_database_names()\n            return JsonResponse(dbs)\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef monitor_collection_list(request):\n    \"\"\"\n    get monitor collection list\n    :param request: request object\n    :return: json of collection list\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        url = data['url']\n        db = data['db']\n        type = data['type']\n        if type == 'MongoDB':\n            client = pymongo.MongoClient(url)\n            db = client[db]\n            collections = db.collection_names()\n            return JsonResponse(collections)\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef monitor_create(request):\n    \"\"\"\n    create a monitor\n    :param request: request object\n    :return: json of create\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        data = data['form']\n        data['configuration'] = json.dumps(data['configuration'], ensure_ascii=False)\n        monitor = Monitor.objects.create(**data)\n        return JsonResponse(model_to_dict(monitor))\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef task_create(request):\n    \"\"\"\n    add task\n    :param request: request object\n    :return: Bool\n    \"\"\"\n    if request.method == 'POST':\n        data = json.loads(request.body)\n        task = Task.objects.create(clients=json.dumps(data.get('clients'), ensure_ascii=False),\n                                   project=data.get('project'),\n                                   name=data.get('name'),\n                                   spider=data.get('spider'),\n                                   trigger=data.get('trigger'),\n                                   configuration=json.dumps(data.get('configuration'), ensure_ascii=False),\n                                   modified=1)\n        return JsonResponse({'result': '1', 'data': model_to_dict(task)})\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef task_update(request, task_id):\n    \"\"\"\n    update task info\n    :param request: request object\n    :param task_id: task id\n    :return: json\n    \"\"\"\n    if request.method == 'POST':\n        task = Task.objects.filter(id=task_id)\n        data = json.loads(request.body)\n        data['clients'] = json.dumps(data.get('clients'), ensure_ascii=False)\n        data['configuration'] = json.dumps(data.get('configuration'), ensure_ascii=False)\n        data['modified'] = 1\n        task.update(**data)\n        return JsonResponse(model_to_dict(Task.objects.get(id=task_id)))\n\n\n@api_view(['POST'])\n@permission_classes([IsAuthenticated])\ndef task_remove(request, task_id):\n    \"\"\"\n    remove task by task_id\n    :param request:\n    :return:\n    \"\"\"\n    if request.method == 'POST':\n        try:\n            # delete job from DjangoJob\n            task = Task.objects.get(id=task_id)\n            clients = clients_of_task(task)\n            for client in clients:\n                job_id = get_job_id(client, task)\n                DjangoJob.objects.filter(name=job_id).delete()\n            # delete task\n            Task.objects.filter(id=task_id).delete()\n            return JsonResponse({'result': '1'})\n        except:\n            return JsonResponse({'result': '0'})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef task_info(request, task_id):\n    \"\"\"\n    get task info\n    :param request: request object\n    :param task_id: task id\n    :return: json\n    \"\"\"\n    if request.method == 'GET':\n        task = Task.objects.get(id=task_id)\n        data = model_to_dict(task)\n        data['clients'] = json.loads(data.get('clients'))\n        data['configuration'] = json.loads(data.get('configuration'))\n        return JsonResponse({'data': data})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef task_index(request):\n    \"\"\"\n    get all tasks\n    :param request:\n    :return:\n    \"\"\"\n    if request.method == 'GET':\n        tasks = Task.objects.values()\n        return JsonResponse({'result': '1', 'data': tasks})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef task_status(request, task_id):\n    \"\"\"\n    get task status info\n    :param request: request object\n    :param task_id: task id\n    :return:\n    \"\"\"\n    if request.method == 'GET':\n        result = []\n        task = Task.objects.get(id=task_id)\n        clients = clients_of_task(task)\n        for client in clients:\n            job_id = get_job_id(client, task)\n            jobs = DjangoJob.objects.filter(name=job_id)\n            logger.debug('jobs from djangojob %s', jobs)\n            # if job does not exist, for date mode exceed time\n            if not jobs: continue\n            job = DjangoJob.objects.get(name=job_id)\n            executions = serialize('json', DjangoJobExecution.objects.filter(job=job))\n            result.append({\n                'client': model_to_dict(client),\n                'next': job.next_run_time,\n                'executions': json.loads(executions)\n            })\n        return JsonResponse({'data': result})\n\n\n@api_view(['GET'])\n@permission_classes([IsAuthenticated])\ndef render_html(request):\n    \"\"\"\n    render html with url\n    :param request:\n    :return:\n    \"\"\"\n    if request.method == 'GET':\n        url = request.GET.get('url')\n        url = unquote(base64.b64decode(url).decode('utf-8'))\n        js = request.GET.get('js', 0)\n        script = request.GET.get('script')\n        try:\n            response = requests.get(url, timeout=5)\n            response.encoding = response.apparent_encoding\n            html = process_html(response.text)\n            return HttpResponse(html)\n        except Exception as e:\n            return JsonResponse({'message': e.args}, status=500)\n", "patch": "@@ -1,3 +1,4 @@\n+import re\n from pathlib import Path\n from urllib.parse import unquote\n import base64\n@@ -251,6 +252,8 @@ def project_configure(request, project_name):\n         configuration = json.dumps(data.get('configuration'), ensure_ascii=False)\n         project.update(**{'configuration': configuration})\n         \n+        # for safe protection\n+        project_name = re.sub('[\\!\\@\\#\\$\\;\\&\\*\\~\\\"\\'\\{\\}\\]\\[\\-\\+\\%\\^]+', '', project_name)\n         # execute generate cmd\n         cmd = ' '.join(['gerapy', 'generate', project_name])\n         p = Popen(cmd, shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE)\n@@ -634,17 +637,15 @@ def job_list(request, client_id, project_name):\n     if request.method == 'GET':\n         client = Client.objects.get(id=client_id)\n         scrapyd = get_scrapyd(client)\n-        try:\n-            result = scrapyd.list_jobs(project_name)\n-            jobs = []\n-            statuses = ['pending', 'running', 'finished']\n-            for status in statuses:\n-                for job in result.get(status):\n-                    job['status'] = status\n-                    jobs.append(job)\n-            return JsonResponse(jobs)\n-        except ConnectionError:\n-            return JsonResponse({'message': 'Connect Error'}, status=500)\n+        result = scrapyd.list_jobs(project_name)\n+        jobs = []\n+        statuses = ['pending', 'running', 'finished']\n+        for status in statuses:\n+            for job in result.get(status):\n+                job['status'] = status\n+                jobs.append(job)\n+        return JsonResponse(jobs)\n+    \n \n \n @api_view(['GET'])\n@@ -663,21 +664,18 @@ def job_log(request, client_id, project_name, spider_name, job_id):\n         client = Client.objects.get(id=client_id)\n         # get log url\n         url = log_url(client.ip, client.port, project_name, spider_name, job_id)\n-        try:\n-            # get last 1000 bytes of log\n-            response = requests.get(url, timeout=5, headers={\n-                'Range': 'bytes=-1000'\n-            }, auth=(client.username, client.password) if client.auth else None)\n-            # Get encoding\n-            encoding = response.apparent_encoding\n-            # log not found\n-            if response.status_code == 404:\n-                return JsonResponse({'message': 'Log Not Found'}, status=404)\n-            # bytes to string\n-            text = response.content.decode(encoding, errors='replace')\n-            return HttpResponse(text)\n-        except requests.ConnectionError:\n-            return JsonResponse({'message': 'Load Log Error'}, status=500)\n+        # get last 1000 bytes of log\n+        response = requests.get(url, timeout=5, headers={\n+            'Range': 'bytes=-1000'\n+        }, auth=(client.username, client.password) if client.auth else None)\n+        # Get encoding\n+        encoding = response.apparent_encoding\n+        # log not found\n+        if response.status_code == 404:\n+            return JsonResponse({'message': 'Log Not Found'}, status=404)\n+        # bytes to string\n+        text = response.content.decode(encoding, errors='replace')\n+        return HttpResponse(text)\n \n \n @api_view(['GET'])\n@@ -693,38 +691,29 @@ def job_cancel(request, client_id, project_name, job_id):\n     \"\"\"\n     if request.method == 'GET':\n         client = Client.objects.get(id=client_id)\n-        try:\n-            scrapyd = get_scrapyd(client)\n-            result = scrapyd.cancel(project_name, job_id)\n-            return JsonResponse(result)\n-        except ConnectionError:\n-            return JsonResponse({'message': 'Connect Error'})\n+        scrapyd = get_scrapyd(client)\n+        result = scrapyd.cancel(project_name, job_id)\n+        return JsonResponse(result)\n \n \n @api_view(['GET'])\n @permission_classes([IsAuthenticated])\n def del_version(request, client_id, project, version):\n     if request.method == 'GET':\n         client = Client.objects.get(id=client_id)\n-        try:\n-            scrapyd = get_scrapyd(client)\n-            result = scrapyd.delete_version(project=project, version=version)\n-            return JsonResponse(result)\n-        except ConnectionError:\n-            return JsonResponse({'message': 'Connect Error'})\n+        scrapyd = get_scrapyd(client)\n+        result = scrapyd.delete_version(project=project, version=version)\n+        return JsonResponse(result)\n \n \n @api_view(['GET'])\n @permission_classes([IsAuthenticated])\n def del_project(request, client_id, project):\n     if request.method == 'GET':\n         client = Client.objects.get(id=client_id)\n-        try:\n-            scrapyd = get_scrapyd(client)\n-            result = scrapyd.delete_project(project=project)\n-            return JsonResponse(result)\n-        except ConnectionError:\n-            return JsonResponse({'message': 'Connect Error'})\n+        scrapyd = get_scrapyd(client)\n+        result = scrapyd.delete_project(project=project)\n+        return JsonResponse(result)\n \n \n @api_view(['POST'])\n@@ -829,18 +818,16 @@ def task_remove(request, task_id):\n     :return:\n     \"\"\"\n     if request.method == 'POST':\n-        try:\n-            # delete job from DjangoJob\n-            task = Task.objects.get(id=task_id)\n-            clients = clients_of_task(task)\n-            for client in clients:\n-                job_id = get_job_id(client, task)\n-                DjangoJob.objects.filter(name=job_id).delete()\n-            # delete task\n-            Task.objects.filter(id=task_id).delete()\n-            return JsonResponse({'result': '1'})\n-        except:\n-            return JsonResponse({'result': '0'})\n+        # delete job from DjangoJob\n+        task = Task.objects.get(id=task_id)\n+        clients = clients_of_task(task)\n+        for client in clients:\n+            job_id = get_job_id(client, task)\n+            DjangoJob.objects.filter(name=job_id).delete()\n+        # delete task\n+        Task.objects.filter(id=task_id).delete()\n+        return JsonResponse({'result': '1'})\n+    \n \n \n @api_view(['GET'])\n@@ -915,10 +902,7 @@ def render_html(request):\n         url = unquote(base64.b64decode(url).decode('utf-8'))\n         js = request.GET.get('js', 0)\n         script = request.GET.get('script')\n-        try:\n-            response = requests.get(url, timeout=5)\n-            response.encoding = response.apparent_encoding\n-            html = process_html(response.text)\n-            return HttpResponse(html)\n-        except Exception as e:\n-            return JsonResponse({'message': e.args}, status=500)\n+        response = requests.get(url, timeout=5)\n+        response.encoding = response.apparent_encoding\n+        html = process_html(response.text)\n+        return HttpResponse(html)", "file_path": "files/2020_7/11", "file_language": "py", "file_name": "gerapy/server/core/views.py", "outdated_file_modify": 1, "outdated_file_before": 0, "outdated_file_after": 0, "llm_check": 1, "static_check": 1, "static": {"rats": [false, []], "semgrep": [true, ["       python.django.security.audit.xss.direct-use-of-httpresponse.direct-use-of-httpresponse         \n          Detected data rendered directly to the end user via 'HttpResponse' or a similar object. This\n          bypasses Django's built-in cross-site scripting (XSS) defenses and could result in an XSS   \n          vulnerability. Use Django's template engine to safely render HTML.                          \n          Details: https://sg.run/EknN                                                                \n          922\u2506 return HttpResponse(html)", "       python.django.security.injection.ssrf.ssrf-injection-requests.ssrf-injection-requests          \n          Data from request object is passed to a new server-side request. This could lead to a       \n          server-side request forgery (SSRF). To mitigate, ensure that schemes and hosts are validated\n          against an allowlist, do not forward the response to the user, and ensure proper            \n          authentication and transport-layer security in the proxied request. See                     \n          https://owasp.org/www-community/attacks/Server_Side_Request_Forgery to learn more about SSRF\n          vulnerabilities.                                                                            \n          Details: https://sg.run/YvY4                                                                \n\n          914\u2506 url = request.GET.get('url')\n          915\u2506 url = unquote(base64.b64decode(url).decode('utf-8'))\n          916\u2506 js = request.GET.get('js', 0)\n          917\u2506 script = request.GET.get('script')\n          918\u2506 try:\n          919\u2506     response = requests.get(url, timeout=5)\n          920\u2506     response.encoding = response.apparent_encoding\n          921\u2506     html = process_html(response.text)\n          922\u2506     return HttpResponse(html)\n          923\u2506 except Exception as e:\n          924\u2506     return JsonResponse({'message': e.args}, status=500)", "       python.django.security.audit.xss.direct-use-of-httpresponse.direct-use-of-httpresponse         \n          Detected data rendered directly to the end user via 'HttpResponse' or a similar object. This\n          bypasses Django's built-in cross-site scripting (XSS) defenses and could result in an XSS   \n          vulnerability. Use Django's template engine to safely render HTML.                          \n          Details: https://sg.run/EknN                                                                \n\n          678\u2506 return HttpResponse(text)", "       python.lang.security.audit.subprocess-shell-true.subprocess-shell-true                         \n          Found 'subprocess' function 'Popen' with 'shell=True'. This is dangerous because this call  \n          will spawn the command using a shell process. Doing so propagates current shell settings and\n          variables, which makes it much easier for a malicious actor to execute commands. Use        \n          'shell=False' instead.                                                                      \n          Details: https://sg.run/J92w                                                                \n\n           \u25b6\u25b6\u2506 Autofix \u25b6 Popen(cmd, shell=False, stdin=PIPE, stdout=PIPE, stderr=PIPE)\n          256\u2506 p = Popen(cmd, shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE)"]]}, "target": 1, "function_before": [], "function_after": []}, {"raw_url": "https://github.com/Gerapy/Gerapy/raw/e8446605eb2424717418eae199ec7aad573da2d2/requirements.txt", "code": "apscheduler==3.5.1\ncryptography==2.8\ndjango==1.11.29\ndjango-cors-headers==3.2.0\ndjango-apscheduler==0.3.0\nfurl==2.1.0\njinja2==2.10.1\nscrapy==1.5.0\nscrapy-redis==0.6.8\nscrapy-splash==0.7.2\npython-scrapyd-api==2.1.2\nredis==2.10.5\nrequests==2.20.0\npymongo==3.9.0\npymysql==0.7.10\npyquery==1.2.17\nbeautifulsoup4==4.7.0\ndjangorestframework==3.9.2\nwebsocket==0.2.1\npyppeteer==0.0.25\n", "code_before": "apscheduler==3.5.1\ncryptography==2.8\ndjango==1.11.29\ndjango-cors-headers==3.2.0\ndjango-apscheduler==0.3.0\nfurl==2.1.0\njinja2==2.10.1\nscrapy>=1.4.0\nscrapy-redis==0.6.8\nscrapy-splash==0.7.2\npython-scrapyd-api==2.1.2\nredis==2.10.5\nrequests>=2.20.0\npymongo==3.9.0\npymysql==0.7.10\npyquery==1.2.17\nbeautifulsoup4==4.7.0\ndjangorestframework==3.9.2\nwebsocket==0.2.1\npyppeteer==0.0.25\n", "patch": "@@ -5,12 +5,12 @@ django-cors-headers==3.2.0\n django-apscheduler==0.3.0\n furl==2.1.0\n jinja2==2.10.1\n-scrapy>=1.4.0\n+scrapy==1.5.0\n scrapy-redis==0.6.8\n scrapy-splash==0.7.2\n python-scrapyd-api==2.1.2\n redis==2.10.5\n-requests>=2.20.0\n+requests==2.20.0\n pymongo==3.9.0\n pymysql==0.7.10\n pyquery==1.2.17", "file_path": "files/2020_7/12", "file_language": "txt", "file_name": "requirements.txt", "outdated_file_modify": 1, "outdated_file_before": 0, "outdated_file_after": 0}], "outdated": 1, "cwe_descripiton": "", "cwe_consequence": "", "cwe_method": "", "cwe_solution": ""}
